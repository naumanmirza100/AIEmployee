{% extends 'base.html' %}
{% block title %}Marketing Agents - AI Marketing Assistant{% endblock %}
{% block content %}
<style>
    .agents-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .agents-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-color);
    }

    .agent-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        border-bottom: 2px solid var(--border-color);
    }

    .agent-tab {
        padding: 1rem 1.5rem;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-secondary);
        transition: all 0.3s ease;
    }

    .agent-tab:hover {
        color: var(--primary-color);
    }

    .agent-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }

    .agent-panel {
        display: none;
        background: var(--card-background);
        padding: 2rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }

    .agent-panel.active {
        display: block;
    }

    .agent-panel h3 {
        margin: 0 0 1rem 0;
        color: var(--text-primary);
    }

    .agent-panel p {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-family: inherit;
    }

    .form-group textarea {
        min-height: 150px;
        resize: vertical;
    }

    .result-box {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--background-color);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        display: none;
    }

    .result-box.show {
        display: block;
    }

    .result-box h4 {
        margin: 0 0 1rem 0;
        color: var(--text-primary);
    }

    .result-content {
        white-space: normal;
        word-wrap: break-word;
        color: var(--text-primary);
        line-height: 1.6;
    }

    .result-content h2 {
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: var(--primary-color);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5rem;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .result-content h2:first-child {
        margin-top: 0;
    }

    .result-content h3 {
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        font-size: 1.25rem;
        font-weight: 600;
    }

    .result-content h4 {
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
        font-size: 1.1rem;
        font-weight: 600;
    }

    .result-content ul,
    .result-content ol {
        margin: 1rem 0;
        padding-left: 2rem;
    }

    .result-content li {
        margin: 0.5rem 0;
    }

    .result-content table {
        width: 100%;
        margin: 1.5rem 0;
        border-collapse: collapse;
        font-size: 0.95rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .result-content table th,
    .result-content table td {
        border: 1px solid var(--border-color);
        padding: 0.875rem 1rem;
        text-align: left;
    }

    .result-content table th {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
        font-weight: 600;
        color: var(--text-primary);
        border-bottom: 2px solid var(--primary-color);
    }

    .result-content table tr:nth-child(even) {
        background-color: rgba(99, 102, 241, 0.02);
    }

    .result-content table tr:hover {
        background-color: rgba(99, 102, 241, 0.05);
        transition: background-color 0.2s ease;
    }

    .result-content hr {
        margin: 2rem 0;
        border: none;
        border-top: 2px solid var(--border-color);
    }

    .result-content strong {
        font-weight: 600;
        color: var(--text-primary);
    }

    .result-content p {
        margin: 1rem 0;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .loading.show {
        display: block;
    }

    .campaign-section {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }

    .campaign-section:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .section-header h5 {
        margin: 0;
        color: var(--text-primary);
        font-size: 1.2rem;
    }

    .section-icon {
        font-size: 1.5rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
    }

    .form-grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.25rem;
    }

    .form-grid-3 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.25rem;
    }

    .input-with-icon {
        position: relative;
    }

    .input-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    .input-with-icon input,
    .input-with-icon select {
        padding-left: 2.5rem;
    }

    .field-hint {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
        font-style: italic;
    }

    .required-field {
        color: #e74c3c;
        margin-left: 0.25rem;
    }

    .campaign-card {
        background: var(--card-background);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border-color);
    }

    .designed-campaign-actions {
        display: none;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
        border-radius: var(--radius-md);
        border: 2px solid rgba(34, 197, 94, 0.3);
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .action-btn {
        flex: 1;
        min-width: 150px;
        padding: 0.875rem;
        font-weight: 600;
        border-radius: var(--radius-md);
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .metric-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--background-color);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }
</style>

<div class="agents-container">
    <div class="agents-header">
        <h1>ğŸ¤– Marketing AI Agents</h1>
        <p style="color: var(--text-secondary);">
            Select and interact with different marketing agents. Each agent specializes in specific marketing tasks.
        </p>
        <!-- <a href="{% url 'marketing_dashboard' %}" class="btn btn-secondary" style="margin-top: 1rem;">
            â† Back to Dashboard
        </a> -->
    </div>

    <!-- Agent Tabs -->
    <div class="agent-tabs">
        <button class="agent-tab active" onclick="switchTab('qa')" id="tab-qa">
            ğŸ“Š Knowledge + Analytics
        </button>
        <button class="agent-tab" onclick="switchTab('research')" id="tab-research">
            ğŸ” Market Research
        </button>
        <button class="agent-tab" onclick="switchTab('campaign')" id="tab-campaign">
            ğŸš€ Outreach & Campaign
        </button>
        <!-- <button class="agent-tab" onclick="switchTab('analytics')" id="tab-analytics" disabled>
            ğŸ“ˆ Analytics (Coming Soon)
        </button> -->
        <button class="agent-tab" onclick="switchTab('document')" id="tab-document">
            ğŸ“„ Document Authoring 
        </button>
        <button class="agent-tab" onclick="switchTab('notification')" id="tab-notification">
            ğŸ”” Notifications 
        </button>
    </div>

    <!-- Knowledge Q&A + Analytics Panel -->
    <div class="agent-panel active" id="panel-qa">
        <h3>ğŸ“Š Knowledge Q&A + Analytics Agent</h3>
        <p>
            Ask marketing questions and get data-driven answers. This foundation agent analyzes your campaigns,
            performance metrics, and provides intelligent insights.
        </p>

        <form id="qa-form" onsubmit="handleQA(event)">
            {% csrf_token %}
            <div class="form-group">
                <label for="qa-question">
                    <span>ğŸ’¬</span> Ask a Marketing Question <span class="required-field">*</span>
                </label>
                <div style="position: relative;">
                <textarea id="qa-question" name="question"
                        placeholder="Type your question here or select from suggested questions below..."
                        required
                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; resize: vertical; min-height: 120px;"
                    ></textarea>
            </div>
                <div class="field-hint">Type your question or select from suggested questions below</div>
            </div>

            <!-- Suggested Questions Dropdown -->
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="suggested-questions">
                    <span>ğŸ’¡</span> Suggested Questions
                </label>
                <select 
                    id="suggested-questions" 
                    onchange="fillQuestionFromSuggestion(this.value)"
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; background: var(--card-background); cursor: pointer;"
                >
                    <option value="">-- Select a suggested question --</option>
                    <optgroup label="ğŸ“Š Performance & Analytics">
                        <option value="What campaigns are performing best?">What campaigns are performing best?</option>
                        <option value="What is our overall ROI?">What is our overall ROI?</option>
                        <option value="Which marketing channels are most effective?">Which marketing channels are most effective?</option>
                        <option value="What is our conversion rate?">What is our conversion rate?</option>
                        <option value="How are our campaigns performing this month?">How are our campaigns performing this month?</option>
                        <option value="What is our customer acquisition cost (CAC)?">What is our customer acquisition cost (CAC)?</option>
                    </optgroup>
                    <optgroup label="ğŸ” Analysis & Insights">
                        <option value="Why are sales dropping?">Why are sales dropping?</option>
                        <option value="What should we focus on to improve performance?">What should we focus on to improve performance?</option>
                        <option value="What are the key trends in our marketing data?">What are the key trends in our marketing data?</option>
                        <option value="Which campaigns need optimization?">Which campaigns need optimization?</option>
                        <option value="What are our top performing campaigns and why?">What are our top performing campaigns and why?</option>
                    </optgroup>
                    <optgroup label="ğŸ“ˆ Goals & Targets">
                        <option value="How many leads have we generated this month?">How many leads have we generated this month?</option>
                        <option value="What is our lead conversion rate?">What is our lead conversion rate?</option>
                        <option value="Are we on track to meet our campaign goals?">Are we on track to meet our campaign goals?</option>
                    </optgroup>
                    <optgroup label="ğŸ’¼ Strategy & Recommendations">
                        <option value="What marketing strategies should we implement?">What marketing strategies should we implement?</option>
                        <option value="What opportunities are we missing?">What opportunities are we missing?</option>
                        <option value="How can we improve our campaign performance?">How can we improve our campaign performance?</option>
                        <option value="What are the best practices for our industry?">What are the best practices for our industry?</option>
                    </optgroup>
                </select>
                <div class="field-hint">Select a question to auto-fill the question field</div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600;">
                <span>ğŸ¤–</span> Ask AI
            </button>
        </form>

        <div class="loading" id="qa-loading">
            <p>ğŸ¤” Analyzing data and generating insights...</p>
        </div>

        <div class="result-box" id="qa-result">
            <h4>AI Response</h4>
            <div class="result-content" id="qa-result-content"></div>
        </div>
    </div>

    <!-- Market Research Panel -->
    <div class="agent-panel" id="panel-research">
        <h3>ğŸ” Market & Competitive Research Agent</h3>
        <p>
            Analyzes market trends, competitor activities, and customer behavior to identify opportunities,
            risks, and positioning strategies. Research findings are automatically available to the Q&A agent.
        </p>

        <form id="research-form" onsubmit="handleMarketResearch(event)">
            {% csrf_token %}
            <div class="form-group">
                <label for="research-type">Research Type</label>
                <select id="research-type" name="research_type" required>
                    <option value="market_trend">Market Trend Analysis</option>
                    <option value="competitor">Competitor Analysis</option>
                    <option value="customer_behavior">Customer Behavior Analysis</option>
                    <option value="opportunity">Opportunity Identification</option>
                    <option value="threat">Risk & Threat Analysis</option>
                </select>
            </div>

            <div class="form-group">
                <label for="research-topic">Research Topic</label>
                <textarea id="research-topic" name="topic"
                    placeholder="Examples:&#10;â€¢ AI marketing tools market trends&#10;â€¢ Competitor analysis for social media platforms&#10;â€¢ Customer buying behavior in e-commerce&#10;â€¢ Opportunities in mobile marketing&#10;â€¢ Risks in digital advertising"
                    required></textarea>
            </div>

            <!-- Additional Context Section -->
            <div class="campaign-section" style="margin-bottom: 1.5rem;">
                <div class="section-header">
                    <span class="section-icon">ğŸ“‹</span>
                    <h5>Additional Context (Optional)</h5>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">
                    Provide additional context to help the AI conduct more targeted research.
                </p>

                <div class="form-grid">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="research-competitors">
                            <span>ğŸ¢</span> Competitors
                        </label>
                        <input 
                            type="text" 
                            id="research-competitors" 
                            name="competitors"
                            placeholder="e.g., Competitor A, Competitor B, Competitor C"
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;"
                        />
                        <div class="field-hint">Comma-separated list of competitor names</div>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="research-industry">
                            <span>ğŸ’¼</span> Industry
                        </label>
                        <input 
                            type="text" 
                            id="research-industry" 
                            name="industry"
                            placeholder="e.g., Technology, Healthcare, Finance"
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;"
                        />
                        <div class="field-hint">Target industry or sector</div>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="research-region">
                            <span>ğŸŒ</span> Geographic Region
                        </label>
                        <input 
                            type="text" 
                            id="research-region" 
                            name="geographic_region"
                            placeholder="e.g., North America, Europe, Asia-Pacific"
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;"
                        />
                        <div class="field-hint">Geographic region or market</div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">ğŸ” Conduct Research</button>
        </form>

        <div class="loading" id="research-loading">
            <p>ğŸ” Analyzing market trends and conducting research...</p>
        </div>

        <div class="result-box" id="research-result">
            <h4>Research Findings</h4>
            <div class="result-content" id="research-result-content"></div>
        </div>
    </div>

    <!-- Outreach & Campaign Panel -->
    <div class="agent-panel" id="panel-campaign">
        <h3>ğŸ“§ Email Campaign Agent</h3>
        <p>
            Design, launch, and manage email marketing campaigns. Create targeted email campaigns with AI assistance.
        </p>

        <!-- View Campaign Dashboard Link -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--card-background); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h4 style="margin: 0 0 0.5rem 0;">ğŸ“Š Campaign Dashboard</h4>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                        View and manage all your email campaigns
                    </p>
                </div>
                <a href="{% url 'campaigns_list' %}" class="btn btn-primary" style="width: 40%; text-decoration: none;">
                    ğŸ“‹ View Campaign Dashboard â†’
                </a>
            </div>
        </div>

        <!-- Campaign Form Section -->
        <div class="campaign-card">
            <div class="section-header">
                <span class="section-icon">ğŸš€</span>
                <h5>Create Email Campaign</h5>
            </div>

            <!-- Action Selection -->
            <div class="form-group">
                <label for="campaign-action">
                    <span>âš¡</span> Select Action <span class="required-field">*</span>
                </label>
                <select id="campaign-action" name="action" onchange="updateCampaignForm()" required
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; background: var(--card-background);">
                    <option value="">-- Select Action First --</option>
                    <option value="design">ğŸ¨ Design Campaign</option>
                    <option value="create_multi_channel">ğŸ“§ Create Email Campaign</option>
                    <option value="launch">ğŸš€ Launch Campaign</option>
                    <!-- <option value="manage">ğŸ“Š Manage Campaign</option> -->
                    <option value="optimize">âš¡ Optimize Campaign</option>
                    <option value="schedule">ğŸ“… Schedule Campaign</option>
                </select>
                <div id="action-hint"
                    style="margin-top: 0.5rem; padding: 1rem; background: var(--background-color); border-radius: var(--radius-md); border-left: 4px solid var(--primary-color); display: none;">
                    <strong>ğŸ’¡ Hint:</strong> <span id="action-hint-text"></span>
                </div>
            </div>

            <!-- Designed Campaign Actions (shown after design) -->
            <div id="designed-campaign-actions" class="designed-campaign-actions">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem;">âœ…</span>
                    <h6 style="margin: 0; color: var(--text-primary); font-size: 1.1rem;">Campaign Design Ready!</h6>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.95rem;">
                    Your campaign has been designed. Use the buttons below to create, launch, or schedule it.
                </p>
                <div class="action-buttons">
                    <button type="button" class="btn btn-primary action-btn"
                        onclick="useDesignedCampaign('create_multi_channel')">
                        ğŸ“§ Create Campaign
                    </button>
                    <button type="button" class="btn btn-primary action-btn" onclick="useDesignedCampaign('launch')">
                        ğŸš€ Launch Campaign
                    </button>
                    <button type="button" class="btn btn-primary action-btn" onclick="useDesignedCampaign('schedule')">
                        ğŸ“… Schedule Campaign
                    </button>
                </div>
            </div>
            <div id="campaign-form-container" style="display: none;">
                <form id="campaign-form" onsubmit="handleCampaign(event)">
                    {% csrf_token %}

                    <!-- Campaign Selection (for launch, manage, optimize, schedule) -->
                    <div class="form-group" id="campaign-select-group" style="display: none;">
                    <label for="campaign-select">Select Campaign <span style="color: #e74c3c;">*</span></label>
                    <select id="campaign-select" name="campaign_select" onchange="loadCampaignData(this.value)" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;">
                        <option value="">-- Select Campaign --</option>
                        {% for campaign in campaigns %}
                        <option value="{{ campaign.id }}">{{ campaign.name }} ({{ campaign.get_status_display }})</option>
                        {% endfor %}
                    </select>
                    <small style="color: var(--text-secondary);">Select an existing campaign to manage, launch, optimize, or schedule. Form will auto-fill with campaign data.</small>
            </div>

                    <!-- Basic Information -->
                    <div class="campaign-section" style="margin-bottom: 1.5rem;">
                    <div class="section-header">
                        <span class="section-icon">ğŸ“‹</span>
                        <h5>Basic Information</h5>
                    </div>
                    <div class="form-grid">
                        <div class="form-group" id="campaign-name-group" style="margin-bottom: 0;">
                            <label for="campaign-name">
                                <span>ğŸ“</span> Campaign Name <span class="required-field">*</span>
                            </label>
                <input 
                    type="text" 
                    id="campaign-name" 
                    name="campaign_name" 
                    placeholder="e.g., Summer Sale 2024"
                                required
                                style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;"
                />
            </div>

                    </div>

                    <div class="form-group" id="campaign-description-group" style="margin-top: 1rem; margin-bottom: 0;">
                        <label for="campaign-description">
                            <span>ğŸ“„</span> Campaign Description
                        </label>
                <textarea 
                    id="campaign-description" 
                    name="campaign_description" 
                            placeholder="Describe your campaign goals, objectives, and key messaging..."
                    rows="3"
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; resize: vertical;"
                ></textarea>
                        <div class="field-hint">Provide a detailed description to help the AI create better campaign strategies</div>
                    </div>
            </div>

                    <!-- Goals Section -->
                    <div class="campaign-section" style="margin-bottom: 1.5rem;">
                    <div class="section-header">
                        <span class="section-icon">ğŸ¯</span>
                        <h5>Campaign Goals & Metrics</h5>
            </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">
                        Set your campaign targets to help the AI create optimized strategies and track performance.
                    </p>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h6 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1rem; font-weight: 600;">ğŸ“Š Primary Goals</h6>
                        <div class="form-grid">
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="target-leads">
                                    <span>ğŸ‘¥</span> Target Qualified Leads
                    </label>
                                <input 
                                    type="number" 
                                    id="target-leads" 
                                    name="target_leads" 
                                    placeholder="1000"
                                    min="0"
                                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;"
                                />
                                <div class="field-hint">Target number of leads that show interest/qualify (not total uploaded leads)</div>
            </div>

                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="target-conversions">
                                    <span>âœ…</span> Target Conversions
                                </label>
                <input 
                    type="number" 
                                    id="target-conversions" 
                                    name="target_conversions" 
                                    placeholder="500"
                    min="0"
                                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;"
                />
                                <div class="field-hint">Number of desired conversions</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Leads Upload Section (only for create_multi_channel action) -->
                    <div class="campaign-section" id="leads-upload-section" style="margin-bottom: 1.5rem; display: none;">
                        <div class="section-header">
                            <span class="section-icon">ğŸ“‹</span>
                            <h5>Upload Leads (Optional)</h5>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">
                            Upload a CSV or Excel file containing your leads. You can also add leads later from the campaign dashboard.
                        </p>
                        <div class="form-group">
                            <label for="leads-file-upload">
                                <span>ğŸ“„</span> Leads File (CSV, XLS, XLSX)
                            </label>
                            <input 
                                type="file" 
                                id="leads-file-upload" 
                                name="leads_file" 
                                accept=".csv,.xls,.xlsx"
                                style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;"
                            />
                            <div class="field-hint">
                                Supported formats: CSV, Excel (.xls, .xlsx). Required columns: Email (required), First Name, Last Name, Phone, Company, Job Title.
                                <br><strong>Note:</strong> Target Leads above refers to qualified/interested leads, not the total number of leads uploaded.
                            </div>
                        </div>
                    </div>
            </div>

                    <!-- Target Audience Section -->
                    <div class="campaign-section" style="margin-bottom: 1.5rem;">
                        <div class="section-header">
                            <span class="section-icon">ğŸ‘¥</span>
                            <h5>Target Audience</h5>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">
                            Define your ideal customer profile to help the AI create more targeted and effective
                            campaigns.
                        </p>

                        <div style="margin-bottom: 1.5rem;">
                            <h6
                                style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1rem; font-weight: 600;">
                                ğŸ‘¤ Demographics</h6>
                            <div class="form-grid">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="age-range">
                                        <span>ğŸ‚</span> Age Range
                                    </label>
                                    <input type="text" id="age-range" name="age_range" placeholder="e.g., 25-45"
                                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;" />
                                    <div class="field-hint">Target age range</div>
                                </div>

                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="location">
                                        <span>ğŸŒ</span> Location
                                    </label>
                                    <input type="text" id="location" name="location"
                                        placeholder="e.g., North America, Europe"
                                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;" />
                                    <div class="field-hint">Geographic region or country</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h6
                                style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1rem; font-weight: 600;">
                                ğŸ’¼ Professional Profile</h6>
                            <div class="form-grid">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="industry">
                                        <span>ğŸ¢</span> Industry
                                    </label>
                                    <input type="text" id="industry" name="industry"
                                        placeholder="e.g., Technology, Healthcare, Finance"
                                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;" />
                                    <div class="field-hint">Target industry sectors</div>
                                </div>

                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="company-size">
                                        <span>ğŸ“</span> Company Size
                                    </label>
                                    <select id="company-size" name="company_size"
                                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; background: var(--card-background);">
                                        <option value="">Any</option>
                                        <option value="1-10">1-10 employees</option>
                                        <option value="11-50">11-50 employees</option>
                                        <option value="51-200">51-200 employees</option>
                                        <option value="201-1000">201-1000 employees</option>
                                        <option value="1001-5000">1001-5000 employees</option>
                                        <option value="5000+">5000+ employees</option>
                                    </select>
                                    <div class="field-hint">Target company size</div>
                                </div>

                            </div>
                        </div>

                        <div>
                            <h6
                                style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1rem; font-weight: 600;">
                                ğŸ¯ Interests & Preferences</h6>
                            <div class="form-grid-2">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="interests">
                                        <span>â¤ï¸</span> Interests
                                    </label>
                                    <input type="text" id="interests" name="interests"
                                        placeholder="e.g., technology, business, marketing"
                                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;" />
                                    <div class="field-hint">Comma-separated interests</div>
                                </div>

                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="language">
                                        <span>ğŸ—£ï¸</span> Language
                                    </label>
                                    <input type="text" id="language" name="language"
                                        placeholder="e.g., English, Spanish, French"
                                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;" />
                                    <div class="field-hint">Preferred language</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dates Section -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group" id="campaign-start-date-group" style="display: none; margin-bottom: 0;">
                            <label for="campaign-start-date">Start Date</label>
                            <input type="date" id="campaign-start-date" name="campaign_start_date"
                                style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;" />
                        </div>

                        <div class="form-group" id="campaign-end-date-group" style="display: none; margin-bottom: 0;">
                            <label for="campaign-end-date">End Date</label>
                            <input type="date" id="campaign-end-date" name="campaign_end_date"
                                style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;" />
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="campaign-submit-btn"
                        style="width: 100%; padding: 1.25rem; font-size: 1.1rem; font-weight: 600; border-radius: var(--radius-md); background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); border: none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transition: all 0.3s ease; cursor: pointer;">
                        <span>ğŸš€</span> Execute Action
                    </button>
                    <style>
                        #campaign-submit-btn:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
                        }
                    </style>
                </form>
            </div>

            <div class="loading" id="campaign-loading">
                <p>ğŸš€ Processing campaign action...</p>
            </div>

            <div class="result-box" id="campaign-result">
                <h4>Campaign Result</h4>
                <div class="result-content" id="campaign-result-content"></div>
            </div>
        </div>
    </div>

    <div class="agent-panel" id="panel-analytics">
        <h3>ğŸ“ˆ Analytics & Dashboard Agent</h3>
        <p style="color: var(--text-secondary);">
            This agent will track campaign performance and provide real-time dashboards.
            Coming soon in Phase 3!
        </p>
    </div>

    <!-- Document Authoring Panel -->
    <div class="agent-panel" id="panel-document">
        <h3>ğŸ“„ Document Authoring Agent</h3>
        <p>
            Creates structured marketing documents such as strategies, proposals, reports, and campaign briefs automatically.
        </p>

        <!-- View Saved Documents Link -->
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--card-background); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h4 style="margin: 0 0 0.5rem 0;">ğŸ“š Saved Documents</h4>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                        View and manage all your saved marketing documents
                    </p>
                </div>
                <a href="{% url 'documents_list' %}" class="btn btn-primary" style="width: 40%; text-decoration: none;">
                    ğŸ“‹ View All Documents â†’
                </a>
            </div>
    </div>

        <!-- Document Form Section -->
        <div class="campaign-card">
            <div class="section-header">
                <span class="section-icon">ğŸ“</span>
                <h5>Create Marketing Document</h5>
            </div>

            <!-- Action Selection -->
            <div class="form-group">
                <label for="document-action">
                    <span>âš¡</span> Select Action <span class="required-field">*</span>
                </label>
                <select id="document-action" name="action" onchange="updateDocumentForm()" required
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; background: var(--card-background);">
                    <option value="">-- Select Action First --</option>
                    <option value="create">ğŸ“„ Create & Save Document</option>
                    <option value="generate">ğŸ‘ï¸ Generate Preview (No Save)</option>
                </select>
            </div>

            <div id="document-form-container" style="display: none;">
                <form id="document-form" onsubmit="handleDocument(event)">
                    {% csrf_token %}

                    <!-- Document Type -->
                    <div class="form-group">
                        <label for="document-type">
                            <span>ğŸ“‹</span> Document Type <span class="required-field">*</span>
                        </label>
                        <select id="document-type" name="document_type" required
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;"
                            onchange="updateDocumentCampaignRequirement()">
                            <option value="">-- Select Document Type --</option>
                            <option value="strategy">ğŸ“Š Marketing Strategy</option>
                            <option value="proposal">ğŸ“ Campaign Proposal</option>
                            <option value="report">ğŸ“ˆ Performance Report</option>
                            <!-- <option value="presentation">ğŸ“½ï¸ Presentation</option> -->
                            <option value="brief">ğŸ“‹ Campaign Brief</option>
                        </select>
                        <div class="field-hint">Choose the type of document you want to create</div>
                    </div>

                    <!-- Campaign Selection -->
                    <div class="form-group" id="document-campaign-group">
                        <label for="document-campaign-select">
                            <span>ğŸ¯</span> Associate with Campaign <span class="required-field" id="document-campaign-required" style="display: none;">*</span>
                        </label>
                        <select id="document-campaign-select" name="campaign_id"
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;">
                            <option value="">-- No Campaign (Standalone Document) --</option>
                            {% for campaign in campaigns %}
                            <option value="{{ campaign.id }}">{{ campaign.name }} ({{ campaign.get_status_display }})</option>
                            {% endfor %}
                        </select>
                        <div class="field-hint" id="document-campaign-hint">Optionally link this document to a campaign for context</div>
                    </div>

                    <!-- Document Title -->
                    <div class="form-group">
                        <label for="document-title">
                            <span>ğŸ“</span> Document Title <span class="required-field">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="document-title" 
                            name="title" 
                            placeholder="e.g., Q1 2024 Marketing Strategy"
                            required
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;"
                        />
                    </div>

                    <!-- Document Requirements -->
                    <div class="form-group">
                        <label for="document-requirements">
                            <span>ğŸ“‹</span> Document Requirements / Objectives
                        </label>
                        <textarea 
                            id="document-requirements" 
                            name="requirements" 
                            placeholder="Describe what you want in this document. For example: 'Focus on digital marketing channels, target B2B audience, include ROI projections...'"
                            rows="4"
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; resize: vertical;"
                        ></textarea>
                        <div class="field-hint">Provide detailed requirements to help the AI create a better document</div>
                    </div>

                    <!-- Additional Context -->
                    <div class="form-group">
                        <label for="document-context">
                            <span>ğŸ’¡</span> Additional Context / Key Points (Optional)
                        </label>
                        <textarea 
                            id="document-context" 
                            name="key_points" 
                            placeholder="Any additional information, data points, or context that should be included in the document..."
                            rows="3"
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; resize: vertical;"
                        ></textarea>
                        <div class="field-hint">Optional: Add any specific data, insights, or context</div>
                    </div>

                    <!-- Submit Button -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem;">
                            <span id="document-submit-text">ğŸš€ Create Document</span>
                            <span id="document-loading" style="display: none;">â³ Generating...</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results Section -->
            <div id="document-results" style="display: none; margin-top: 2rem;">
                <div class="section-header">
                    <span class="section-icon">âœ…</span>
                    <h5>Document Generated</h5>
                </div>
                <div id="document-results-content" style="background: var(--background-color); padding: 1.5rem; border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                    <!-- Results will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Proactive Notification Panel -->
    <div class="agent-panel" id="panel-notification">
        <h3>ğŸ”” Proactive Notification Agent</h3>
        <p>
            Monitors campaign performance continuously and alerts you about anomalies, opportunities, or required actions.
        </p>

        <!-- Monitoring Actions -->
        <div class="campaign-card" style="margin-bottom: 1.5rem;">
            <div class="section-header">
                <span class="section-icon">ğŸ“Š</span>
                <h5>Monitor Campaigns</h5>
            </div>

            <div class="form-group">
                <label>
                    <span>ğŸ¯</span> Select Campaign (Optional)
                </label>
                <select id="notification-campaign-select" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;">
                    <option value="">-- Monitor All Campaigns --</option>
                    {% for campaign in campaigns %}
                    <option value="{{ campaign.id }}">{{ campaign.name }} ({{ campaign.get_status_display }})</option>
                    {% endfor %}
                </select>
                <div class="field-hint">Leave empty to monitor all active campaigns</div>
            </div>

            <button onclick="monitorCampaigns()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                ğŸ” Monitor Campaigns
            </button>
        </div>

        <!-- Recent Notifications (Unread) -->
        <div class="campaign-card" style="margin-bottom: 1.5rem;">
            <div class="section-header">
                <span class="section-icon">ğŸ””</span>
                <h5>Recent Notifications</h5>
                <button onclick="loadNotifications()" style="border: 1px solid var(--border-color); padding:8px 5px; border-radius: 5px; width: 5%; margin-left: auto;">
                    ğŸ”„ 
                </button>
            </div>
            <div id="notifications-container" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    Click "Monitor Campaigns" to check for alerts
                </div>
            </div>
        </div>

        <!-- Notification History (Read) -->
        <div class="campaign-card">
            <div class="section-header">
                <span class="section-icon">ğŸ“œ</span>
                <h5>Notification History</h5>
                <button onclick="loadNotificationHistory()"  style="border: 1px solid var(--border-color); padding:8px 5px; border-radius: 5px; width: 5%; margin-left: auto;">
                    ğŸ”„ 
                </button>
            </div>
            <div id="notification-history-container" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    No history yet. Read notifications will appear here.
                </div>
            </div>
        </div>
    </div>

    <!-- Proactive Notification Panel -->
    <div class="agent-panel" id="panel-notification">
        <h3>ğŸ”” Proactive Notification Agent</h3>
        <p>
            Monitors campaign performance continuously and alerts you about anomalies, opportunities, or required actions.
        </p>

        <!-- Notifications Display -->
        <div class="campaign-card" style="margin-bottom: 1.5rem;">
            <div class="section-header">
                <span class="section-icon">ğŸ””</span>
                <h5>Your Notifications</h5>
                <button onclick="loadNotifications()" class="btn btn-secondary" style="width: 40%; margin-left: auto;">
                    ğŸ”„ Refresh
                </button>
            </div>
            <div id="notifications-container" style="max-height: 400px; overflow-y: auto;">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    Click "Monitor Campaigns" to check for alerts
                </div>
            </div>
        </div>

        <!-- Monitoring Actions -->
        <div class="campaign-card">
            <div class="section-header">
                <span class="section-icon">ğŸ“Š</span>
                <h5>Monitor Campaigns</h5>
            </div>

            <div class="form-group">
                <label>
                    <span>ğŸ¯</span> Select Campaign (Optional)
                </label>
                <select id="notification-campaign-select" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem;">
                    <option value="">-- Monitor All Campaigns --</option>
                    {% for campaign in campaigns %}
                    <option value="{{ campaign.id }}">{{ campaign.name }} ({{ campaign.get_status_display }})</option>
                    {% endfor %}
                </select>
                <div class="field-hint">Leave empty to monitor all active campaigns</div>
            </div>

            <button onclick="monitorCampaigns()" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                ğŸ” Monitor Campaigns
            </button>
        </div>
    </div>
</div>

<script>
    // Simple markdown to HTML converter for research results
    function markdownToHtml(markdown) {
        if (!markdown) return '';

        let html = markdown;

        // First pass: Convert markdown tables (process before splitting lines)
        const tableRegex = /(\|[^\n]+\|\n)((?:\|:?-+:?\|)+\n)((?:\|[^\n]+\|\n?)+)/g;
        html = html.replace(tableRegex, (match, headerRow, separatorRow, dataRows) => {
            const headers = headerRow.trim().split('|').map(c => c.trim()).filter(c => c);
            const rows = dataRows.trim().split('\n').map(row =>
                row.trim().split('|').map(c => c.trim()).filter(c => c)
            ).filter(row => row.length > 0);

            let tableHtml = '<table><thead><tr>';
            headers.forEach(h => tableHtml += `<th>${h}</th>`);
            tableHtml += '</tr></thead><tbody>';
            rows.forEach(row => {
                tableHtml += '<tr>';
                row.forEach(cell => tableHtml += `<td>${cell}</td>`);
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            return tableHtml;
        });

        // Split into lines for processing
        const lines = html.split('\n');
        const output = [];
        let inList = false;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();

            // Check for horizontal rules
            if (line.match(/^---+$/)) {
                if (inList) {
                    output.push('</ul>');
                    inList = false;
                }
                output.push('<hr>');
                continue;
            }

            // Check if it's a table (already converted)
            if (line.includes('<table>')) {
                if (inList) {
                    output.push('</ul>');
                    inList = false;
                }
                // Extract the full table HTML (might span multiple lines)
                let tableHtml = line;
                let j = i + 1;
                while (j < lines.length && !lines[j].includes('</table>')) {
                    tableHtml += '\n' + lines[j];
                    j++;
                }
                if (j < lines.length) {
                    tableHtml += '\n' + lines[j];
                }
                output.push(tableHtml);
                i = j;
                continue;
            }

            // Check for headers
            if (line.match(/^### /)) {
                if (inList) {
                    output.push('</ul>');
                    inList = false;
                }
                output.push(`<h3>${line.replace(/^### /, '')}</h3>`);
                continue;
            }

            if (line.match(/^## /)) {
                if (inList) {
                    output.push('</ul>');
                    inList = false;
                }
                output.push(`<h2>${line.replace(/^## /, '')}</h2>`);
                continue;
            }

            // Check for list items
            if (line.match(/^[\s]*(?:â€¢|\-|\*|\d+\.)\s+/)) {
                if (!inList) {
                    output.push('<ul>');
                    inList = true;
                }
                const content = line.replace(/^[\s]*(?:â€¢|\-|\*|\d+\.)\s+/, '');
                // Convert bold within list items
                const processedContent = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                output.push(`<li>${processedContent}</li>`);
                continue;
            } else if (inList && line === '') {
                output.push('</ul>');
                inList = false;
                continue;
            }

            // Regular paragraph
            if (line && !line.includes('<table')) {
                if (inList) {
                    output.push('</ul>');
                    inList = false;
                }
                // Convert bold
                let content = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                output.push(`<p>${content}</p>`);
            }
        }

        // Close any open list
        if (inList) {
            output.push('</ul>');
        }

        return output.join('\n');
    }

    function switchTab(tabName) {
        // Hide all panels and remove active class from tabs
        document.querySelectorAll('.agent-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.querySelectorAll('.agent-tab').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show selected panel and activate tab
        const panel = document.getElementById(`panel-${tabName}`);
        const tab = document.getElementById(`tab-${tabName}`);
        if (panel && tab && !tab.disabled) {
            panel.classList.add('active');
            tab.classList.add('active');
        }
    }

    // Fill question from suggested questions dropdown
    function fillQuestionFromSuggestion(value) {
        if (value) {
            const questionField = document.getElementById('qa-question');
            questionField.value = value;
            questionField.focus();
            // Reset dropdown to placeholder
            setTimeout(() => {
                document.getElementById('suggested-questions').value = '';
            }, 100);
        }
    }

    async function handleQA(event) {
        event.preventDefault();

        const question = document.getElementById('qa-question').value.trim();
        if (!question) {
            alert('Please enter a question or select from suggested questions.');
            return;
        }

        const loading = document.getElementById('qa-loading');
        const result = document.getElementById('qa-result');
        const resultContent = document.getElementById('qa-result-content');

        // Show loading
        loading.classList.add('show');
        result.classList.remove('show');

        try {
            const response = await fetch('{% url "test_marketing_qa" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    question: question
                })
            });

            const data = await response.json();

            if (data.success) {
                let output = '';

                // Format the answer with proper structure
                if (data.answer) {
                    // Check if answer is already in markdown format
                    if (data.answer.includes('##') || data.answer.includes('**') || data.answer.includes('|')) {
                        output = data.answer;
                    } else {
                        // Structure plain text answer
                        output = `## ğŸ“Š Analysis\n\n${data.answer}`;
                    }
                } else {
                    output = '## ğŸ“Š Analysis\n\nNo answer provided.';
                }

                // Add insights if available - format as a structured section
                if (data.insights && data.insights.length > 0) {
                    output += '\n\n---\n\n## ğŸ“ˆ Key Insights & Metrics\n\n';
                    
                    // Check if insights should be formatted as a table
                    const hasMultipleValues = data.insights.some(insight => insight.value && insight.value.includes(':'));
                    
                    if (hasMultipleValues || data.insights.length > 3) {
                        // Format as table for better readability
                        output += '| Metric | Value |\n';
                        output += '|--------|-------|\n';
                    data.insights.forEach(insight => {
                            const title = insight.title || 'N/A';
                            const value = insight.value || 'N/A';
                            output += `| ${title} | ${value} |\n`;
                        });
                    } else {
                        // Format as list
                        data.insights.forEach(insight => {
                            output += `â€¢ **${insight.title || 'N/A'}**: ${insight.value || 'N/A'}\n`;
                    });
                }
                }

                // Add recommendations section if available
                if (data.recommendations && data.recommendations.length > 0) {
                    output += '\n\n---\n\n## ğŸ’¡ Recommendations\n\n';
                    data.recommendations.forEach(rec => {
                        output += `â€¢ ${rec}\n`;
                    });
                }

                // Add summary section if available
                if (data.summary) {
                    output += '\n\n---\n\n## ğŸ“‹ Summary\n\n';
                    output += data.summary;
                }

                // Convert markdown to HTML and display
                resultContent.innerHTML = markdownToHtml(output);
                result.classList.add('show');
                
                // Scroll to result
                result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                resultContent.innerHTML = `<div style="color: #e74c3c; padding: 1rem; background: #fee; border-radius: var(--radius-md); border: 1px solid #e74c3c;">
                    <strong>âŒ Error:</strong> ${data.error || 'Unknown error occurred'}
                </div>`;
                result.classList.add('show');
            }
        } catch (error) {
            resultContent.innerHTML = `<div style="color: #e74c3c; padding: 1rem; background: #fee; border-radius: var(--radius-md); border: 1px solid #e74c3c;">
                <strong>âŒ Error:</strong> ${error.message}
            </div>`;
            result.classList.add('show');
        } finally {
            loading.classList.remove('show');
        }
    }

    async function handleMarketResearch(event) {
        event.preventDefault();

        const researchType = document.getElementById('research-type').value;
        const topic = document.getElementById('research-topic').value;
        const loading = document.getElementById('research-loading');
        const result = document.getElementById('research-result');
        const resultContent = document.getElementById('research-result-content');

        // Show loading
        loading.classList.add('show');
        result.classList.remove('show');

        // Build context object from individual input fields
        let context = {};
        
        // Get competitors (comma-separated, convert to array)
        const competitorsInput = document.getElementById('research-competitors').value.trim();
        if (competitorsInput) {
            context.competitors = competitorsInput.split(',').map(c => c.trim()).filter(c => c);
        }
        
        // Get industry
        const industryInput = document.getElementById('research-industry').value.trim();
        if (industryInput) {
            context.industry = industryInput;
        }
        
        // Get geographic region
        const regionInput = document.getElementById('research-region').value.trim();
        if (regionInput) {
            context.geographic_region = regionInput;
        }

        try {
            const response = await fetch('{% url "test_market_research" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    research_type: researchType,
                    topic: topic,
                    context: context
                })
            });

            const data = await response.json();

            if (data.success) {
                // Build output with proper formatting - use insights directly as it contains formatted markdown
                let output = '';

                if (data.insights) {
                    // The insights field now contains the full formatted response from AI
                    output = data.insights;
                } else {
                    // Fallback to structured output if insights not available
                    output = `## ğŸ“Š Research Findings\n\n`;
                    output += `**Research Type**: ${data.research_type}\n`;
                    output += `**Topic**: ${data.topic}\n\n`;

                    if (data.opportunities && data.opportunities.length > 0) {
                        output += `### ğŸ¯ Opportunities\n\n`;
                        data.opportunities.forEach(opp => {
                            output += `â€¢ ${opp}\n`;
                        });
                        output += `\n`;
                    }

                    if (data.risks && data.risks.length > 0) {
                        output += `### âš ï¸ Risks & Threats\n\n`;
                        data.risks.forEach(risk => {
                            output += `â€¢ ${risk}\n`;
                        });
                        output += `\n`;
                    }

                    if (data.recommendations && data.recommendations.length > 0) {
                        output += `### ğŸ’¼ Recommendations\n\n`;
                        data.recommendations.forEach(rec => {
                            output += `â€¢ ${rec}\n`;
                        });
                        output += `\n`;
                    }
                }

                if (data.research_id) {
                    output += `\n\n---\n\nâœ… **Research saved to database (ID: ${data.research_id})**. Available for Q&A agent.`;
                }

                // Convert markdown to HTML and display
                resultContent.innerHTML = markdownToHtml(output);
                result.classList.add('show');
            } else {
                resultContent.textContent = `Error: ${data.error || 'Unknown error occurred'}`;
                result.classList.add('show');
            }
        } catch (error) {
            resultContent.textContent = `Error: ${error.message}`;
            result.classList.add('show');
        } finally {
            loading.classList.remove('show');
        }
    }

    // Store designed campaign data
    let designedCampaignData = null;

    // Use designed campaign for other actions
    function useDesignedCampaign(action) {
        if (!designedCampaignData) {
            alert('No campaign design available. Please design a campaign first.');
            return;
        }

        // Set the action
        document.getElementById('campaign-action').value = action;
        updateCampaignForm();

        // Pre-fill form with designed campaign data
        if (designedCampaignData.name && document.getElementById('campaign-name')) {
            document.getElementById('campaign-name').value = designedCampaignData.name;
        }
        if (designedCampaignData.description && document.getElementById('campaign-description')) {
            document.getElementById('campaign-description').value = designedCampaignData.description;
        }
        if (designedCampaignData.target_leads && document.getElementById('target-leads')) {
            document.getElementById('target-leads').value = designedCampaignData.target_leads;
        }
        if (designedCampaignData.target_conversions && document.getElementById('target-conversions')) {
            document.getElementById('target-conversions').value = designedCampaignData.target_conversions;
        }
        if (designedCampaignData.age_range && document.getElementById('age-range')) {
            document.getElementById('age-range').value = designedCampaignData.age_range;
        }
        if (designedCampaignData.location && document.getElementById('location')) {
            document.getElementById('location').value = designedCampaignData.location;
        }
        if (designedCampaignData.interests && document.getElementById('interests')) {
            document.getElementById('interests').value = designedCampaignData.interests;
        }
        if (designedCampaignData.industry && document.getElementById('industry')) {
            document.getElementById('industry').value = designedCampaignData.industry;
        }
        if (designedCampaignData.company_size && document.getElementById('company-size')) {
            document.getElementById('company-size').value = designedCampaignData.company_size;
        }
        if (designedCampaignData.language && document.getElementById('language')) {
            document.getElementById('language').value = designedCampaignData.language;
        }

        // Scroll to form
        document.getElementById('campaign-form-container').scrollIntoView({ behavior: 'smooth' });
    }

    // Initialize form - hide it initially if no action selected
    document.addEventListener('DOMContentLoaded', () => {
        const actionSelect = document.getElementById('campaign-action');
        if (actionSelect && !actionSelect.value) {
            const campaignForm = document.getElementById('campaign-form-container');
            if (campaignForm) campaignForm.style.display = 'none';
        }
    });

    // Load campaign data and populate form
    async function loadCampaignData(campaignId) {
        console.log('Campaign ID:', campaignId);

        if (!campaignId) {
            // Clear form if no campaign selected
            clearCampaignForm();
            return;
        }

        try {
            // Construct URL for campaign details API
            // Build URL manually: /marketing/api/campaign/<id>/
            let campaignUrl = `/marketing/api/campaign/${campaignId}/`;

            console.log('Fetching campaign data from:', campaignUrl);
            // console.log('Campaign /ID:', campaignId);

            const response = await fetch(campaignUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'  // Include cookies for authentication
            });

            // Check if response is ok
            if (!response.ok) {
                // Try to get error message
                let errorText = '';
                try {
                    errorText = await response.text();
                    // Try to parse as JSON first
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.error || `HTTP ${response.status}`);
                    } catch {
                        // Not JSON, use text
                        console.error('HTTP Error Response:', response.status, errorText.substring(0, 200));
                        throw new Error(`HTTP ${response.status}: Server returned HTML instead of JSON. Check if URL is correct.`);
                    }
                } catch (e) {
                    if (e.message) throw e;
                    throw new Error(`HTTP ${response.status}: Failed to load campaign`);
                }
            }

            // Check content type
            const contentType = response.headers.get('content-type') || '';
            console.log('Content Type:', contentType);
            if (!contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Non-JSON response received. Content-Type:', contentType);
                console.error('Response preview:', text.substring(0, 300));
                throw new Error('Server returned non-JSON response. This usually means the URL is incorrect or there\'s a server error. Check browser console for details.');
            }

            const data = await response.json();
            console.log('Received campaign data:', data);

            if (data.success && data.campaign) {
                const campaign = data.campaign;
                console.log('Populating form with campaign:', campaign);

                // Helper function to safely set field values
                function setFieldValue(fieldId, value) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // Handle null/undefined values
                        const fieldValue = (value !== null && value !== undefined) ? value : '';
                        field.value = fieldValue;
                        console.log(`Set ${fieldId} = "${fieldValue}"`);
                        return true;
                    } else {
                        console.warn(`Field not found: ${fieldId}`);
                        return false;
                    }
                }

                // Populate Basic Information fields
                setFieldValue('campaign-name', campaign.name);
                setFieldValue('campaign-description', campaign.description);

                // Populate Goals fields
                setFieldValue('target-leads', campaign.target_leads);
                setFieldValue('target-conversions', campaign.target_conversions);

                // Populate Target Audience fields
                setFieldValue('age-range', campaign.age_range);
                setFieldValue('location', campaign.location);
                setFieldValue('interests', campaign.interests);
                setFieldValue('industry', campaign.industry);
                setFieldValue('company-size', campaign.company_size);
                setFieldValue('language', campaign.language);

                // Populate Date fields
                setFieldValue('campaign-start-date', campaign.start_date);
                setFieldValue('campaign-end-date', campaign.end_date);

                // Show form fields for viewing/editing
                const action = document.getElementById('campaign-action').value;
                if (action === 'launch' || action === 'manage' || action === 'optimize' || action === 'schedule') {
                    // Show the basic form fields
                    const campaignNameGroup = document.getElementById('campaign-name-group');
                    const campaignDescriptionGroup = document.getElementById('campaign-description-group');
                    const campaignStartDateGroup = document.getElementById('campaign-start-date-group');
                    const campaignEndDateGroup = document.getElementById('campaign-end-date-group');

                    if (campaignNameGroup) campaignNameGroup.style.display = 'block';
                    if (campaignDescriptionGroup) campaignDescriptionGroup.style.display = 'block';
                    if (campaignStartDateGroup) campaignStartDateGroup.style.display = 'block';
                    if (campaignEndDateGroup) campaignEndDateGroup.style.display = 'block';
                }

                console.log('âœ… Campaign data successfully loaded into form fields');
            } else {
                alert('Failed to load campaign data: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error loading campaign data:', error);
            alert('Error loading campaign data: ' + error.message);
        }
    }

    // Clear campaign form
    function clearCampaignForm() {
        const fields = [
            'campaign-name', 'campaign-description',
            'target-leads', 'target-conversions',
            'age-range', 'location', 'interests', 'industry', 'company-size', 'language',
            'campaign-start-date', 'campaign-end-date'
        ];

        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.value = '';
        });
    }

    // Campaign Agent Functions
    function updateCampaignForm() {
        const action = document.getElementById('campaign-action').value;
        const campaignForm = document.getElementById('campaign-form-container');
        const actionHint = document.getElementById('action-hint');
        const hintText = document.getElementById('action-hint-text');
        const campaignSelectGroup = document.getElementById('campaign-select-group');
        const campaignNameGroup = document.getElementById('campaign-name-group');
        const campaignDescriptionGroup = document.getElementById('campaign-description-group');
        const campaignStartDateGroup = document.getElementById('campaign-start-date-group');
        const campaignEndDateGroup = document.getElementById('campaign-end-date-group');
        const submitBtn = document.getElementById('campaign-submit-btn');

        // Hide form if no action selected
        if (!action) {
            if (campaignForm) campaignForm.style.display = 'none';
            if (actionHint) actionHint.style.display = 'none';
            return;
        }

        // Show form
        if (campaignForm) campaignForm.style.display = 'block';
        if (actionHint) actionHint.style.display = 'block';

        // Set hints based on action
        const hints = {
            'design': 'Fill in the form below to design your campaign. After designing, you can use the buttons to create, launch, or schedule it.',
            'create_multi_channel': 'Fill in the campaign details below to create your email campaign.',
            'launch': 'Select an existing campaign from the dropdown below to launch it.',
            'manage': 'Select an existing campaign from the dropdown below to manage and view its performance.',
            'optimize': 'Select an existing campaign from the dropdown below to get optimization recommendations.',
            'schedule': 'Select an existing campaign and set dates below to schedule it.'
        };
        hintText.textContent = hints[action] || '';

        // Reset all groups
        campaignSelectGroup.style.display = 'none';
        // Note: campaign-name-group, campaign-description-group are commented out
        if (campaignNameGroup) campaignNameGroup.style.display = 'block';
        if (campaignDescriptionGroup) campaignDescriptionGroup.style.display = 'block';
        campaignStartDateGroup.style.display = 'none';
        campaignEndDateGroup.style.display = 'none';
        
        // Show/hide leads upload section (for create and launch actions)
        const leadsUploadSection = document.getElementById('leads-upload-section');
        if (leadsUploadSection) {
            leadsUploadSection.style.display = (action === 'create_multi_channel' || action === 'launch') ? 'block' : 'none';
        }

        // Update based on action
        if (action === 'design') {
            submitBtn.textContent = 'ğŸ¨ Design Campaign';
            campaignSelectGroup.style.display = 'none';
        } else if (action === 'create_multi_channel') {
            submitBtn.textContent = 'ğŸ“§ Create Email Campaign';
            campaignSelectGroup.style.display = 'none';
            campaignStartDateGroup.style.display = 'block';
            campaignEndDateGroup.style.display = 'block';
        } else if (action === 'launch' || action === 'manage' || action === 'optimize') {
            submitBtn.textContent = action.charAt(0).toUpperCase() + action.slice(1) + ' Campaign';
            campaignSelectGroup.style.display = 'block';
            // Keep form fields visible so they can be auto-filled and viewed (if they exist)
            if (campaignNameGroup) campaignNameGroup.style.display = 'block';
            if (campaignDescriptionGroup) campaignDescriptionGroup.style.display = 'block';
        } else if (action === 'schedule') {
            submitBtn.textContent = 'ğŸ“… Schedule Campaign';
            campaignSelectGroup.style.display = 'block';
            campaignStartDateGroup.style.display = 'block';
            campaignEndDateGroup.style.display = 'block';
            // Keep form fields visible so they can be auto-filled and viewed (if they exist)
            if (campaignNameGroup) campaignNameGroup.style.display = 'block';
            if (campaignDescriptionGroup) campaignDescriptionGroup.style.display = 'block';
        }
    }

    async function handleCampaign(event) {
        event.preventDefault();

        const action = document.getElementById('campaign-action').value;
        if (!action) {
            alert('Please select an action first.');
            return;
        }

        const loading = document.getElementById('campaign-loading');
        const result = document.getElementById('campaign-result');
        const resultContent = document.getElementById('campaign-result-content');

        // Show loading
        loading.classList.add('show');
        result.classList.remove('show');

        // Build campaign data
        const campaignData = {};
        const context = {};

        // Get campaign ID from select dropdown if needed
        let campaignId = null;
        const campaignSelect = document.getElementById('campaign-select');
        if (campaignSelect && campaignSelect.value) {
            campaignId = parseInt(campaignSelect.value);
        }

        // Get form values for new campaigns
        if (document.getElementById('campaign-name') && document.getElementById('campaign-name').value) {
            campaignData.name = document.getElementById('campaign-name').value;
        }
        if (document.getElementById('campaign-description') && document.getElementById('campaign-description').value) {
            campaignData.description = document.getElementById('campaign-description').value;
        }

        // Set campaign type to email only
        campaignData.campaign_type = 'email';
        campaignData.channels = ['email'];

        // Build goals from individual fields
        const goals = {};
        const getValue = (id) => {
            const el = document.getElementById(id);
            return el && el.value ? el.value : null;
        };
        const getNumberValue = (id) => {
            const val = getValue(id);
            return val ? parseFloat(val) : null;
        };
        const getIntValue = (id) => {
            const val = getValue(id);
            return val ? parseInt(val) : null;
        };

        // Primary Goals
        if (getValue('target-leads')) {
            const val = getIntValue('target-leads');
            goals.leads = val;
            campaignData.target_leads = val;
        }
        if (getValue('target-conversions')) {
            const val = getIntValue('target-conversions');
            goals.conversions = val;
            campaignData.target_conversions = val;
        }

        if (Object.keys(goals).length > 0) {
            campaignData.goals = goals;
        }

        // Build target audience from individual fields
        const targetAudience = {};

        // Demographics
        if (getValue('age-range')) {
            const val = getValue('age-range');
            targetAudience.age_range = val;
            campaignData.age_range = val;
        }
        if (getValue('location')) {
            const val = getValue('location');
            targetAudience.location = val;
            campaignData.location = val;
        }

        // Professional Profile
        if (getValue('industry')) {
            const val = getValue('industry');
            targetAudience.industry = val;
            campaignData.industry = val;
        }
        if (getValue('company-size')) {
            const val = getValue('company-size');
            targetAudience.company_size = val;
            campaignData.company_size = val;
        }

        // Interests & Preferences
        if (getValue('interests')) {
            const interestsList = getValue('interests').split(',').map(i => i.trim()).filter(i => i);
            targetAudience.interests = interestsList;
            campaignData.interests = getValue('interests');
        }
        if (getValue('language')) {
            const val = getValue('language');
            targetAudience.language = val;
            campaignData.language = val;
        }

        if (Object.keys(targetAudience).length > 0) {
            campaignData.target_audience = targetAudience;
        }

        // Get dates
        if (document.getElementById('campaign-start-date') && document.getElementById('campaign-start-date').value) {
            campaignData.start_date = document.getElementById('campaign-start-date').value;
        }
        if (document.getElementById('campaign-end-date') && document.getElementById('campaign-end-date').value) {
            campaignData.end_date = document.getElementById('campaign-end-date').value;
        }

        // Check if we have a file to upload (for create_multi_channel and launch actions)
        const leadsFileInput = document.getElementById('leads-file-upload');
        const leadsFile = leadsFileInput && leadsFileInput.files && leadsFileInput.files.length > 0 ? leadsFileInput.files[0] : null;
        
        let response;
        try {
            // If there's a file, use FormData instead of JSON
            if (leadsFile && action === 'create_multi_channel') {
                const formData = new FormData();
                formData.append('action', action);
                formData.append('campaign_data', JSON.stringify(campaignData));
                formData.append('file', leadsFile);
                
                if (campaignId) {
                    formData.append('campaign_id', campaignId.toString());
                }
                
                if (Object.keys(context).length > 0) {
                    formData.append('context', JSON.stringify(context));
                }
                
                response = await fetch('{% url "test_outreach_campaign" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: formData
                });
            } else {
                // No file, use JSON
                const requestBody = {
                    action: action
                };

                if (Object.keys(campaignData).length > 0) {
                    requestBody.campaign_data = campaignData;
                }

                if (campaignId) {
                    requestBody.campaign_id = campaignId;
                }

                if (Object.keys(context).length > 0) {
                    requestBody.context = context;
                }
                
                response = await fetch('{% url "test_outreach_campaign" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(requestBody)
                });
            }

            if (!response.ok) {
                const errorText = await response.text();
                try {
                    const errorJson = JSON.parse(errorText);
                    throw new Error(errorJson.error || `HTTP ${response.status}`);
                } catch {
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }
            }

            const data = await response.json();

            if (data.success) {
                let output = '';

                // Format output based on action
                if (action === 'design') {
                    // Store designed campaign data
                    designedCampaignData = {
                        name: document.getElementById('campaign-name')?.value || '',
                        description: document.getElementById('campaign-description')?.value || '',
                        // Store all form data
                        target_leads: document.getElementById('target-leads')?.value || '',
                        target_conversions: document.getElementById('target-conversions')?.value || '',
                        age_range: document.getElementById('age-range')?.value || '',
                        location: document.getElementById('location')?.value || '',
                        interests: document.getElementById('interests')?.value || '',
                        industry: document.getElementById('industry')?.value || '',
                        company_size: document.getElementById('company-size')?.value || '',
                        language: document.getElementById('language')?.value || ''
                    };

                    // Show action buttons
                    document.getElementById('designed-campaign-actions').style.display = 'block';

                    output = `## ğŸ¨ Campaign Design\n\n`;
                    if (data.campaign_design) {
                        const design = data.campaign_design;
                        if (design.raw_design) {
                            output += design.raw_design;
                        } else {
                            output += `**Campaign Name**: ${design.campaign_name || 'N/A'}\n\n`;
                            output += `**Description**: ${design.description || 'N/A'}\n\n`;
                            output += `**Channels**: ${(design.channels || []).join(', ')}\n\n`;
                        }
                    }

                    if (data.recommendations && data.recommendations.length > 0) {
                        output += `\n\n---\n\n## ğŸ’¡ Recommendations\n\n`;
                        data.recommendations.forEach(rec => {
                            output += `â€¢ ${rec}\n`;
                        });
                    }

                    output += `\n\n---\n\nâœ… **Campaign design is ready!** Use the buttons above to create, launch, or schedule this campaign.`;
                } else if (action === 'create_multi_channel') {
                    // Hide designed campaign actions after creating
                    document.getElementById('designed-campaign-actions').style.display = 'none';
                    output = `## âœ… Campaign Created Successfully\n\n`;
                    output += `**Campaign ID**: ${data.campaign_id}\n`;
                    output += `**Campaign Name**: ${data.campaign_name}\n`;
                    output += `**Status**: ${data.status}\n`;
                    output += `**Channels**: ${(data.channels || []).join(', ')}\n\n`;
                    if (data.leads_uploaded && data.leads_uploaded > 0) {
                        output += `**Leads Uploaded**: ${data.leads_uploaded} leads have been uploaded and associated with this campaign.\n\n`;
                    }
                    output += `\n${data.message || 'Campaign created successfully!'}\n`;
                    output += `\nğŸ’¡ **Note:** You can view and manage leads in the campaign dashboard.`;


                    if (data.campaign_design) {
                        output += `\n\n---\n\n## ğŸ¨ Campaign Design\n\n`;
                        if (data.campaign_design.raw_design) {
                            output += data.campaign_design.raw_design;
                        }
                    }
                } else if (action === 'launch') {
                    output = `## ğŸš€ Campaign Launched\n\n`;
                    output += `**Campaign**: ${data.campaign_name}\n`;
                    output += `**Status**: ${data.status}\n`;
                    output += `**Channels**: ${(data.channels || []).join(', ')}\n`;
                    if (data.start_date) {
                        output += `**Start Date**: ${data.start_date}\n`;
                    }
                    if (data.leads_uploaded && data.leads_uploaded > 0) {
                        output += `\n**Leads Uploaded**: ${data.leads_uploaded} leads have been uploaded and associated with this campaign.\n\n`;
                    }
                    output += `\n${data.message || 'Campaign launched successfully!'}\n`;
                    if (data.leads_uploaded && data.leads_uploaded > 0) {
                        output += `\nğŸ’¡ **Note:** You can view and manage leads in the campaign dashboard.`;
                    }

                    if (data.launch_plan) {
                        output += `\n\n---\n\n## ğŸ“‹ Launch Plan\n\n`;
                        if (data.launch_plan.full_plan) {
                            output += data.launch_plan.full_plan;
                        }
                        if (data.launch_plan.checklist && data.launch_plan.checklist.length > 0) {
                            output += `\n\n### âœ… Launch Checklist\n\n`;
                            data.launch_plan.checklist.forEach(item => {
                                output += `- ${item}\n`;
                            });
                        }
                    }
                } else if (action === 'manage') {
                    output = `## ğŸ“Š Campaign Management\n\n`;
                    output += `**Campaign**: ${data.campaign_name}\n`;
                    output += `**Status**: ${data.current_status}\n\n`;

                    if (data.performance) {
                        output += `### ğŸ“ˆ Performance Metrics\n\n`;
                        output += `- Impressions: ${(data.performance.total_impressions || 0).toLocaleString()}\n`;
                        output += `- Clicks: ${(data.performance.total_clicks || 0).toLocaleString()}\n`;
                        output += `- Conversions: ${(data.performance.total_conversions || 0).toLocaleString()}\n`;
                        output += `- CTR: ${(data.performance.ctr || 0).toFixed(2)}%\n`;
                        output += `- Conversion Rate: ${(data.performance.conversion_rate || 0).toFixed(2)}%\n`;
                        output += `- Spend: $${(data.performance.spend || 0).toLocaleString(2)}\n`;
                        output += `- Budget: $${(data.performance.budget || 0).toLocaleString(2)}\n\n`;
                    }

                    if (data.management_plan) {
                        if (data.management_plan.assessment) {
                            output += `### ğŸ’¼ Management Assessment\n\n`;
                            output += data.management_plan.assessment;
                            output += `\n\n`;
                        }
                    }

                    if (data.consistency_check) {
                        output += `### âœ… Messaging Consistency\n\n`;
                        output += `**Status**: ${data.consistency_check.is_consistent ? 'âœ… Consistent' : 'âš ï¸ Needs Review'}\n\n`;
                        if (data.consistency_check.assessment) {
                            output += data.consistency_check.assessment;
                            output += `\n\n`;
                        }
                    }

                    if (data.recommendations && data.recommendations.length > 0) {
                        output += `\n\n---\n\n## ğŸ’¡ Recommendations\n\n`;
                        data.recommendations.forEach(rec => {
                            output += `â€¢ ${rec}\n`;
                        });
                    }
                } else if (action === 'optimize') {
                    output = `## âš¡ Campaign Optimization\n\n`;
                    output += `**Campaign**: ${data.campaign_name}\n\n`;

                    if (data.current_performance) {
                        output += `### ğŸ“Š Current Performance\n\n`;
                        output += `- Impressions: ${(data.current_performance.total_impressions || 0).toLocaleString()}\n`;
                        output += `- Clicks: ${(data.current_performance.total_clicks || 0).toLocaleString()}\n`;
                        output += `- Conversions: ${(data.current_performance.total_conversions || 0).toLocaleString()}\n`;
                        output += `- CTR: ${(data.current_performance.ctr || 0).toFixed(2)}%\n`;
                        output += `- Conversion Rate: ${(data.current_performance.conversion_rate || 0).toFixed(2)}%\n\n`;
                    }

                    if (data.optimization_plan) {
                        if (data.optimization_plan.optimization_plan) {
                            output += `### ğŸ¯ Optimization Plan\n\n`;
                            output += data.optimization_plan.optimization_plan;
                            output += `\n\n`;
                        }
                    }

                    if (data.priority_actions && data.priority_actions.length > 0) {
                        output += `\n\n---\n\n## ğŸ”¥ Priority Actions\n\n`;
                        data.priority_actions.forEach(action => {
                            output += `â€¢ ${action}\n`;
                        });
                    }

                    if (data.recommendations && data.recommendations.length > 0) {
                        output += `\n\n---\n\n## ğŸ’¡ Recommendations\n\n`;
                        data.recommendations.forEach(rec => {
                            output += `â€¢ ${rec}\n`;
                        });
                    }
                } else if (action === 'schedule') {
                    output = `## ğŸ“… Campaign Scheduled\n\n`;
                    output += `**Campaign**: ${data.campaign_name}\n`;
                    output += `**Status**: ${data.status}\n`;
                    if (data.start_date) {
                        output += `**Start Date**: ${data.start_date}\n`;
                    }
                    if (data.end_date) {
                        output += `**End Date**: ${data.end_date}\n`;
                    }
                    output += `\n`;

                    if (data.schedule) {
                        if (data.schedule.schedule) {
                            output += `### ğŸ“‹ Schedule Details\n\n`;
                            output += data.schedule.schedule;
                            output += `\n\n`;
                        }
                        if (data.schedule.milestones && data.schedule.milestones.length > 0) {
                            output += `### ğŸ¯ Key Milestones\n\n`;
                            data.schedule.milestones.forEach(milestone => {
                                output += `â€¢ ${milestone}\n`;
                            });
                        }
                    }
                }

                // Convert markdown to HTML and display
                resultContent.innerHTML = markdownToHtml(output);
                result.classList.add('show');
            } else {
                resultContent.textContent = `Error: ${data.error || 'Unknown error occurred'}`;
                result.classList.add('show');
            }
        } catch (error) {
            resultContent.textContent = `Error: ${error.message}`;
            result.classList.add('show');
        } finally {
            loading.classList.remove('show');
        }
    }

    // Handle hash in URL (e.g., #qa, #campaign, #document-authoring)
    function handleHashChange() {
        const hash = window.location.hash.substring(1);
        if (hash) {
            // Map URL-friendly hash names to tab names
            const hashMap = {
                'document-authoring': 'document',
                'document': 'document',
                'outreach-campaign': 'campaign',
                'campaign': 'campaign',
                'market-research': 'research',
                'research': 'research'
            };
            const tabName = hashMap[hash] || hash;
            if (tabName) {
                switchTab(tabName);
                // Scroll to top of agents container
                const container = document.querySelector('.agents-container');
                if (container) {
                    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }
    }

    // Handle hash on page load
    window.addEventListener('DOMContentLoaded', () => {
        handleHashChange();
    });

    // Also handle hash changes (when clicking links with hash)
    window.addEventListener('hashchange', () => {
        handleHashChange();
    });

    // Format presentation content with slide breaks
    // function formatPresentation(content) {
    //     if (!content) return '';
        
    //     // Split by slide markers
    //     const slides = content.split(/(?=#\s*Slide\s+\d+:|Slide\s+\d+:|##\s*Slide\s+\d+)/i);
    //     let formatted = '';
        
    //     slides.forEach((slide, index) => {
    //         if (slide.trim()) {
    //             // Add slide container
    //             formatted += `\n\n<div class="presentation-slide" style="margin: 2rem 0; padding: 1.5rem; background: #f8f9fa; border-left: 4px solid var(--primary-color); border-radius: var(--radius-md);">\n`;
    //             formatted += slide.trim();
    //             formatted += `\n</div>\n`;
    //         }
    //     });
        
    //     return formatted || content;
    // }

    // Document Authoring Functions
    function updateDocumentForm() {
        const action = document.getElementById('document-action').value;
        const formContainer = document.getElementById('document-form-container');
        
        if (action) {
            formContainer.style.display = 'block';
            const submitText = document.getElementById('document-submit-text');
            if (action === 'create') {
                submitText.textContent = 'ğŸ“„ Create & Save Document';
            } else if (action === 'generate') {
                submitText.textContent = 'ğŸ‘ï¸ Generate Preview';
            }
        } else {
            formContainer.style.display = 'none';
        }
        
        // Hide results when form changes
        document.getElementById('document-results').style.display = 'none';
    }

    async function handleDocument(event) {
        event.preventDefault();

        const action = document.getElementById('document-action').value;
        if (!action) {
            alert('Please select an action first.');
            return;
        }

        const documentType = document.getElementById('document-type').value;
        if (!documentType) {
            alert('Please select a document type.');
            return;
        }

        // Validate campaign selection for report and brief
        const campaignId = document.getElementById('document-campaign-select').value;
        if ((documentType === 'report' || documentType === 'brief') && !campaignId) {
            alert('A campaign must be selected to create a ' + (documentType === 'report' ? 'Performance Report' : 'Campaign Brief') + '. Please select a campaign first.');
            document.getElementById('document-campaign-select').focus();
            return;
        }

        const loading = document.getElementById('document-loading');
        const submitText = document.getElementById('document-submit-text');
        const results = document.getElementById('document-results');
        const resultsContent = document.getElementById('document-results-content');

        // Show loading
        loading.style.display = 'inline';
        submitText.style.display = 'none';
        results.style.display = 'none';

        try {
            // Build document data
            const documentData = {
                title: document.getElementById('document-title').value,
                requirements: document.getElementById('document-requirements').value,
                key_points: document.getElementById('document-context').value
            };
            
            const requestData = {
                action: action,
                document_type: documentType,
                document_data: documentData,
                campaign_id: campaignId ? parseInt(campaignId) : null,
                context: {}
            };

            const response = await fetch('{% url "test_document_authoring" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorText = await response.text();
                try {
                    const errorJson = JSON.parse(errorText);
                    throw new Error(errorJson.error || `HTTP ${response.status}`);
                } catch {
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }
            }

            const data = await response.json();

            if (data.success) {
                let output = '';

                if (action === 'create') {
                    output = `## âœ… Document Created Successfully\n\n`;
                    output += `**Document ID**: ${data.document_id}\n`;
                    output += `**Title**: ${data.title}\n`;
                    output += `**Type**: ${data.document_type}\n`;
                    output += `**Status**: ${data.status}\n\n`;
                    output += `${data.message || 'Document created successfully!'}\n\n`;
                    // output += `ğŸ“ **Saved Location**: Database (MarketingDocument model)\n\n`;
                    // output += `<div style="margin: 1rem 0; padding: 1rem; background: #e8f4f8; border-radius: var(--radius-md); border-left: 4px solid var(--primary-color);">`;
                    // output += `<strong>ğŸ”— Quick Links:</strong><br>`;
                    // output += `â€¢ <a href="/marketing/documents/" style="color: var(--primary-color); text-decoration: underline;">View All Documents</a><br>`;
                    // output += `â€¢ <a href="/marketing/documents/${data.document_id}/" style="color: var(--primary-color); text-decoration: underline;">View This Document</a>`;
                    // output += `</div>\n\n`;
                    
                    // Add download buttons based on document type
                    output += `<div style="margin: 1rem 0; padding: 1rem; background: #f0f9ff; border-radius: var(--radius-md); border: 1px solid var(--primary-color);">`;
                    output += `<strong>ğŸ“¥ Download Document:</strong><br><br>`;
                    
                    // PDF for all types
                    output += `<a href="/marketing/documents/${data.document_id}/download/pdf/" style="display: inline-block; padding: 0.5rem 1rem; margin: 0.25rem; background: #dc2626; color: white; text-decoration: none; border-radius: var(--radius-md); font-size: 0.9rem;">ğŸ“„ PDF</a>`;
                    
                    // DOCX for all types
                    output += `<a href="/marketing/documents/${data.document_id}/download/docx/" style="display: inline-block; padding: 0.5rem 1rem; margin: 0.25rem; background: #2563eb; color: white; text-decoration: none; border-radius: var(--radius-md); font-size: 0.9rem;">ğŸ“ Word (DOCX)</a>`;
                    
                    // PPTX only for presentations
                    // if (data.document_type === 'presentation') {
                    //     output += `<a href="/marketing/documents/${data.document_id}/download/pptx/" style="display: inline-block; padding: 0.5rem 1rem; margin: 0.25rem; background: #ea580c; color: white; text-decoration: none; border-radius: var(--radius-md); font-size: 0.9rem;">ğŸ“Š PowerPoint (PPTX)</a>`;
                    // }
                    
                    output += `</div>\n\n`;
                    
                    if (data.content) {
                        output += `---\n\n## ğŸ“„ Document Content\n\n`;
                        // Format content based on document type
                        // if (data.document_type === 'presentation') {
                        //     output += formatPresentation(data.content);
                        // } else {
                            output += data.content;
                        // }
                    }
                } else if (action === 'generate') {
                    output = `## ğŸ‘ï¸ Document Preview\n\n`;
                    output += `**Title**: ${data.title}\n`;
                    output += `**Type**: ${data.document_type}\n\n`;
                    output += `---\n\n## ğŸ“„ Generated Content\n\n`;
                    if (data.content) {
                        // if (data.document_type === 'presentation') {
                        //     output += formatPresentation(data.content);
                        // } else {
                            output += data.content;
                        // }
                    } else {
                        output += 'No content generated.';
                    }
                    output += `\n\nğŸ’¡ **Note:** This is a preview. Use "Create & Save Document" to save it to the database.`;
                }

                // Convert markdown to HTML and display
                resultsContent.innerHTML = markdownToHtml(output);
                results.style.display = 'block';
                
                // Scroll to results
                results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        } catch (error) {
            resultsContent.innerHTML = `<div style="color: #e74c3c; padding: 1rem; background: #fee; border-radius: var(--radius-md); border: 1px solid #e74c3c;">
                <strong>âŒ Error:</strong> ${error.message}
            </div>`;
            results.style.display = 'block';
        } finally {
            loading.style.display = 'none';
            submitText.style.display = 'inline';
        }
    }

    // Proactive Notification Functions
    async function monitorCampaigns() {
        const campaignId = document.getElementById('notification-campaign-select').value;
        const container = document.getElementById('notifications-container');
        
        container.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner"></div><p>Monitoring campaigns...</p></div>';
        
        try {
            const action = campaignId ? 'check_campaign' : 'monitor';
            const requestData = {
                action: action,
                campaign_id: campaignId ? parseInt(campaignId) : null,
                context: {}
            };
            
            const response = await fetch('{% url "test_proactive_notification" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Show summary first
                let summary = `<div style="padding: 1rem; background: #f0f9ff; border-radius: var(--radius-md); margin-bottom: 1rem; border-left: 4px solid var(--primary-color);">`;
                summary += `<strong>âœ… Monitoring Complete</strong><br>`;
                summary += `Campaigns Monitored: ${data.campaigns_monitored || 1}<br>`;
                summary += `New Notifications Created: ${data.notifications_created || 0}<br>`;
                summary += `Issues Found: ${data.issues_found || 0}<br>`;
                summary += `Opportunities Found: ${data.opportunities_found || 0}`;
                if (data.notifications_created === 0 && (data.issues_found > 0 || data.opportunities_found > 0)) {
                    summary += `<br><small style="color: var(--text-secondary);">Note: Similar notifications may already exist from previous monitoring.</small>`;
                }
                summary += `</div>`;
                
                // Load recent notifications and history
                await loadNotifications();
                await loadNotificationHistory();
                
                // Prepend summary to notifications
                const currentContent = container.innerHTML;
                container.innerHTML = summary + currentContent;
            } else {
                container.innerHTML = `<div style="padding: 1rem; background: #fee; border-radius: var(--radius-md); color: #c00;">Error: ${data.error || 'Unknown error'}</div>`;
            }
        } catch (error) {
            container.innerHTML = `<div style="padding: 1rem; background: #fee; border-radius: var(--radius-md); color: #c00;">Error: ${error.message}</div>`;
        }
    }
    
    async function loadNotifications() {
        const container = document.getElementById('notifications-container');
        
        try {
            const response = await fetch('{% url "get_notifications" %}?unread_only=true');
            const data = await response.json();
            
            if (data.success) {
                if (data.count === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No unread notifications. All caught up! ğŸ‰</div>';
                } else {
                    let html = `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f0f9ff; border-radius: var(--radius-md); font-size: 0.9rem;">`;
                    html += `<strong>Unread: ${data.count}</strong>`;
                    html += `</div>`;
                    
                    data.notifications.forEach(notif => {
                        html += renderNotification(notif, false);
                    });
                    
                    container.innerHTML = html;
                }
            } else {
                container.innerHTML = `<div style="padding: 1rem; background: #fee; border-radius: var(--radius-md); color: #c00;">Error: ${data.error || 'Unknown error'}</div>`;
            }
        } catch (error) {
            container.innerHTML = `<div style="padding: 1rem; background: #fee; border-radius: var(--radius-md); color: #c00;">Error: ${error.message}</div>`;
        }
    }
    
    async function loadNotificationHistory() {
        const container = document.getElementById('notification-history-container');
        
        try {
            const response = await fetch('{% url "get_notifications" %}?unread_only=false');
            const data = await response.json();
            
            if (data.success) {
                // Filter to only show read notifications
                const readNotifications = data.notifications.filter(n => n.is_read);
                
                if (readNotifications.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No notification history yet.</div>';
                } else {
                    let html = `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: var(--radius-md); font-size: 0.9rem;">`;
                    html += `<strong>History: ${readNotifications.length} read notifications</strong>`;
                    html += `</div>`;
                    
                    readNotifications.forEach(notif => {
                        html += renderNotification(notif, true);
                    });
                    
                    container.innerHTML = html;
                }
            } else {
                container.innerHTML = `<div style="padding: 1rem; background: #fee; border-radius: var(--radius-md); color: #c00;">Error: ${data.error || 'Unknown error'}</div>`;
            }
        } catch (error) {
            container.innerHTML = `<div style="padding: 1rem; background: #fee; border-radius: var(--radius-md); color: #c00;">Error: ${error.message}</div>`;
        }
    }
    
    function renderNotification(notif, isHistory) {
        const priorityColors = {
            'low': '#6b7280',
            'medium': '#3b82f6',
            'high': '#f59e0b',
            'critical': '#ef4444'
        };
        const priorityColor = priorityColors[notif.priority] || '#6b7280';
        
        let html = `<div style="padding: 1rem; margin-bottom: 0.75rem; background: ${notif.is_read ? '#f9fafb' : '#fff'}; border-radius: var(--radius-md); border-left: 4px solid ${priorityColor}; border: 1px solid var(--border-color);">`;
        html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">`;
        html += `<div style="flex: 1;">`;
        html += `<strong style="color: ${priorityColor}; ${notif.is_read ? 'opacity: 0.7;' : ''}">${notif.title}</strong>`;
        if (notif.campaign_name) {
            html += `<br><small style="color: var(--text-secondary);">Campaign: ${notif.campaign_name}</small>`;
        }
        html += `</div>`;
        html += `<div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">`;
        html += `<span style="padding: 0.25rem 0.5rem; background: ${priorityColor}; color: white; border-radius: var(--radius-sm); font-size: 0.75rem;">${notif.priority}</span>`;
        if (!notif.is_read && !isHistory) {
            html += `<button onclick="markRead(${notif.id})" style="padding: 0.25rem 0.5rem; background: var(--primary-color); color: white; border: none; border-radius: var(--radius-sm); font-size: 0.75rem; cursor: pointer;">Mark Read</button>`;
        }
        html += `<button onclick="deleteNotification(${notif.id})" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: var(--radius-sm); font-size: 0.75rem; cursor: pointer;" title="Delete notification">ğŸ—‘ï¸</button>`;
        html += `</div>`;
        html += `</div>`;
        html += `<p style="margin: 0.5rem 0; color: var(--text-secondary); ${notif.is_read ? 'opacity: 0.7;' : ''}">${notif.message}</p>`;
        if (notif.action_url) {
            html += `<a href="${notif.action_url}" style="color: var(--primary-color); text-decoration: underline; font-size: 0.9rem;">View Campaign â†’</a>`;
        }
        html += `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">${new Date(notif.created_at).toLocaleString()}</div>`;
        html += `</div>`;
        
        return html;
    }
    
    async function markRead(notificationId) {
        try {
            const response = await fetch(`/marketing/api/notifications/${notificationId}/read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (response.ok) {
                await loadNotifications();
                await loadNotificationHistory();
            }
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }
    
    async function deleteNotification(notificationId) {
        if (!confirm('Are you sure you want to delete this notification?')) {
            return;
        }
        
        try {
            const response = await fetch(`/marketing/api/notifications/${notificationId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            if (response.ok) {
                await loadNotifications();
                await loadNotificationHistory();
            } else {
                const data = await response.json();
                alert('Error: ' + (data.error || 'Failed to delete notification'));
            }
        } catch (error) {
            console.error('Error deleting notification:', error);
            alert('Error deleting notification: ' + error.message);
        }
    }
    
    // Update campaign requirement based on document type
    function updateDocumentCampaignRequirement() {
        const documentType = document.getElementById('document-type').value;
        const campaignSelect = document.getElementById('document-campaign-select');
        const campaignRequired = document.getElementById('document-campaign-required');
        const campaignHint = document.getElementById('document-campaign-hint');
        
        // Require campaign for Performance Report and Campaign Brief
        if (documentType === 'report' || documentType === 'brief') {
            campaignSelect.required = true;
            if (campaignRequired) campaignRequired.style.display = 'inline';
            if (campaignHint) {
                campaignHint.textContent = 'Campaign selection is required for ' + (documentType === 'report' ? 'Performance Report' : 'Campaign Brief') + ' documents.';
                campaignHint.style.color = '#e74c3c';
            }
        } else {
            campaignSelect.required = false;
            if (campaignRequired) campaignRequired.style.display = 'none';
            if (campaignHint) {
                campaignHint.textContent = 'Optionally link this document to a campaign for context';
                campaignHint.style.color = '';
            }
        }
    }
    
    // Load notifications on page load if notification tab is active
    document.addEventListener('DOMContentLoaded', function() {
        if (window.location.hash === '#notification') {
            loadNotifications();
            loadNotificationHistory();
        }
    });
</script>
{% endblock %}