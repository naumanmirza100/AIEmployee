{% extends 'base.html' %}
{% load static %}
{% load tz %}
{% block title %}Email Sending Status - {{ campaign.name }}{% endblock %}

{% block content %}
{% csrf_token %}
<style>
    .status-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .status-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .status-card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .status-card.active {
        border-color: #10b981;
        background: #f0fdf4;
    }
    
    .status-card.pending {
        border-color: #f59e0b;
        background: #fffbeb;
    }
    
    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .status-dot.active {
        background: #10b981;
    }
    
    .status-dot.inactive {
        background: #6b7280;
        animation: none;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .email-list {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .email-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .email-item:last-child {
        border-bottom: none;
    }
    
    .email-type-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge-initial {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .badge-sequence {
        background: #fce7f3;
        color: #9f1239;
    }
    
    .badge-pending {
        background: #fef3c7;
        color: #92400e;
    }
    
    .badge-sent {
        background: #d1fae5;
        color: #065f46;
    }
    
    .upcoming-item {
        padding: 1rem;
        background: #f9fafb;
        border-left: 4px solid #3b82f6;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
    }
    
    .refresh-btn {
        padding: 0.5rem 1rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 500;
    }
    
    .refresh-btn:hover {
        background: #2563eb;
    }
    
    .auto-refresh-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        margin-left: 0.5rem;
        animation: pulse 2s infinite;
    }
</style>

<div class="status-container">
    <div class="page-header">
        <div>
            <h1 style="margin: 0; color: #1f2937;">ğŸ“Š Email Sending Status</h1>
            <p style="color: #6b7280; margin: 0.5rem 0 0 0;">
                <a href="{% url 'campaign_detail' campaign.id %}" style="color: #3b82f6; text-decoration: none;">
                    â† Back to {{ campaign.name }}
                </a>
            </p>
        </div>
        <button onclick="location.reload()" class="refresh-btn">
            ğŸ”„ Refresh
            <span class="auto-refresh-indicator" id="autoRefreshIndicator"></span>
        </button>
    </div>
    
    <!-- Comprehensive Stats Cards -->
    <div class="status-cards" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
        <div class="status-card {% if currently_sending.sequences %}active{% endif %}">
            <div class="status-indicator">
                <div class="status-dot {% if currently_sending.sequences %}active{% else %}inactive{% endif %}"></div>
                <h3 style="margin: 0; color: #1f2937;">Total Sent</h3>
            </div>
            <div style="font-size: 2rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                {{ stats.total_sent }}
            </div>
            <div style="color: #6b7280; font-size: 0.875rem;">
                {% if currently_sending.sequences %}
                    âœ… Currently sending
                {% else %}
                    â¸ï¸ Not sending
                {% endif %}
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-indicator">
                <div class="status-dot {% if stats.total_opened > 0 %}active{% else %}inactive{% endif %}"></div>
                <h3 style="margin: 0; color: #1f2937;">Opened</h3>
            </div>
            <div style="font-size: 2rem; font-weight: 600; color: #f59e0b; margin-bottom: 0.5rem;">
                {{ stats.total_opened }}
            </div>
            <div style="color: #6b7280; font-size: 0.875rem;">
                {{ stats.open_rate|floatformat:1 }}% open rate
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-indicator">
                <div class="status-dot {% if stats.total_clicked > 0 %}active{% else %}inactive{% endif %}"></div>
                <h3 style="margin: 0; color: #1f2937;">Clicked</h3>
            </div>
            <div style="font-size: 2rem; font-weight: 600; color: #8b5cf6; margin-bottom: 0.5rem;">
                {{ stats.total_clicked }}
            </div>
            <div style="color: #6b7280; font-size: 0.875rem;">
                {{ stats.click_rate|floatformat:1 }}% click rate
            </div>
        </div>
        
        <!-- <div class="status-card {% if stats.pending_count > 0 %}pending{% endif %}"> -->
            <!-- <div class="status-indicator">
                <div class="status-dot {% if stats.pending_count > 0 %}active{% else %}inactive{% endif %}"></div>
                <h3 style="margin: 0; color: #1f2937;">Pending</h3>
            </div>
            <div style="font-size: 2rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                {{ stats.pending_count }}
            </div> -->
            <!-- <div style="color: #6b7280; font-size: 0.875rem;">
                Emails waiting to be sent
            </div> -->
        <!-- </div> -->
        
        <div class="status-card" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div class="status-indicator">
                <!-- <div class="status-dot {% if stats.pending_count > 0 %}active{% else %}inactive{% endif %}"></div> -->
                <div class="status-dot {% if stats.total_clicked > 0 %}active{% else %}inactive{% endif %}"></div>
                <h3 style="margin: 0; color: #1f2937;">Upcoming</h3>
            </div>
            <!-- <div style="font-size: 2rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;"> -->
                <div style="font-size: 2rem; font-weight: 600; color: #8b5cf6; margin-bottom: 0.5rem;">
                {{ stats.upcoming_count|default:upcoming_sequence_sends|length }}
            </div>
            <div style="color: #6b7280; font-size: 0.875rem;">
                scheduled Emails
            </div>
        </div>
        
        <!-- <div class="status-card">
            <div class="status-indicator">
                <div class="status-dot {% if stats.total_bounced > 0 %}active{% else %}inactive{% endif %}"></div>
                <h3 style="margin: 0; color: #1f2937;">Bounced</h3>
            </div>
            <div style="font-size: 2rem; font-weight: 600; color: #ef4444; margin-bottom: 0.5rem;">
                {{ stats.total_bounced }}
            </div>
            <div style="color: #6b7280; font-size: 0.875rem;">
                Failed deliveries
            </div>
        </div> -->
        
        <div class="status-card">
            <div class="status-indicator">
                <div class="status-dot {% if stats.total_failed > 0 %}active{% else %}inactive{% endif %}"></div>
                <h3 style="margin: 0; color: #1f2937;">Failed</h3>
            </div>
            <div style="font-size: 2rem; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem;">
                {{ stats.total_failed }}
            </div>
            <div style="color: #6b7280; font-size: 0.875rem;">
                Send failures
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-indicator">
                <div class="status-dot {% if stats.total_replied > 0 %}active{% else %}inactive{% endif %}"></div>
                <h3 style="margin: 0; color: #1f2937;">Replied</h3>
            </div>
            <div style="font-size: 2rem; font-weight: 600; color: #10b981; margin-bottom: 0.5rem;">
                {{ stats.total_replied }}
            </div>
            <div style="color: #6b7280; font-size: 0.875rem;">
                Leads who responded
            </div>
        </div>
    </div>
    
    <!-- Full Email History - Organized by Sequence -->
    <div class="email-list">
        <h2 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">
            ğŸ“§ Full Email History (Last 100) - Organized by Sequence
        </h2>
        {% if emails_by_sequence %}
            {% for seq_key, seq_data in emails_by_sequence.items %}
            <div style="margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; background: #f9fafb;">
                <h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600;">
                        Sequence: {{ seq_data.sequence_name }}
                    </span>
                    <!-- {% if seq_data.sequence %}
                    <span style="color: #6b7280; font-size: 0.875rem;">(ID: {{ seq_data.sequence.id }})</span>
                    {% endif %} -->
                </h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Recipient</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Subject</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Template</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; font-size: 0.875rem;">Type</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; font-size: 0.875rem;">Status</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; font-size: 0.875rem;">Replied</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Sent At</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; font-size: 0.875rem;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for email_data in seq_data.emails %}
                            {% with email=email_data.email %}
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; color: #1f2937;">{{ email.recipient_email }}</td>
                                <td style="padding: 0.75rem; color: #1f2937; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ email.subject }}</td>
                                <td style="padding: 0.75rem; color: #1f2937; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {% if email.email_template %}
                                        {{ email.email_template.name }}
                                    {% else %}
                                        <span style="color: #9ca3af;">â€”</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.75rem; text-align: center;">
                                    {% if email_data.is_sub_sequence_email %}
                                        <span class="email-type-badge badge-sub-sequence" style="background: #ede9fe; color: #5b21b6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                            ğŸ”€ Sub-Sequence
                                        </span>
                                    {% elif email_data.is_sequence_email %}
                                        <span class="email-type-badge badge-sequence" style="background: #fce7f3; color: #9f1239; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                            ğŸ”„ Sequence
                                        </span>
                                    {% else %}
                                        <span class="email-type-badge badge-initial" style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                            ğŸ“§ Initial
                                        </span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.75rem; text-align: center;">
                                    <span class="email-type-badge badge-{{ email.status }}" style="
                                        background: {% if email.status == 'sent' %}#dbeafe{% elif email.status == 'delivered' %}#d1fae5{% elif email.status == 'opened' %}#fef3c7{% elif email.status == 'clicked' %}#ede9fe{% elif email.status == 'failed' %}#fee2e2{% elif email.status == 'bounced' %}#fce7f3{% else %}#f3f4f6{% endif %};
                                        color: {% if email.status == 'sent' %}#1e40af{% elif email.status == 'delivered' %}#065f46{% elif email.status == 'opened' %}#92400e{% elif email.status == 'clicked' %}#5b21b6{% elif email.status == 'failed' %}#991b1b{% elif email.status == 'bounced' %}#9f1239{% else %}#6b7280{% endif %};
                                    ">
                                        {{ email.get_status_display }}
                                    </span>
                                </td>
                                <td style="padding: 0.75rem; text-align: center;">
                                    {% if email_data.is_replied and email_data.latest_reply %}
                                        <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; display: inline-block;">
                                            âœ… Replied
                                        </span>
                                        {% if email_data.latest_reply.interest_level == 'positive' %}
                                            <div style="font-size: 0.7rem; color: #10b981; margin-top: 0.25rem; font-weight: 500;">âœ… Interested</div>
                                        {% elif email_data.latest_reply.interest_level == 'negative' %}
                                            <div style="font-size: 0.7rem; color: #ef4444; margin-top: 0.25rem; font-weight: 500;">âŒ Not Interested</div>
                                        {% elif email_data.latest_reply.interest_level == 'neutral' %}
                                            <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem; font-weight: 500;">â– Neutral</div>
                                        {% elif email_data.latest_reply.interest_level == 'requested_info' %}
                                            <div style="font-size: 0.7rem; color: #3b82f6; margin-top: 0.25rem; font-weight: 500;">ğŸ“‹ Requested Info</div>
                                        {% elif email_data.latest_reply.interest_level == 'objection' %}
                                            <div style="font-size: 0.7rem; color: #f59e0b; margin-top: 0.25rem; font-weight: 500;">âš ï¸ Objection</div>
                                        {% endif %}
                                    {% elif email_data.is_replied and email_data.contact %}
                                        {# Fallback to contact if latest_reply not available #}
                                        <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; display: inline-block;">
                                            âœ… Replied
                                        </span>
                                        {% if email_data.contact.reply_interest_level == 'positive' %}
                                            <div style="font-size: 0.7rem; color: #10b981; margin-top: 0.25rem; font-weight: 500;">âœ… Interested</div>
                                        {% elif email_data.contact.reply_interest_level == 'negative' %}
                                            <div style="font-size: 0.7rem; color: #ef4444; margin-top: 0.25rem; font-weight: 500;">âŒ Not Interested</div>
                                        {% elif email_data.contact.reply_interest_level == 'neutral' %}
                                            <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem; font-weight: 500;">â– Neutral</div>
                                        {% endif %}
                                    {% else %}
                                        <span style="color: #9ca3af; font-size: 0.75rem;">â€”</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.75rem; color: #6b7280; font-size: 0.875rem;">
                                    {% if email.sent_at %}
                                        <span class="email-sent-time" data-utc-timestamp="{{ email.sent_at|date:"U" }}">
                                            {{ email.sent_at|date:"M d, Y H:i" }}
                                        </span>
                                    {% else %}
                                        <span style="color: #9ca3af;">Pending</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.75rem; text-align: center;">
                                    <button onclick="openReplyModal({{ campaign.id }}, {{ email.lead.id }}, '{{ email.lead.email|escapejs }}', '{{ email.subject|escapejs }}')" 
                                            style="padding: 0.375rem 0.75rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                                        ğŸ’¬ Mark Reply
                                    </button>
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
            <div style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                Showing last 100 emails. Total sent: <strong>{{ stats.total_sent }}</strong>
            </div>
        {% elif all_email_history %}
            <!-- Fallback: show all emails if not organized by sequence -->
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: white;">
                    <thead>
                        <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Recipient</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Subject</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Template</th>
                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; font-size: 0.875rem;">Type</th>
                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; font-size: 0.875rem;">Status</th>
                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; font-size: 0.875rem;">Replied</th>
                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Sent At</th>
                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151; font-size: 0.875rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for email_data in all_email_history %}
                        {% with email=email_data.email %}
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 0.75rem; color: #1f2937;">{{ email.recipient_email }}</td>
                            <td style="padding: 0.75rem; color: #1f2937; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ email.subject }}</td>
                            <td style="padding: 0.75rem; color: #1f2937; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {% if email.email_template %}
                                    {{ email.email_template.name }}
                                {% else %}
                                    <span style="color: #9ca3af;">â€”</span>
                                {% endif %}
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                {% if email_data.is_sub_sequence_email %}
                                    <span class="email-type-badge badge-sub-sequence" style="background: #ede9fe; color: #5b21b6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                        ğŸ”€ Sub-Sequence
                                    </span>
                                {% elif email_data.is_sequence_email %}
                                    <span class="email-type-badge badge-sequence" style="background: #fce7f3; color: #9f1239; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                        ğŸ”„ Sequence
                                    </span>
                                {% else %}
                                    <span class="email-type-badge badge-initial" style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                        ğŸ“§ Initial
                                    </span>
                                {% endif %}
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <span class="email-type-badge badge-{{ email.status }}" style="
                                    background: {% if email.status == 'sent' %}#dbeafe{% elif email.status == 'delivered' %}#d1fae5{% elif email.status == 'opened' %}#fef3c7{% elif email.status == 'clicked' %}#ede9fe{% elif email.status == 'failed' %}#fee2e2{% elif email.status == 'bounced' %}#fce7f3{% else %}#f3f4f6{% endif %};
                                    color: {% if email.status == 'sent' %}#1e40af{% elif email.status == 'delivered' %}#065f46{% elif email.status == 'opened' %}#92400e{% elif email.status == 'clicked' %}#5b21b6{% elif email.status == 'failed' %}#991b1b{% elif email.status == 'bounced' %}#9f1239{% else %}#6b7280{% endif %};
                                ">
                                    {{ email.get_status_display }}
                                </span>
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                {% if email_data.is_replied and email_data.latest_reply %}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; display: inline-block;">
                                        âœ… Replied
                                    </span>
                                    {% if email_data.latest_reply.interest_level == 'positive' %}
                                        <div style="font-size: 0.7rem; color: #10b981; margin-top: 0.25rem; font-weight: 500;">âœ… Interested</div>
                                    {% elif email_data.latest_reply.interest_level == 'negative' %}
                                        <div style="font-size: 0.7rem; color: #ef4444; margin-top: 0.25rem; font-weight: 500;">âŒ Not Interested</div>
                                    {% elif email_data.latest_reply.interest_level == 'neutral' %}
                                        <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem; font-weight: 500;">â– Neutral</div>
                                    {% elif email_data.latest_reply.interest_level == 'requested_info' %}
                                        <div style="font-size: 0.7rem; color: #3b82f6; margin-top: 0.25rem; font-weight: 500;">ğŸ“‹ Requested Info</div>
                                    {% elif email_data.latest_reply.interest_level == 'objection' %}
                                        <div style="font-size: 0.7rem; color: #f59e0b; margin-top: 0.25rem; font-weight: 500;">âš ï¸ Objection</div>
                                    {% endif %}
                                {% elif email_data.is_replied and email_data.contact %}
                                    {# Fallback #}
                                    <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; display: inline-block;">
                                        âœ… Replied
                                    </span>
                                    {% if email_data.contact.reply_interest_level == 'positive' %}
                                        <div style="font-size: 0.7rem; color: #10b981; margin-top: 0.25rem; font-weight: 500;">âœ… Interested</div>
                                    {% elif email_data.contact.reply_interest_level == 'negative' %}
                                        <div style="font-size: 0.7rem; color: #ef4444; margin-top: 0.25rem; font-weight: 500;">âŒ Not Interested</div>
                                    {% elif email_data.contact.reply_interest_level == 'neutral' %}
                                        <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem; font-weight: 500;">â– Neutral</div>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #9ca3af; font-size: 0.75rem;">â€”</span>
                                {% endif %}
                            </td>
                            <td style="padding: 0.75rem; color: #6b7280; font-size: 0.875rem;">
                                {% if email.sent_at %}
                                    <span class="email-sent-time" data-utc-timestamp="{{ email.sent_at|date:"U" }}">
                                        {{ email.sent_at|date:"M d, Y H:i" }}
                                    </span>
                                {% else %}
                                    <span style="color: #9ca3af;">Pending</span>
                                {% endif %}
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <button onclick="openReplyModal({{ campaign.id }}, {{ email.lead.id }}, '{{ email.lead.email|escapejs }}', '{{ email.subject|escapejs }}')" 
                                        style="padding: 0.375rem 0.75rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                                    ğŸ’¬ Mark Reply
                                </button>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                Showing last 100 emails. Total sent: <strong>{{ stats.total_sent }}</strong>
            </div>
        {% else %}
            <p style="color: #6b7280; text-align: center; padding: 2rem;">
                No emails sent yet. Emails will appear here after you launch the campaign.
            </p>
        {% endif %}
    </div>
    
    <!-- Recent Sequence Emails (Last 24 Hours) -->
    {% if sequence_emails %}
    <div class="email-list">
        <h2 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">
            ğŸ”„ Recent Sequence Emails (Last 24 Hours)
        </h2>
        <div>
            {% for email_data in sequence_emails %}
            {% with email=email_data.email %}
            <div class="email-item">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                        {% if email_data.is_sub_sequence_email %}
                            <span class="email-type-badge badge-sub-sequence" style="background: #ede9fe; color: #5b21b6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">ğŸ”€ Sub-Sequence</span>
                        {% else %}
                            <span class="email-type-badge badge-sequence">ğŸ”„ Sequence</span>
                        {% endif %}
                        <strong style="color: #1f2937;">{{ email.recipient_email }}</strong>
                        {% if email_data.is_replied and email_data.latest_reply %}
                            <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                âœ… Replied
                            </span>
                            {% if email_data.latest_reply.interest_level == 'positive' %}
                                <span style="background: #d1fae5; color: #065f46; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">âœ… Interested</span>
                            {% elif email_data.latest_reply.interest_level == 'negative' %}
                                <span style="background: #fee2e2; color: #991b1b; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">âŒ Not Interested</span>
                            {% elif email_data.latest_reply.interest_level == 'neutral' %}
                                <span style="background: #f3f4f6; color: #6b7280; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">â– Neutral</span>
                            {% elif email_data.latest_reply.interest_level == 'requested_info' %}
                                <span style="background: #dbeafe; color: #1e40af; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">ğŸ“‹ Requested Info</span>
                            {% elif email_data.latest_reply.interest_level == 'objection' %}
                                <span style="background: #fef3c7; color: #92400e; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">âš ï¸ Objection</span>
                            {% elif email_data.latest_reply.interest_level == 'unsubscribe' %}
                                <span style="background: #fee2e2; color: #991b1b; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">ğŸš« Unsubscribe</span>
                            {% endif %}
                        {% elif email_data.is_replied and email_data.contact %}
                            {# Fallback #}
                            <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                âœ… Replied
                            </span>
                            {% if email_data.contact.reply_interest_level == 'positive' %}
                                <span style="background: #d1fae5; color: #065f46; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">âœ… Interested</span>
                            {% elif email_data.contact.reply_interest_level == 'negative' %}
                                <span style="background: #fee2e2; color: #991b1b; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">âŒ Not Interested</span>
                            {% elif email_data.contact.reply_interest_level == 'neutral' %}
                                <span style="background: #f3f4f6; color: #6b7280; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">â– Neutral</span>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                        {{ email.subject }}
                        {% if email.email_template %}
                            - {{ email.email_template.name }}
                        {% endif %}
                    </div>
                </div>
                <div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        {% if email.sent_at %}
                            <span class="email-sent-time" data-utc-timestamp="{{ email.sent_at|date:"U" }}">
                                {{ email.sent_at|date:"M d, Y H:i" }}
                            </span>
                        {% else %}
                            <span class="email-type-badge badge-pending">Pending</span>
                        {% endif %}
                    </div>
                    <div style="margin-top: 0.25rem;">
                        <span class="email-type-badge badge-{{ email.status }}">
                            {{ email.get_status_display }}
                        </span>
                    </div>
                    {% if email.lead %}
                    <button onclick="openReplyModal({{ campaign.id }}, {{ email.lead.id }}, '{{ email.lead.email|escapejs }}', '{{ email.subject|escapejs }}')" 
                            style="padding: 0.375rem 0.75rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; margin-top: 0.25rem;">
                        ğŸ’¬ Mark Reply
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Upcoming Sequence Sends - Organized by Sequence -->
    {% if upcoming_by_sequence %}
    <div class="email-list">
        <h2 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">
            â° Upcoming Sequence Sends (Next 24 Hours) - Organized by Sequence
        </h2>
        {% for seq_key, seq_data in upcoming_by_sequence.items %}
        <div style="margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; background: #f9fafb;">
            <h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600;">
                    Sequence: {{ seq_data.sequence_name }}
                </span>
                <!-- {% if seq_data.sequence %}
                <span style="color: #6b7280; font-size: 0.875rem;">(ID: {{ seq_data.sequence.id }})</span>
                {% endif %} -->
            </h3>
            <div>
                {% for upcoming in seq_data.emails %}
                <div class="upcoming-item">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                                {{ upcoming.lead.email }}
                            </div>
                            <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                                Next Step: <strong>Step {{ upcoming.next_step.step_order }}</strong> - {{ upcoming.next_step.template.name }}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #3b82f6; font-size: 1.1rem;">
                                <span class="upcoming-time" data-utc-timestamp="{{ upcoming.next_send_time|date:"U" }}">
                                    {{ upcoming.next_send_time|date:"M d, H:i" }}
                                </span>
                            </div>
                            <div style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem;">
                                <span class="time-remaining" data-send-timestamp="{{ upcoming.next_send_time|date:"U" }}">
                                    Calculating...
                                </span>
                            </div>
                            <div style="color: #9ca3af; font-size: 0.7rem; margin-top: 0.25rem;">
                                Delay: 
                                {% if upcoming.delay_days > 0 %}{{ upcoming.delay_days }} day{{ upcoming.delay_days|pluralize }}{% endif %}
                                {% if upcoming.delay_hours > 0 %}{% if upcoming.delay_days > 0 %}, {% endif %}{{ upcoming.delay_hours }} hour{{ upcoming.delay_hours|pluralize }}{% endif %}
                                {% if upcoming.delay_minutes > 0 %}{% if upcoming.delay_days > 0 or upcoming.delay_hours > 0 %}, {% endif %}{{ upcoming.delay_minutes }} minute{{ upcoming.delay_minutes|pluralize }}{% endif %}
                                {% if upcoming.delay_days == 0 and upcoming.delay_hours == 0 and upcoming.delay_minutes == 0 %}Immediate{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif upcoming_sequence_sends %}
    <!-- Fallback: show all upcoming emails if not organized by sequence -->
    <div class="email-list">
        <h2 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">
            â° Upcoming Sequence Sends (Next 24 Hours)
        </h2>
        <div>
            {% for upcoming in upcoming_sequence_sends %}
            <div class="upcoming-item">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                            {{ upcoming.lead.email }}
                        </div>
                        <div style="color: #6b7280; font-size: 0.875rem;">
                            Sequence: <strong>{{ upcoming.sequence.name }}</strong>
                        </div>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                            Next Step: <strong>Step {{ upcoming.next_step.step_order }}</strong> - {{ upcoming.next_step.template.name }}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: #3b82f6; font-size: 1.1rem;">
                            <span class="upcoming-time" data-utc-timestamp="{{ upcoming.next_send_time|date:"U" }}">
                                {{ upcoming.next_send_time|date:"M d, H:i" }}
                            </span>
                        </div>
                        <div style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem;">
                            <span class="time-remaining" data-send-timestamp="{{ upcoming.next_send_time|date:"U" }}">
                                Calculating...
                            </span>
                        </div>
                        <div style="color: #9ca3af; font-size: 0.7rem; margin-top: 0.25rem;">
                            Delay: 
                            {% if upcoming.delay_days > 0 %}{{ upcoming.delay_days }} day{{ upcoming.delay_days|pluralize }}{% endif %}
                            {% if upcoming.delay_hours > 0 %}{% if upcoming.delay_days > 0 %}, {% endif %}{{ upcoming.delay_hours }} hour{{ upcoming.delay_hours|pluralize }}{% endif %}
                            {% if upcoming.delay_minutes > 0 %}{% if upcoming.delay_days > 0 or upcoming.delay_hours > 0 %}, {% endif %}{{ upcoming.delay_minutes }} minute{{ upcoming.delay_minutes|pluralize }}{% endif %}
                            {% if upcoming.delay_days == 0 and upcoming.delay_hours == 0 and upcoming.delay_minutes == 0 %}Immediate{% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Pending Emails - Organized by Sequence -->
    {% if pending_by_sequence %}
    <div class="email-list">
        <h2 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">
            â³ Pending Emails (Ready to Send) - Organized by Sequence
        </h2>
        {% for seq_key, seq_data in pending_by_sequence.items %}
        <div style="margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; background: #f9fafb;">
            <h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600;">
                    Sequence: {{ seq_data.sequence_name }}
                </span>
                <!-- {% if seq_data.sequence %}
                <span style="color: #6b7280; font-size: 0.875rem;">(ID: {{ seq_data.sequence.id }})</span>
                {% endif %} -->
            </h3>
            <div>
                {% for email in seq_data.emails %}
                <div class="email-item">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            {% if email.is_sub_sequence %}
                            <span class="email-type-badge badge-sub-sequence" style="background: #ede9fe; color: #5b21b6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                                ğŸ”€ Sub-Sequence
                            </span>
                            {% else %}
                            <span class="email-type-badge badge-sequence">ğŸ”„ Sequence</span>
                            {% endif %}
                            <strong style="color: #1f2937;">{{ email.recipient_email }}</strong>
                        </div>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                            <strong>Subject:</strong> {{ email.subject }}<br>
                            {% if email.sequence %}
                            {% if email.is_sub_sequence %}
                            <strong>Sequence:</strong> {{ email.sequence.name }} - {{ email.sub_sequence.name }} - Step {{ email.next_step.step_order }}
                            {% else %}
                            <strong>Sequence:</strong> {{ email.sequence.name }} - Step {{ email.next_step.step_order }}
                            {% endif %}
                            {% endif %}
                            {% if email.is_retry %}
                            <br><span style="color: #f59e0b; font-weight: 600;">âš ï¸ Retry (Previous status: {{ email.previous_status|title }})</span>
                            {% endif %}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <span class="email-type-badge badge-pending">Pending</span>
                        <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                            {% if email.is_retry %}
                            Ready to retry
                            {% else %}
                            Ready to send
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif pending_emails %}
    <!-- Fallback: show all pending emails if not organized by sequence -->
    <div class="email-list">
        <h2 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">
            â³ Pending Emails (Ready to Send)
        </h2>
        <div>
            {% for email in pending_emails %}
            <div class="email-item">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        {% if email.is_sub_sequence %}
                        <span class="email-type-badge badge-sub-sequence" style="background: #ede9fe; color: #5b21b6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                            ğŸ”€ Sub-Sequence
                        </span>
                        {% else %}
                        <span class="email-type-badge badge-sequence">ğŸ”„ Sequence</span>
                        {% endif %}
                        <strong style="color: #1f2937;">{{ email.recipient_email }}</strong>
                    </div>
                    <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                        <strong>Subject:</strong> {{ email.subject }}<br>
                        {% if email.sequence %}
                        {% if email.is_sub_sequence %}
                        <strong>Sequence:</strong> {{ email.sequence.name }} - {{ email.sub_sequence.name }} - Step {{ email.next_step.step_order }}
                        {% else %}
                        <strong>Sequence:</strong> {{ email.sequence.name }} - Step {{ email.next_step.step_order }}
                        {% endif %}
                        {% endif %}
                        {% if email.is_retry %}
                        <br><span style="color: #f59e0b; font-weight: 600;">âš ï¸ Retry (Previous status: {{ email.previous_status|title }})</span>
                        {% endif %}
                    </div>
                </div>
                <div style="text-align: right;">
                    <span class="email-type-badge badge-pending">Pending</span>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                        {% if email.is_retry %}
                        Ready to retry
                        {% else %}
                        Ready to send
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- All Replies (Reply History) - Organized by Sequence -->
    {% if replies_by_sequence or all_replies or replied_contacts %}
    <div class="email-list">
        <h2 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.25rem;">
            ğŸ’¬ Replied Contacts - Organized by Sequence
        </h2>
        {% if replies_by_sequence %}
            {% for seq_key, seq_data in replies_by_sequence.items %}
            <div style="margin-bottom: 2rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; background: #f9fafb;">
                <h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600;">
                        Sequence: {{ seq_data.sequence_name }}
                    </span>
                    <!-- {% if seq_data.sequence %}
                    <span style="color: #6b7280; font-size: 0.875rem;">(ID: {{ seq_data.sequence.id }})</span>
                    {% endif %} -->
                </h3>
                <div>
                    {% for reply in seq_data.replies %}
                    <div class="email-item">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                <span class="email-type-badge" style="background: #d1fae5; color: #065f46;">Replied</span>
                                <strong style="color: #1f2937;">{{ reply.lead.email }}</strong>
                                {% if reply.sub_sequence %}
                                    <span class="email-type-badge" style="background: #ede9fe; color: #7c3aed; font-size: 0.75rem;">ğŸ”€ Sub-Seq Reply</span>
                                {% endif %}
                                {% if reply.interest_level == 'positive' %}
                                    <span class="email-type-badge" style="background: #d1fae5; color: #065f46;">âœ… Interested</span>
                                {% elif reply.interest_level == 'negative' %}
                                    <span class="email-type-badge" style="background: #fee2e2; color: #991b1b;">âŒ Not Interested</span>
                                {% elif reply.interest_level == 'neutral' %}
                                    <span class="email-type-badge" style="background: #f3f4f6; color: #6b7280;">â– Neutral</span>
                                {% elif reply.interest_level == 'requested_info' %}
                                    <span class="email-type-badge" style="background: #dbeafe; color: #1e40af;">ğŸ“‹ Requested Info</span>
                                {% elif reply.interest_level == 'objection' %}
                                    <span class="email-type-badge" style="background: #fef3c7; color: #92400e;">âš ï¸ Objection</span>
                                {% elif reply.interest_level == 'unsubscribe' %}
                                    <span class="email-type-badge" style="background: #fee2e2; color: #991b1b;">ğŸš« Unsubscribe</span>
                                {% endif %}
                            </div>
                            <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                                {% if reply.lead.first_name or reply.lead.last_name %}
                                    {{ reply.lead.first_name }} {{ reply.lead.last_name }}
                                {% endif %}
                                {% if reply.replied_at %}
                                    - Replied on <span class="email-sent-time" data-utc-timestamp="{{ reply.replied_at|date:"U" }}">{{ reply.replied_at|date:"M d, Y H:i" }}</span>
                                {% endif %}
                            </div>
                            {% if reply.reply_subject %}
                                <div style="color: #374151; font-size: 0.875rem; margin-top: 0.5rem; font-weight: 500;">
                                    Subject: {{ reply.reply_subject }}
                                </div>
                            {% endif %}
                            {% if reply.sub_sequence %}
                                <div style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; font-style: italic;">
                                    Reply to: {{ reply.sub_sequence.name }} (Sub-Sequence)
                                </div>
                            {% endif %}
                            {% if reply.analysis %}
                                <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem; border-left: 3px solid #10b981;">
                                    <strong>AI Analysis:</strong> {{ reply.analysis }}
                                </div>
                            {% endif %}
                        </div>
                        <div style="text-align: right;">
                            <span class="email-type-badge" style="background: #d1fae5; color: #065f46;">âœ… Replied</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        {% elif all_replies %}
            <!-- Fallback: show all replies if not organized by sequence -->
            {% for reply in all_replies %}
            <div class="email-item">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <span class="email-type-badge" style="background: #d1fae5; color: #065f46;">Replied</span>
                        <strong style="color: #1f2937;">{{ reply.lead.email }}</strong>
                        {% if reply.sequence %}
                            <span style="background: #3b82f6; color: white; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 500;">
                                Seq: {{ reply.sequence.name }}
                            </span>
                        {% endif %}
                        {% if reply.interest_level == 'positive' %}
                            <span class="email-type-badge" style="background: #d1fae5; color: #065f46;">âœ… Interested</span>
                        {% elif reply.interest_level == 'negative' %}
                            <span class="email-type-badge" style="background: #fee2e2; color: #991b1b;">âŒ Not Interested</span>
                        {% elif reply.interest_level == 'neutral' %}
                            <span class="email-type-badge" style="background: #f3f4f6; color: #6b7280;">â– Neutral</span>
                        {% elif reply.interest_level == 'requested_info' %}
                            <span class="email-type-badge" style="background: #dbeafe; color: #1e40af;">ğŸ“‹ Requested Info</span>
                        {% elif reply.interest_level == 'objection' %}
                            <span class="email-type-badge" style="background: #fef3c7; color: #92400e;">âš ï¸ Objection</span>
                        {% elif reply.interest_level == 'unsubscribe' %}
                            <span class="email-type-badge" style="background: #fee2e2; color: #991b1b;">ğŸš« Unsubscribe</span>
                        {% endif %}
                    </div>
                    <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                        {% if reply.lead.first_name or reply.lead.last_name %}
                            {{ reply.lead.first_name }} {{ reply.lead.last_name }}
                        {% endif %}
                        {% if reply.replied_at %}
                            - Replied on <span class="email-sent-time" data-utc-timestamp="{{ reply.replied_at|date:"U" }}">{{ reply.replied_at|date:"M d, Y H:i" }}</span>
                        {% endif %}
                    </div>
                    {% if reply.reply_subject %}
                        <div style="color: #374151; font-size: 0.875rem; margin-top: 0.5rem; font-weight: 500;">
                            Subject: {{ reply.reply_subject }}
                        </div>
                    {% endif %}
                    {% if reply.analysis %}
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem; border-left: 3px solid #10b981;">
                            <strong>AI Analysis:</strong> {{ reply.analysis }}
                        </div>
                    {% endif %}
                </div>
                <div style="text-align: right;">
                    <span class="email-type-badge" style="background: #d1fae5; color: #065f46;">âœ… Replied</span>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- Fallback to replied_contacts if Reply model not available yet -->
            {% for contact in replied_contacts %}
            <div class="email-item">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <span class="email-type-badge" style="background: #d1fae5; color: #065f46;">Replied</span>
                        <strong style="color: #1f2937;">{{ contact.lead.email }}</strong>
                        {% if contact.reply_interest_level == 'positive' %}
                            <span class="email-type-badge" style="background: #d1fae5; color: #065f46;">âœ… Interested</span>
                        {% elif contact.reply_interest_level == 'negative' %}
                            <span class="email-type-badge" style="background: #fee2e2; color: #991b1b;">âŒ Not Interested</span>
                        {% elif contact.reply_interest_level == 'neutral' %}
                            <span class="email-type-badge" style="background: #f3f4f6; color: #6b7280;">â– Neutral</span>
                        {% endif %}
                    </div>
                    <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                        {% if contact.lead.first_name or contact.lead.last_name %}
                            {{ contact.lead.first_name }} {{ contact.lead.last_name }}
                        {% endif %}
                        {% if contact.replied_at %}
                            - Replied on <span class="email-sent-time" data-utc-timestamp="{{ contact.replied_at|date:"U" }}">{{ contact.replied_at|date:"M d, Y H:i" }}</span>
                        {% endif %}
                    </div>
                    {% if contact.reply_subject %}
                        <div style="color: #374151; font-size: 0.875rem; margin-top: 0.5rem; font-weight: 500;">
                            Subject: {{ contact.reply_subject }}
                        </div>
                    {% endif %}
                    {% if contact.reply_analysis %}
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem; border-left: 3px solid #10b981;">
                            <strong>AI Analysis:</strong> {{ contact.reply_analysis }}
                        </div>
                    {% endif %}
                </div>
                <div style="text-align: right;">
                    <span class="email-type-badge" style="background: #d1fae5; color: #065f46;">âœ… Replied</span>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Reply Modal -->
<div id="replyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 0.75rem; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
        <h2 style="margin: 0 0 1.5rem 0; color: #1f2937; font-size: 1.5rem;">ğŸ’¬ Mark Email Reply</h2>
        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 0.5rem;">
            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Lead Email:</div>
            <div style="font-weight: 600; color: #1f2937;" id="modalLeadEmail"></div>
        </div>
        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 0.5rem;">
            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem;">Original Subject:</div>
            <div style="font-weight: 600; color: #1f2937;" id="modalOriginalSubject"></div>
        </div>
        <form id="replyForm" onsubmit="submitReply(event)">
            <input type="hidden" id="modalCampaignId">
            <input type="hidden" id="modalLeadId">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Reply Subject:</label>
                <input type="text" id="modalReplySubject" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;" placeholder="e.g., Re: Your email subject">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Reply Content:</label>
                <textarea id="modalReplyContent" rows="6" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; resize: vertical;" placeholder="Paste the full reply email content here..."></textarea>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">AI will analyze this reply to determine if the lead is interested or not.</div>
            </div>
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button type="button" onclick="closeReplyModal()" style="padding: 0.75rem 1.5rem; background: #f3f4f6; color: #374151; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
                    Cancel
                </button>
                <button type="submit" style="padding: 0.75rem 1.5rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
                    ğŸ¤– Analyze & Mark Reply
                </button>
            </div>
        </form>
        <div id="replyAnalysisResult" style="display: none; margin-top: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem; border-left: 4px solid #10b981;"></div>
    </div>
</div>

<script>
// Convert UTC times to local timezone
document.addEventListener('DOMContentLoaded', function() {
    const timeElements = document.querySelectorAll('.email-sent-time, .upcoming-time');
    timeElements.forEach(function(element) {
        const utcTimestamp = element.getAttribute('data-utc-timestamp');
        if (utcTimestamp) {
            try {
                const utcDate = new Date(parseInt(utcTimestamp) * 1000);
                
                if (isNaN(utcDate.getTime())) {
                    console.error('Invalid timestamp:', utcTimestamp);
                    return;
                }
                
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = months[utcDate.getMonth()];
                const day = String(utcDate.getDate()).padStart(2, '0');
                const year = utcDate.getFullYear();
                const hours = String(utcDate.getHours()).padStart(2, '0');
                const minutes = String(utcDate.getMinutes()).padStart(2, '0');
                
                if (element.classList.contains('upcoming-time')) {
                    element.textContent = `${month} ${day}, ${hours}:${minutes}`;
                } else {
                    element.textContent = `${month} ${day}, ${year} ${hours}:${minutes}`;
                }
            } catch (e) {
                console.error('Error converting time:', e);
            }
        }
    });
    
    // Calculate and display time remaining for upcoming emails
    function updateTimeRemaining() {
        const timeRemainingElements = document.querySelectorAll('.time-remaining');
        timeRemainingElements.forEach(function(element) {
            const sendTimestamp = element.getAttribute('data-send-timestamp');
            if (sendTimestamp) {
                try {
                    // Convert Unix timestamp (seconds) to milliseconds
                    const sendTime = new Date(parseInt(sendTimestamp) * 1000);
                    const now = new Date();
                    const diffMs = sendTime - now;
                    
                    if (diffMs <= 0) {
                        element.textContent = 'Ready to send';
                        element.style.color = '#10b981';
                        return;
                    }
                    
                    const diffSeconds = Math.floor(diffMs / 1000);
                    const diffMinutes = Math.floor(diffSeconds / 60);
                    const diffHours = Math.floor(diffMinutes / 60);
                    const diffDays = Math.floor(diffHours / 24);
                    
                    let timeStr = '';
                    if (diffDays > 0) {
                        timeStr = `${diffDays} day${diffDays > 1 ? 's' : ''}`;
                        if (diffHours % 24 > 0) {
                            timeStr += `, ${diffHours % 24} hour${(diffHours % 24) > 1 ? 's' : ''}`;
                        }
                    } else if (diffHours > 0) {
                        timeStr = `${diffHours} hour${diffHours > 1 ? 's' : ''}`;
                        if (diffMinutes % 60 > 0) {
                            timeStr += `, ${diffMinutes % 60} minute${(diffMinutes % 60) > 1 ? 's' : ''}`;
                        }
                    } else if (diffMinutes > 0) {
                        timeStr = `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''}`;
                    } else {
                        timeStr = `${diffSeconds} second${diffSeconds > 1 ? 's' : ''}`;
                    }
                    
                    element.textContent = timeStr + ' from now';
                    element.style.color = '#6b7280';
                } catch (e) {
                    console.error('Error calculating time remaining:', e);
                    element.textContent = 'Time calculation error';
                }
            }
        });
    }
    
    // Update time remaining on page load
    updateTimeRemaining();
    
    // Update time remaining every minute
    setInterval(updateTimeRemaining, 60000);
    
    // Auto-refresh every 30 seconds
    let autoRefreshInterval = setInterval(function() {
        fetch('{% url "email_status_api" campaign.id %}')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Update status indicators
                    updateStatusIndicators(data);
                }
            })
            .catch(err => console.error('Error refreshing status:', err));
    }, 30000);
    
function updateStatusIndicators(data) {
    console.log('Updating status indicators with data:', data);

    const statusCards = document.querySelectorAll('.status-card');

    // === 1ï¸âƒ£ Sequence Emails Card ===
    if (statusCards.length >= 1) {
        const sequenceCard = statusCards[0];
        const sequenceDot = sequenceCard.querySelector('.status-dot');
        const sequenceCountEl = sequenceCard.querySelector('div:nth-child(2)'); // the number div
        const sequenceStatusEl = sequenceCard.querySelector('.status-indicator + div + div'); // status text

        // Update total sent
        sequenceCountEl.textContent = data.stats.total_sequence_sent;

        // Update currently sending status
        if (data.currently_sending.sequences) {
            sequenceCard.classList.add('active');
            sequenceDot.classList.add('active');
            sequenceStatusEl.textContent = 'âœ… Currently sending';
        } else {
            sequenceCard.classList.remove('active');
            sequenceDot.classList.remove('active');
            sequenceStatusEl.textContent = 'â¸ï¸ Not sending';
        }
    }

    // === 2ï¸âƒ£ Pending Emails Card ===
    if (statusCards.length >= 2) {
        const pendingCard = statusCards[1];
        const pendingDot = pendingCard.querySelector('.status-dot');
        const pendingCountEl = pendingCard.querySelector('div:nth-child(2)'); // the number div

        const pendingCount = data.stats.pending_count;
        pendingCountEl.textContent = pendingCount;

        if (pendingCount > 0) {
            pendingCard.classList.add('pending');
            pendingDot.classList.add('active');
        } else {
            pendingCard.classList.remove('pending');
            pendingDot.classList.remove('active');
        }
    }

    // === 3ï¸âƒ£ Upcoming Emails Card ===
    if (statusCards.length >= 3) {
        const upcomingCard = statusCards[2];
        const upcomingCountEl = upcomingCard.querySelector('div:nth-child(2)'); // the number div

        const upcomingCount = data.stats.upcoming_count || 0; // make sure backend sends this
        upcomingCountEl.textContent = upcomingCount;

        const upcomingDot = upcomingCard.querySelector('.status-dot');
        if (upcomingCount > 0) {
            upcomingDot.classList.add('active');
        } else {
            upcomingDot.classList.remove('active');
        }
    }
}


    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        clearInterval(autoRefreshInterval);
    });
});

// Reply Modal Functions
function openReplyModal(campaignId, leadId, leadEmail, originalSubject) {
    document.getElementById('modalCampaignId').value = campaignId;
    document.getElementById('modalLeadId').value = leadId;
    document.getElementById('modalLeadEmail').textContent = leadEmail;
    document.getElementById('modalOriginalSubject').textContent = originalSubject;
    document.getElementById('modalReplySubject').value = 'Re: ' + originalSubject;
    document.getElementById('modalReplyContent').value = '';
    document.getElementById('replyAnalysisResult').style.display = 'none';
    document.getElementById('replyModal').style.display = 'flex';
}

function closeReplyModal() {
    document.getElementById('replyModal').style.display = 'none';
}

function submitReply(event) {
    event.preventDefault();
    
    const campaignId = document.getElementById('modalCampaignId').value;
    const leadId = document.getElementById('modalLeadId').value;
    const replySubject = document.getElementById('modalReplySubject').value;
    const replyContent = document.getElementById('modalReplyContent').value;
    
    if (!replyContent && !replySubject) {
        alert('Please enter at least a reply subject or content.');
        return;
    }
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'ğŸ¤– Analyzing...';
    
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/marketing/campaigns/${campaignId}/leads/${leadId}/mark-replied/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            reply_subject: replySubject,
            reply_content: replyContent
        })
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        
        if (data.success) {
            // Show analysis result
            const resultDiv = document.getElementById('replyAnalysisResult');
            let interestBadge = '';
            let bgColor = '#f0fdf4';
            let borderColor = '#10b981';
            
            if (data.interest_level === 'positive') {
                interestBadge = '<span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600; margin-right: 0.5rem;">âœ… POSITIVE - Lead is Interested</span>';
            } else if (data.interest_level === 'negative') {
                interestBadge = '<span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600; margin-right: 0.5rem;">âŒ NEGATIVE - Lead is Not Interested</span>';
                bgColor = '#fef2f2';
                borderColor = '#ef4444';
            } else if (data.interest_level === 'neutral') {
                interestBadge = '<span style="background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 600; margin-right: 0.5rem;">â– NEUTRAL</span>';
                bgColor = '#f9fafb';
                borderColor = '#9ca3af';
            }
            
            resultDiv.innerHTML = `
                <div style="margin-bottom: 0.75rem;">
                    ${interestBadge}
                    <strong style="color: #1f2937;">AI Analysis Complete</strong>
                </div>
                <div style="color: #374151; font-size: 0.875rem; line-height: 1.6;">
                    ${data.analysis || 'Analysis completed.'}
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <button onclick="closeReplyModal(); location.reload();" style="padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
                        âœ… Done - Refresh Page
                    </button>
                </div>
            `;
            resultDiv.style.background = bgColor;
            resultDiv.style.borderLeftColor = borderColor;
            resultDiv.style.display = 'block';
            
            // Scroll to result
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Auto-refresh page after 2 seconds to show the updated reply status
            setTimeout(function() {
                location.reload();
            }, 2000);
        } else {
            alert('Error: ' + (data.error || 'Failed to mark reply'));
        }
    })
    .catch(error => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        console.error('Error:', error);
        alert('Error submitting reply. Please try again.');
    });
}

// Close modal when clicking outside
document.getElementById('replyModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeReplyModal();
    }
});
</script>

{% endblock %}

