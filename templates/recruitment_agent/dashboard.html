{% extends 'base.html' %}
{% load static %}

{% block title %}Recruiter Dashboard - AI Recruitment{% endblock %}

{% block extra_css %}
<style>
  /* Dark Theme with Purple Accents - Matching Pay Per Project Theme */
  :root {
    --bg-dark: #0f172a;
    --bg-panel: #1e293b;
    --bg-card: #1e293b;
    --bg-card-hover: #334155;
    --text-primary: #ffffff;
    --text-secondary: #cbd5e1;
    --text-muted: #94a3b8;
    --purple-primary: #6366f1;
    --purple-secondary: #8b5cf6;
    --purple-light: #a78bfa;
    --purple-dark: #4f46e5;
    --accent-success: #10b981;
    --accent-warning: #f59e0b;
    --accent-danger: #ef4444;
    --border-color: #334155;
    --border-light: #475569;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
  }

  /* Override body and html background for dark theme */
  html {
    background: var(--bg-dark) !important;
    background-color: var(--bg-dark) !important;
    height: 100% !important;
  }

  body {
    background: var(--bg-dark) !important;
    background-color: var(--bg-dark) !important;
    background-image: none !important;
    color: var(--text-primary) !important;
    min-height: 100vh !important;
    height: 100% !important;
  }

  /* Make sure all page areas are dark */
  body > * {
    background: var(--bg-dark) !important;
  }

  /* Override navbar for dark theme */
  .navbar {
    background: var(--bg-panel) !important;
    background-color: var(--bg-panel) !important;
    border-bottom: 1px solid var(--border-color) !important;
    box-shadow: var(--shadow-md) !important;
  }

  .navbar .nav-links a {
    color: var(--text-secondary) !important;
    transition: color 0.2s ease;
  }

  .navbar .nav-links a:hover {
    color: var(--purple-light) !important;
  }

  .nav-brand {
    color: var(--text-primary) !important;
  }

  .nav-brand::before {
    background: var(--purple-primary) !important;
  }

  /* Override container backgrounds */
  .container {
    background: var(--bg-dark) !important;
    background-color: var(--bg-dark) !important;
  }

  /* Override messages container */
  .messages {
    background: var(--bg-panel) !important;
    color: var(--text-primary) !important;
  }

  /* Ensure all wrapper elements are dark */
  #wrapper,
  .wrapper,
  .main-content,
  .content-wrapper {
    background: var(--bg-dark) !important;
    background-color: var(--bg-dark) !important;
  }

  /* Override any default white backgrounds */
  div:not(.dashboard-section):not(.status-section):not(.job-item):not(.candidate-item):not(.modal-content):not(.summary-card) {
    background-color: transparent !important;
  }

  /* Override navbar buttons for dark theme */
  .navbar .btn-primary {
    background: linear-gradient(135deg, var(--purple-primary), var(--purple-secondary)) !important;
    color: white !important;
    border: none !important;
  }

  .navbar .btn-primary:hover {
    background: linear-gradient(135deg, var(--purple-dark), var(--purple-primary)) !important;
  }

  /* Override any remaining white elements */
  * {
    scrollbar-color: var(--purple-primary) var(--bg-panel);
  }

  /* Ensure no white backgrounds leak through */
  .nav-container {
    background: transparent !important;
  }

  /* Force all side areas and margins to be dark */
  body::before,
  body::after {
    background: var(--bg-dark) !important;
  }

  /* Make sure viewport background is dark */
  :root {
    background: var(--bg-dark) !important;
  }

  /* Override any potential white backgrounds from base template */
  main,
  section,
  article,
  aside {
    background: var(--bg-dark) !important;
    background-color: var(--bg-dark) !important;
  }

  /* Ensure padding/margin areas are dark */
  .dashboard-container::before,
  .dashboard-container::after {
    background: var(--bg-dark) !important;
  }

  /* Make sure the entire viewport is dark */
  html, body {
    background: var(--bg-dark) !important;
    background-color: var(--bg-dark) !important;
    background-image: none !important;
  }

  /* Ensure all page-level containers are dark */
  body > *:not(.navbar):not(.modal) {
    background: var(--bg-dark) !important;
    background-color: var(--bg-dark) !important;
  }

  /* Override any potential white backgrounds in content areas */
  #content,
  .content,
  .main,
  .page-content {
    background: var(--bg-dark) !important;
    background-color: var(--bg-dark) !important;
  }

  .dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 32px;
    min-height: calc(100vh - 80px);
    background: var(--bg-dark) !important;
    background-color: var(--bg-dark) !important;
  }

  .dashboard-header {
    margin-bottom: 48px;
    text-align: center;
    padding-bottom: 32px;
    border-bottom: 1px solid var(--border-color);
  }

  .dashboard-header h1 {
    margin: 0 0 16px 0;
    font-size: 44px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--purple-primary), var(--purple-secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.8px;
    line-height: 1.2;
  }

  .dashboard-header p {
    color: var(--text-secondary);
    font-size: 16px;
    margin: 0;
    font-weight: 400;
    letter-spacing: 0.1px;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 28px;
    margin-bottom: 36px;
  }

  .dashboard-section {
    background: var(--bg-card);
    border-radius: 20px;
    padding: 32px;
    box-shadow: var(--shadow-lg);
    border: 2px solid var(--border-color);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    margin-bottom: 0;
    isolation: isolate;
  }

  .dashboard-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--purple-primary), var(--purple-secondary));
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .dashboard-section:hover {
    border-color: var(--purple-primary);
    box-shadow: var(--shadow-xl);
    transform: translateY(-4px);
  }

  .dashboard-section:hover::before {
    opacity: 1;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
    gap: 16px;
  }

  .section-header h2 {
    margin: 0;
    font-size: 22px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 12px;
    letter-spacing: -0.3px;
    flex: 1;
  }

  .section-header h2::before {
    content: '';
    display: inline-block;
    width: 4px;
    height: 24px;
    background: linear-gradient(135deg, var(--purple-primary), var(--purple-secondary));
    border-radius: 2px;
    margin-right: -4px;
  }

  .full-width-section {
    grid-column: 1 / -1;
    margin-top: 0;
    margin-bottom: 40px;
    clear: both;
    display: block;
    width: 100%;
  }

  .full-width-section:last-child {
    margin-bottom: 0;
  }

  /* Ensure proper separation between full-width cards */
  .dashboard-section.full-width-section {
    margin-top: 0;
    margin-bottom: 40px;
    display: block;
    width: 100%;
    position: relative;
    z-index: 1;
  }

  /* Add extra spacing after dashboard-grid */
  .dashboard-grid + .dashboard-section.full-width-section {
    margin-top: 40px;
  }

  /* Ensure cards are visually separated */
  .dashboard-section.full-width-section + .dashboard-section.full-width-section {
    margin-top: 40px;
  }

  /* Settings Row Container - Flex Layout */
  .settings-row-container {
    display: flex;
    gap: 24px;
    margin-bottom: 32px;
    flex-wrap: wrap;
  }

  .settings-row-container .dashboard-section {
    flex: 1;
    min-width: 500px;
    margin-bottom: 0;
  }

  .settings-row-container .dashboard-section.full-width-section {
    grid-column: auto;
    margin-bottom: 0;
  }

  /* Form Styles - Dark Theme */
  label {
    display: block;
    margin: 20px 0 10px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
    letter-spacing: 0.1px;
  }

  label:first-child {
    margin-top: 0;
  }

  input[type="text"],
  input[type="file"],
  input[type="date"],
  input[type="time"],
  input[type="number"],
  textarea,
  select {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    font-size: 14px;
    background: var(--bg-panel);
    color: var(--text-primary);
    font-family: inherit;
    box-sizing: border-box;
    transition: all 0.2s ease;
  }

  input[type="text"]:focus,
  input[type="date"]:focus,
  input[type="time"]:focus,
  input[type="number"]:focus,
  textarea:focus,
  select:focus {
    outline: none;
    border-color: var(--purple-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    background: var(--bg-card);
  }

  input[type="text"]::placeholder,
  textarea::placeholder {
    color: var(--text-muted);
  }

  textarea {
    min-height: 120px;
    resize: vertical;
  }

  input[type="file"] {
    cursor: pointer;
    padding: 12px;
  }

  select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a78bfa' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }

  /* Buttons - Purple Gradient */
  .btn {
    background: linear-gradient(135deg, var(--purple-primary), var(--purple-secondary));
    color: #fff;
    border: none;
    padding: 12px 28px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 14px rgba(99, 102, 241, 0.35);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    letter-spacing: 0.2px;
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
  }

  .btn:hover::before {
    width: 300px;
    height: 300px;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(99, 102, 241, 0.45);
    background: linear-gradient(135deg, var(--purple-dark), var(--purple-primary));
  }

  .btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
  }

  .btn-secondary {
    background: linear-gradient(135deg, #475569, #64748b);
    box-shadow: 0 8px 20px rgba(71, 85, 105, 0.3);
  }

  .btn-secondary:hover {
    background: linear-gradient(135deg, #64748b, #475569);
    box-shadow: 0 12px 28px rgba(71, 85, 105, 0.4);
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--accent-danger), #dc2626);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
  }

  .btn-danger:hover {
    box-shadow: 0 12px 28px rgba(239, 68, 68, 0.4);
  }

  .btn-small {
    padding: 8px 16px;
    font-size: 13px;
    border-radius: 8px;
    font-weight: 600;
    letter-spacing: 0.1px;
    white-space: nowrap;
    flex-shrink: 0;
    min-width: auto;
    width: auto;
  }

  .btn:disabled {
    background: #475569;
    cursor: not-allowed;
    box-shadow: none;
    opacity: 0.6;
  }

  /* Job Description List */
  .job-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 600px;
    overflow-y: auto;
    padding-right: 8px;
  }

  .job-list::-webkit-scrollbar {
    width: 8px;
  }

  .job-list::-webkit-scrollbar-track {
    background: var(--bg-panel);
    border-radius: 4px;
  }

  .job-list::-webkit-scrollbar-thumb {
    background: var(--purple-primary);
    border-radius: 4px;
  }

  .job-item {
    background: var(--bg-panel);
    border: 1px solid var(--border-color);
    border-radius: 14px;
    padding: 22px;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 3px solid transparent;
  }

  .job-item:hover {
    border-color: var(--purple-primary);
    border-left-color: var(--purple-primary);
    background: var(--bg-card-hover);
    box-shadow: var(--shadow-md);
    transform: translateX(6px);
  }

  .job-item-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 12px;
  }

  .job-item-title {
    font-weight: 600;
    font-size: 17px;
    color: var(--text-primary);
    margin: 0 0 8px 0;
    letter-spacing: -0.2px;
  }

  .job-item-description {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 8px 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.5;
  }

  .job-item-meta {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 12px;
    font-size: 12px;
    color: var(--text-muted);
  }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.2px;
    text-transform: uppercase;
  }

  .badge-active {
    background: rgba(16, 185, 129, 0.2);
    color: var(--accent-success);
    border: 1px solid rgba(16, 185, 129, 0.3);
  }

  .badge-inactive {
    background: rgba(239, 68, 68, 0.2);
    color: var(--accent-danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .job-item-actions {
    display: flex;
    gap: 8px;
  }

  /* Candidate Status Sections */
  .candidate-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
  }

  .status-section {
    background: var(--bg-panel);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid var(--border-color);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .status-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--purple-primary), var(--purple-secondary));
    border-radius: 16px 16px 0 0;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .status-section:hover {
    border-color: var(--purple-primary);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .status-section:hover::before {
    opacity: 1;
  }

  .status-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border-color);
  }

  .status-section-title {
    font-weight: 600;
    font-size: 16px;
    margin: 0;
    color: var(--text-primary);
    letter-spacing: 0.1px;
  }

  .status-count {
    background: linear-gradient(135deg, var(--purple-primary), var(--purple-secondary));
    color: white;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
    min-width: 32px;
    text-align: center;
    letter-spacing: 0.2px;
  }

  .candidate-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 8px;
  }

  .candidate-list::-webkit-scrollbar {
    width: 6px;
  }

  .candidate-list::-webkit-scrollbar-track {
    background: var(--bg-panel);
    border-radius: 4px;
  }

  .candidate-list::-webkit-scrollbar-thumb {
    background: var(--purple-primary);
    border-radius: 4px;
  }

  .candidate-item {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 3px solid transparent;
  }

  .candidate-item:hover {
    border-color: var(--purple-primary);
    border-left-color: var(--purple-primary);
    background: var(--bg-card-hover);
    box-shadow: var(--shadow-sm);
    transform: translateX(4px);
  }

  .candidate-name {
    font-weight: 600;
    font-size: 15px;
    margin: 0 0 8px 0;
    color: var(--text-primary);
    letter-spacing: -0.1px;
  }

  .candidate-email {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0 0 6px 0;
  }

  .candidate-meta {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 8px;
    line-height: 1.5;
  }

  .interview-slot {
    background: rgba(99, 102, 241, 0.2);
    color: var(--purple-light);
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 11px;
    margin-top: 8px;
    display: inline-block;
    border: 1px solid rgba(99, 102, 241, 0.3);
  }

  /* Upload Section */
  .upload-section {
    background: var(--bg-panel);
    padding: 24px;
    border-radius: 12px;
    border: 2px dashed var(--border-light);
    margin-top: 8px;
    transition: all 0.3s ease;
    text-align: center;
  }

  .upload-section.has-file {
    border-color: var(--purple-primary);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
    border-style: solid;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
  }

  .file-info {
    margin-top: 12px;
    padding: 12px;
    background: var(--bg-card);
    border-radius: 8px;
    font-size: 12px;
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
  }

  .hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 8px;
    line-height: 1.5;
    font-style: italic;
    opacity: 0.85;
  }

  /* Modal Styles - Dark Theme */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(8px);
  }

  .modal-content {
    background-color: var(--bg-card);
    margin: 5% auto;
    padding: 32px;
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border-color);
  }

  .modal-content::-webkit-scrollbar {
    width: 8px;
  }

  .modal-content::-webkit-scrollbar-track {
    background: var(--bg-panel);
    border-radius: 4px;
  }

  .modal-content::-webkit-scrollbar-thumb {
    background: var(--purple-primary);
    border-radius: 4px;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
  }

  .modal-header h3 {
    margin: 0;
    font-size: 24px;
    color: var(--text-primary);
    font-weight: 600;
  }

  .close {
    color: var(--text-secondary);
    font-size: 32px;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    line-height: 1;
    transition: color 0.2s ease;
  }

  .close:hover {
    color: var(--text-primary);
  }

  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    justify-content: flex-end;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.6;
  }

  /* Processing Results */
  .results-summary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .summary-card {
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
  }

  .summary-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .summary-card.interview {
    background: rgba(16, 185, 129, 0.1);
    border-color: rgba(16, 185, 129, 0.3);
  }

  .summary-card.hold {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
  }

  .summary-card.reject {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
  }

  .summary-count {
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .summary-card.interview .summary-count {
    color: var(--accent-success);
  }

  .summary-card.hold .summary-count {
    color: var(--accent-warning);
  }

  .summary-card.reject .summary-count {
    color: var(--accent-danger);
  }

  .summary-label {
    font-weight: 600;
    font-size: 14px;
  }

  .summary-card.interview .summary-label {
    color: var(--accent-success);
  }

  .summary-card.hold .summary-label {
    color: var(--accent-warning);
  }

  .summary-card.reject .summary-label {
    color: var(--accent-danger);
  }

  /* Info Boxes */
  .info-box {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
    border: 1px solid rgba(99, 102, 241, 0.25);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 24px;
    border-left: 4px solid var(--purple-primary);
  }

  .info-box p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.7;
    letter-spacing: 0.1px;
  }

  /* Checkbox Styling */
  input[type="checkbox"] {
    width: 14px;
    height: 14px;
    cursor: pointer;
    accent-color: var(--purple-primary);
  }

  /* Filter Badge */
  .filter-badge {
    background: rgba(99, 102, 241, 0.2);
    border-left: 4px solid var(--purple-primary);
    padding: 12px 16px;
    margin-bottom: 20px;
    border-radius: 8px;
    color: var(--text-secondary);
  }

  .filter-badge strong {
    color: var(--text-primary);
  }

  /* Status Messages */
  #status,
  #emailSettingsStatus,
  #interviewSettingsStatus {
    font-size: 13px;
    font-weight: 500;
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .dashboard-grid {
      grid-template-columns: 1fr;
    }

    .candidate-status-grid {
      grid-template-columns: 1fr;
    }

    .results-summary {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .dashboard-container {
      padding: 20px 16px;
    }

    .dashboard-header h1 {
      font-size: 32px;
    }

    .dashboard-section {
      padding: 20px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>üìã Recruiter Dashboard</h1>
    <p>Manage CVs, job descriptions, and track candidate status</p>
  </div>

  <!-- Two Column Layout: CV Upload and Job Descriptions -->
  <div class="dashboard-grid">
    <!-- CV Upload Section -->
    <div class="dashboard-section">
        <div class="section-header">
        <h2><span style="font-size: 24px; margin-right: 4px;">üì§</span> Upload CVs</h2>
      </div>
      <form id="cv-form">
        <label>Upload CV files (multiple allowed)</label>
        <div class="upload-section" id="cvUploadSection">
          <input id="cvFiles" type="file" name="files" multiple accept=".pdf,.docx,.txt" />
          <div class="file-info" id="cvFileInfo">No files selected</div>
        </div>

        <label>Select Job Description (Optional)</label>
        <select id="jobDescriptionSelect">
          <option value="">-- Select a job description --</option>
          {% for jd in job_descriptions %}
            <option value="{{ jd.id }}" data-keywords="{{ jd.keywords_json|default:''|escape }}">{{ jd.title }}</option>
          {% endfor %}
        </select>
        <div class="hint">Select an existing job description to use for candidate evaluation</div>
        <div id="jobKeywordsDisplay" style="margin-top: 12px; display: none;">
          <strong style="color: var(--text-primary);">Extracted Keywords:</strong>
          <div id="keywordsList" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;"></div>
        </div>

        <label>Job Description Text (Alternative)</label>
        <textarea id="jobDescriptionText" placeholder="Or paste job description text here..."></textarea>

        <label>Job Keywords (Optional)</label>
        <input id="jobKeywords" type="text" placeholder="e.g., react,node,api,aws" />

        <div style="margin-top: 20px; display: flex; gap: 12px; align-items: center;">
          <button type="submit" id="submitBtn" class="btn">üöÄ Process CVs</button>
          <span id="status" class="hint"></span>
        </div>
      </form>

      <!-- Processing Results Section -->
      <div id="processingResults" style="display: none; margin-top: 28px;">
        <div class="section-header" style="margin-bottom: 20px;">
          <h3 style="margin: 0; font-size: 20px; color: var(--text-primary);">üìä Processing Results</h3>
        </div>
        
        <!-- Results Summary -->
        <div class="results-summary">
          <div class="summary-card interview">
            <div class="summary-count" id="interviewCount">0</div>
            <div class="summary-label">‚úÖ Selected for Interview</div>
          </div>
          <div class="summary-card hold">
            <div class="summary-count" id="holdCount">0</div>
            <div class="summary-label">‚è∏Ô∏è On Hold</div>
          </div>
          <div class="summary-card reject">
            <div class="summary-count" id="rejectCount">0</div>
            <div class="summary-label">‚ùå Rejected</div>
          </div>
        </div>

        <!-- Results by Category -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
          <!-- Interview Candidates -->
          <div>
            <h4 style="margin: 0 0 12px 0; color: var(--accent-success); font-size: 16px;">‚úÖ Interview</h4>
            <div id="interviewCandidates" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
          </div>
          
          <!-- Hold Candidates -->
          <div>
            <h4 style="margin: 0 0 12px 0; color: var(--accent-warning); font-size: 16px;">‚è∏Ô∏è Hold</h4>
            <div id="holdCandidates" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
          </div>
          
          <!-- Rejected Candidates -->
          <div>
            <h4 style="margin: 0 0 12px 0; color: var(--accent-danger); font-size: 16px;">‚ùå Rejected</h4>
            <div id="rejectCandidates" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Job Description Section -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2><span style="font-size: 24px; margin-right: 4px;">üìù</span> Job Descriptions</h2>
        <button class="btn btn-small" onclick="openJobDescriptionModal()">+ Add New</button>
      </div>
      <div class="job-list" id="jobDescriptionList">
        {% for jd in job_descriptions %}
        <div class="job-item" data-id="{{ jd.id }}" data-title="{{ jd.title|escape }}" data-description="{{ jd.description|escape }}" data-is-active="{{ jd.is_active|lower }}">
          <div class="job-item-header">
            <div style="flex: 1;">
              <h4 class="job-item-title">{{ jd.title }}</h4>
              <div class="job-item-description">{{ jd.description|truncatewords:30 }}</div>
            </div>
            <div class="job-item-actions">
              <button class="btn btn-small btn-secondary" onclick="editJobDescriptionFromElement(this.closest('.job-item'))">Edit</button>
              <button class="btn btn-small btn-danger" onclick="deleteJobDescription('{{ jd.id }}')">Delete</button>
            </div>
          </div>
          <div class="job-item-meta">
            <span class="badge {% if jd.is_active %}badge-active{% else %}badge-inactive{% endif %}">
              {% if jd.is_active %}Active{% else %}Inactive{% endif %}
            </span>
            <span>Created: {{ jd.created_at|date:"M d, Y" }}</span>
            {% if jd.created_by %}
            <span>By: {{ jd.created_by.username }}</span>
            {% endif %}
          </div>
        </div>
        {% empty %}
        <div class="empty-state">
          <div class="empty-state-icon">üìÑ</div>
          <p>No job descriptions yet. Click "Add New" to create one.</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Interview Settings Section -->
  <div class="dashboard-section full-width-section" id="interviewSettingsSection">
    <div class="section-header">
      <h2>üìÖ Interview Settings</h2>
      <button class="btn btn-small" onclick="toggleInterviewSettings()" id="toggleInterviewSettingsBtn">Show Settings</button>
    </div>
    <div id="interviewSettingsForm" style="display: none;">
      <div class="info-box">
        <p>
          Configure your interview scheduling preferences. Set the date range, time window, and daily capacity for interviews.
        </p>
      </div>
      
      <form id="interviewSettingsFormElement">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Date Range Settings -->
          <div>
            <h3 style="margin: 0 0 20px 0; font-size: 18px; color: var(--text-primary); border-bottom: 2px solid var(--border-color); padding-bottom: 12px; font-weight: 600;">
              üìÜ Date Range
            </h3>
            
            <label for="scheduleFromDate">
              Schedule From Date
              <span style="color: var(--text-muted); font-weight: normal; font-size: 12px;"> - Start date for scheduling interviews</span>
            </label>
            <input type="date" id="scheduleFromDate" name="schedule_from_date" />
            <div class="hint">Leave empty to start from today. Format: YYYY-MM-DD</div>
            
            <label for="scheduleToDate" style="margin-top: 20px;">
              Schedule To Date
              <span style="color: var(--text-muted); font-weight: normal; font-size: 12px;"> - End date for scheduling interviews</span>
            </label>
            <input type="date" id="scheduleToDate" name="schedule_to_date" />
            <div class="hint">Leave empty for no end date. Format: YYYY-MM-DD</div>
          </div>
          
          <!-- Time Range and Gap Settings -->
          <div>
            <h3 style="margin: 0 0 20px 0; font-size: 18px; color: var(--text-primary); border-bottom: 2px solid var(--border-color); padding-bottom: 12px; font-weight: 600;">
              ‚è∞ Time Range & Gap
            </h3>
            
            <label for="interviewTimeGap">
              Interview Time Gap
              <span style="color: var(--text-muted); font-weight: normal; font-size: 12px;"> - Time gap between interview slots in minutes</span>
            </label>
            <input type="number" id="interviewTimeGap" name="interview_time_gap" min="15" max="120" step="15" value="30" required />
            <div class="hint">Default: 30 minutes. Common values: 15, 30, 45, 60 minutes</div>
            
            <label for="startTime" style="margin-top: 20px;">
              Start Time
              <span style="color: var(--text-muted); font-weight: normal; font-size: 12px;"> - Daily start time for interviews</span>
            </label>
            <input type="time" id="startTime" name="start_time" value="09:00" required />
            <div class="hint">Default: 09:00 (9 AM). Format: HH:MM (24-hour)</div>
            
            <label for="endTime" style="margin-top: 20px;">
              End Time
              <span style="color: var(--text-muted); font-weight: normal; font-size: 12px;"> - Daily end time for interviews</span>
            </label>
            <input type="time" id="endTime" name="end_time" value="17:00" required />
            <div class="hint">Default: 17:00 (5 PM). Format: HH:MM (24-hour)</div>
          </div>
        </div>
        
        <div style="margin-top: 28px; display: flex; gap: 12px; align-items: center;">
          <button type="submit" class="btn" id="saveInterviewSettingsBtn">üíæ Create Time Slots</button>
          <button type="button" class="btn btn-secondary" onclick="loadInterviewSettings()">üîÑ Reset to Current</button>
          <span id="interviewSettingsStatus" class="hint"></span>
        </div>
      </form>
      
      <!-- Time Slots Grid Display -->
      <div id="timeSlotsGridContainer" style="display: none; margin-top: 32px;">
        <div class="section-header">
          <h3 style="margin: 0; font-size: 20px; color: var(--text-primary);">üìÖ Generated Time Slots</h3>
          <button class="btn btn-small" onclick="updateTimeSlotAvailability()" id="updateTimeSlotsBtn" style="display: none;">üíæ Update Availability</button>
        </div>
        <div id="timeSlotsGrid" style="margin-top: 24px;">
          <!-- Time slots grid will be generated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Email Settings Section -->
  <div class="dashboard-section full-width-section" id="emailSettingsSection">
    <div class="section-header">
      <h2><span style="font-size: 24px; margin-right: 4px;">‚öôÔ∏è</span> Email Settings</h2>
      <button class="btn btn-small" onclick="toggleEmailSettings()" id="toggleEmailSettingsBtn">Show Settings</button>
    </div>
    <div id="emailSettingsForm" style="display: none;">
      <div class="info-box">
        <p>
          Configure your email timing preferences. These settings will be applied to all new interviews you create.
        </p>
      </div>
      
      <form id="emailSettingsFormElement">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Follow-up Settings -->
          <div>
            <h3 style="margin: 0 0 20px 0; font-size: 18px; color: var(--text-primary); border-bottom: 2px solid var(--border-color); padding-bottom: 12px; font-weight: 600;">
              üìß Follow-up Email Settings (PENDING Interviews)
            </h3>
            
            <label for="followupDelayHours">
              Follow-up Delay (Hours)
              <span style="color: var(--text-muted); font-weight: normal; font-size: 12px;"> - Hours before sending first follow-up email (0.1 = 6 min)</span>
            </label>
            <input type="number" id="followupDelayHours" name="followup_delay_hours" min="0.1" max="168" step="0.1" value="48" required />
            <div class="hint">Default: 48 hours (2 days). Use 0.1 for 6 minutes, 0.5 for 30 minutes</div>
            
            <label for="minHoursBetweenFollowups" style="margin-top: 20px;">
              Minimum Hours Between Follow-ups
              <span style="color: var(--text-muted); font-weight: normal; font-size: 12px;"> - Minimum gap between follow-up emails (0.1 = 6 min)</span>
            </label>
            <input type="number" id="minHoursBetweenFollowups" name="min_hours_between_followups" min="0.1" max="72" step="0.1" value="24" required />
            <div class="hint">Default: 24 hours. Use 0.1 for 6 minutes</div>
            
            <label for="maxFollowupEmails" style="margin-top: 20px;">
              Maximum Follow-up Emails
              <span style="color: var(--text-muted); font-weight: normal; font-size: 12px;"> - Maximum number of follow-up emails to send</span>
            </label>
            <input type="number" id="maxFollowupEmails" name="max_followup_emails" min="1" max="10" value="3" required />
            <div class="hint">Default: 3 emails</div>
          </div>
          
          <!-- Reminder Settings -->
          <div>
            <h3 style="margin: 0 0 20px 0; font-size: 18px; color: var(--text-primary); border-bottom: 2px solid var(--border-color); padding-bottom: 12px; font-weight: 600;">
              üîî Reminder Email Settings (SCHEDULED Interviews)
            </h3>
            
            <label for="reminderHoursBefore">
              Reminder Hours Before Interview
              <span style="color: var(--text-muted); font-weight: normal; font-size: 12px;"> - Hours before interview to send reminder (0.5 = 30 min)</span>
            </label>
            <input type="number" id="reminderHoursBefore" name="reminder_hours_before" min="0.1" max="168" step="0.1" value="24" required />
            <div class="hint">Default: 24 hours (1 day before). Use 0.5 for 30 minutes</div>
            
            <div style="margin-top: 24px; padding: 20px; background: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border-color);">
              <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; color: var(--text-primary);">
                <input type="checkbox" id="autoSendFollowups" name="auto_send_followups" checked />
                <span>Automatically send follow-up emails</span>
              </label>
              <div class="hint" style="margin-top: 8px; margin-left: 32px;">If unchecked, you'll need to send follow-ups manually</div>
            </div>
            
            <div style="margin-top: 16px; padding: 20px; background: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border-color);">
              <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; color: var(--text-primary);">
                <input type="checkbox" id="autoSendReminders" name="auto_send_reminders" checked />
                <span>Automatically send reminder emails</span>
              </label>
              <div class="hint" style="margin-top: 8px; margin-left: 32px;">If unchecked, you'll need to send reminders manually</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 28px; display: flex; gap: 12px; align-items: center;">
          <button type="submit" class="btn" id="saveEmailSettingsBtn">üíæ Save Email Settings</button>
          <button type="button" class="btn btn-secondary" onclick="loadEmailSettings()">üîÑ Reset to Current</button>
          <span id="emailSettingsStatus" class="hint"></span>
        </div>
      </form>
      
      <!-- Time Slots Display in Email Settings -->
      <div id="emailTimeSlotsGridContainer" style="display: none; margin-top: 32px;">
        <div class="section-header">
          <h3 style="margin: 0; font-size: 20px; color: var(--text-primary);">üìÖ Available Interview Time Slots</h3>
        </div>
        <div id="emailTimeSlotsGrid" style="margin-top: 24px;">
          <!-- Time slots grid will be loaded from database here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Candidate Status Section (Full Width) -->
  <div class="dashboard-section full-width-section">
    <div class="section-header">
      <h2>üë• Candidate Status</h2>
      <div style="display: flex; gap: 12px; align-items: center;">
        <label for="statusJobFilter" style="margin: 0; font-weight: 500; font-size: 14px; color: var(--text-secondary);">Filter by Job:</label>
        <select id="statusJobFilter" onchange="filterByJob(this.value)">
          <option value="">-- All Jobs --</option>
          {% for jd in job_descriptions %}
            <option value="{{ jd.id }}" {% if filter_job and filter_job.id == jd.id %}selected{% endif %}>{{ jd.title }}</option>
          {% endfor %}
        </select>
        {% if filter_job %}
        <button class="btn btn-small btn-secondary" onclick="filterByJob('')">Clear Filter</button>
        {% endif %}
      </div>
    </div>
    {% if filter_job %}
    <div class="filter-badge">
      <strong>üìå Filtered by:</strong> {{ filter_job.title }}
    </div>
    {% endif %}
    <div class="candidate-status-grid">
      <!-- Selected for Interview -->
      <div class="status-section">
        <div class="status-section-header">
          <h3 class="status-section-title">‚úÖ Selected for Interview</h3>
          <span class="status-count">{{ selected_for_interview|length }}</span>
        </div>
        <div class="candidate-list">
          {% for candidate_info in selected_for_interview %}
          <div class="candidate-item">
            <div class="candidate-name">{{ candidate_info.name }}</div>
            {% if candidate_info.email %}
            <div class="candidate-email">{{ candidate_info.email }}</div>
            {% endif %}
            <div class="candidate-meta">
              Score: {{ candidate_info.cv_record.role_fit_score|default:"N/A" }} | 
              Decision: <strong>{{ candidate_info.cv_record.qualification_decision|default:"N/A" }}</strong>
            </div>
          </div>
          {% empty %}
          <div class="empty-state">
            <p>No candidates selected for interview yet</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Interview Email Sent -->
      <div class="status-section">
        <div class="status-section-header">
          <h3 class="status-section-title">üìß Interview Email Sent</h3>
          <span class="status-count">{{ interview_email_sent|length }}</span>
        </div>
        <div class="candidate-list">
          {% for interview in interview_email_sent %}
          <div class="candidate-item">
            <div class="candidate-name">{{ interview.candidate_name }}</div>
            <div class="candidate-email">{{ interview.candidate_email }}</div>
            <div class="candidate-meta">
              Role: {{ interview.job_role }}<br>
              Status: <strong>{{ interview.get_status_display }}</strong><br>
              Sent: {{ interview.invitation_sent_at|date:"M d, Y H:i" }}
            </div>
            {% if interview.selected_slot %}
            <div class="interview-slot">Slot: {{ interview.selected_slot }}</div>
            {% endif %}
          </div>
          {% empty %}
          <div class="empty-state">
            <p>No interview emails sent yet</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Scheduled Interviews -->
      <div class="status-section">
        <div class="status-section-header">
          <h3 class="status-section-title">üìÖ Scheduled Interviews</h3>
          <span class="status-count">{{ interviews_by_status.SCHEDULED|length }}</span>
        </div>
        <div class="candidate-list">
          {% for interview in interviews_by_status.SCHEDULED %}
          <div class="candidate-item">
            <div class="candidate-name">{{ interview.candidate_name }}</div>
            <div class="candidate-email">{{ interview.candidate_email }}</div>
            <div class="candidate-meta">
              Role: {{ interview.job_role }}<br>
              {% if interview.scheduled_datetime %}
              Scheduled: <strong>{{ interview.scheduled_datetime|date:"M d, Y H:i" }}</strong>
              {% endif %}
            </div>
          </div>
          {% empty %}
          <div class="empty-state">
            <p>No scheduled interviews</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Pending Interviews -->
      <div class="status-section">
        <div class="status-section-header">
          <h3 class="status-section-title">‚è≥ Pending Confirmation</h3>
          <span class="status-count">{{ interviews_by_status.PENDING|length }}</span>
        </div>
        <div class="candidate-list">
          {% for interview in interviews_by_status.PENDING %}
          <div class="candidate-item">
            <div class="candidate-name">{{ interview.candidate_name }}</div>
            <div class="candidate-email">{{ interview.candidate_email }}</div>
            <div class="candidate-meta">
              Role: {{ interview.job_role }}<br>
              Awaiting candidate slot selection
            </div>
          </div>
          {% empty %}
          <div class="empty-state">
            <p>No pending interviews</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Job Description Modal -->
<div id="jobDescriptionModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Add Job Description</h3>
      <button class="close" onclick="closeJobDescriptionModal()">&times;</button>
    </div>
    <form id="jobDescriptionForm">
      <input type="hidden" id="jobDescriptionId" value="">
      <label>Job Title *</label>
      <input type="text" id="jobTitle" required />

      <label>Job Description *</label>
      <textarea id="jobDescriptionTextModal" required></textarea>
      <div class="hint">The full job description text. Keywords will be automatically extracted.</div>

      <label style="display: flex; align-items: center; gap: 12px; margin-top: 20px; color: var(--text-primary); cursor: pointer;">
        <input type="checkbox" id="jobIsActive" checked />
        <span>Active (currently being used)</span>
      </label>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeJobDescriptionModal()">Cancel</button>
        <button type="submit" class="btn">Save Job Description</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  // Job Description Modal
  function openJobDescriptionModal() {
    document.getElementById('jobDescriptionModal').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Add Job Description';
    document.getElementById('jobDescriptionForm').reset();
    document.getElementById('jobDescriptionId').value = '';
  }

  function closeJobDescriptionModal() {
    document.getElementById('jobDescriptionModal').style.display = 'none';
  }

  function editJobDescription(id, title, description, isActive) {
    document.getElementById('jobDescriptionModal').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Edit Job Description';
    document.getElementById('jobDescriptionId').value = id;
    document.getElementById('jobTitle').value = title;
    document.getElementById('jobDescriptionTextModal').value = description;
    document.getElementById('jobIsActive').checked = isActive === true || isActive === 'true';
  }

  function editJobDescriptionFromElement(element) {
    const id = element.getAttribute('data-id');
    const title = element.getAttribute('data-title');
    const description = element.getAttribute('data-description');
    const isActive = element.getAttribute('data-is-active') === 'true';
    editJobDescription(id, title, description, isActive);
  }

  // Job Description Form Submit
  document.getElementById('jobDescriptionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('jobDescriptionId').value;
    const title = document.getElementById('jobTitle').value;
    const description = document.getElementById('jobDescriptionTextModal').value;
    const isActive = document.getElementById('jobIsActive').checked;

    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('is_active', isActive);
    formData.append('parse_keywords', 'true');

    try {
      let response;
      if (id) {
        response = await fetch(`{% url 'update_job_description' 0 %}`.replace('0', id), {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': csrftoken
          }
        });
      } else {
        response = await fetch('{% url "create_job_description" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': csrftoken
          }
        });
      }

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to save job description');
      }

      window.location.reload();
    } catch (error) {
      alert('Error: ' + error.message);
    }
  });

  // Delete Job Description
  async function deleteJobDescription(id) {
    if (!confirm('Are you sure you want to delete this job description?')) {
      return;
    }

    try {
      const response = await fetch(`{% url 'delete_job_description' 0 %}`.replace('0', id), {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken
        }
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to delete job description');
      }

      window.location.reload();
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  // Job Description Selection - Show Keywords
  const jobDescriptionSelect = document.getElementById('jobDescriptionSelect');
  const jobKeywordsDisplay = document.getElementById('jobKeywordsDisplay');
  const keywordsList = document.getElementById('keywordsList');

  jobDescriptionSelect.addEventListener('change', (e) => {
    const selectedOption = e.target.options[e.target.selectedIndex];
    const keywordsJson = selectedOption.getAttribute('data-keywords');
    
    if (keywordsJson && keywordsJson.trim()) {
      try {
        const keywordsData = JSON.parse(keywordsJson);
        const keywords = keywordsData.keywords || [];
        
        if (keywords.length > 0) {
          keywordsList.innerHTML = keywords.map(kw => 
            `<span style="background: rgba(99, 102, 241, 0.2); color: var(--purple-light); padding: 6px 12px; border-radius: 20px; font-size: 12px; border: 1px solid rgba(99, 102, 241, 0.3);">${kw}</span>`
          ).join('');
          jobKeywordsDisplay.style.display = 'block';
        } else {
          jobKeywordsDisplay.style.display = 'none';
        }
      } catch (err) {
        console.error('Error parsing keywords:', err);
        jobKeywordsDisplay.style.display = 'none';
      }
    } else {
      jobKeywordsDisplay.style.display = 'none';
    }
  });

  // CV File Upload Handling
  const cvFileInput = document.getElementById('cvFiles');
  const cvFileInfo = document.getElementById('cvFileInfo');
  const cvUploadSection = document.getElementById('cvUploadSection');

  cvFileInput.addEventListener('change', (e) => {
    const files = e.target.files;
    if (files.length > 0) {
      const fileNames = Array.from(files).map(f => f.name).join(', ');
      cvFileInfo.textContent = `${files.length} file(s) selected: ${fileNames}`;
      cvUploadSection.classList.add('has-file');
    } else {
      cvFileInfo.textContent = 'No files selected';
      cvUploadSection.classList.remove('has-file');
    }
  });

  // CV Form Submit
  document.getElementById('cv-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const files = cvFileInput.files;
    if (!files.length) {
      alert('Please select at least one CV file.');
      return;
    }

    const jobDescriptionId = document.getElementById('jobDescriptionSelect').value;
    const jobDescriptionText = document.getElementById('jobDescriptionText').value.trim();
    const jobKeywords = document.getElementById('jobKeywords').value;

    const fd = new FormData();
    Array.from(files).forEach((f) => fd.append('files', f));
    
    if (jobDescriptionId) {
      fd.append('job_description_id', jobDescriptionId);
    }
    if (jobDescriptionText) {
      fd.append('job_description_text', jobDescriptionText);
    }
    if (jobKeywords) {
      fd.append('job_keywords', jobKeywords);
    }

    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const processingResults = document.getElementById('processingResults');
    
    submitBtn.disabled = true;
    statusEl.textContent = 'Processing...';
    statusEl.style.color = 'var(--text-secondary)';
    processingResults.style.display = 'none';

    try {
      const res = await fetch('{% url "recruitment_process_cvs" %}', {
        method: 'POST',
        body: fd,
        headers: {
          'X-CSRFToken': csrftoken
        }
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || 'Request failed');
      }

      const data = await res.json();
      statusEl.textContent = `‚úÖ Processed ${data.length} CV(s) successfully!`;
      statusEl.style.color = 'var(--accent-success)';
      
      displayProcessingResults(data);
      processingResults.style.display = 'block';
      processingResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
    } catch (err) {
      statusEl.textContent = '‚ùå Error: ' + err.message;
      statusEl.style.color = 'var(--accent-danger)';
      alert('Error processing CVs: ' + err.message);
    } finally {
      submitBtn.disabled = false;
    }
  });

  // Function to display processing results
  function displayProcessingResults(data) {
    const interviewCandidates = document.getElementById('interviewCandidates');
    const holdCandidates = document.getElementById('holdCandidates');
    const rejectCandidates = document.getElementById('rejectCandidates');
    const interviewCount = document.getElementById('interviewCount');
    const holdCount = document.getElementById('holdCount');
    const rejectCount = document.getElementById('rejectCount');
    
    interviewCandidates.innerHTML = '';
    holdCandidates.innerHTML = '';
    rejectCandidates.innerHTML = '';
    
    let interviewCountVal = 0;
    let holdCountVal = 0;
    let rejectCountVal = 0;
    
    data.forEach((item, index) => {
      const parsed = item.parsed || item.data || {};
      const qualification = item.qualification || {};
      const insights = item.insights || {};
      
      const candidateName = parsed.name || parsed.email || item.file || `Candidate ${index + 1}`;
      const candidateEmail = parsed.email || 'No email';
      const decision = qualification.decision || 'PENDING';
      const score = insights.role_fit_score ?? 'N/A';
      const confidence = qualification.confidence_score ?? 'N/A';
      const matchedSkills = qualification.matched_skills || [];
      
      const candidateCard = `
        <div class="candidate-item">
          <div class="candidate-name">${candidateName}</div>
          <div class="candidate-email">${candidateEmail}</div>
          <div class="candidate-meta">
            Score: ${score} | Confidence: ${confidence}%<br>
            Matched: ${matchedSkills.length} skills
            ${item.rank ? `| Rank: #${item.rank}` : ''}
          </div>
        </div>
      `;
      
      if (decision === 'INTERVIEW') {
        interviewCandidates.innerHTML += candidateCard;
        interviewCountVal++;
      } else if (decision === 'HOLD') {
        holdCandidates.innerHTML += candidateCard;
        holdCountVal++;
      } else if (decision === 'REJECT') {
        rejectCandidates.innerHTML += candidateCard;
        rejectCountVal++;
      }
    });
    
    interviewCount.textContent = interviewCountVal;
    holdCount.textContent = holdCountVal;
    rejectCount.textContent = rejectCountVal;
    
    if (interviewCountVal === 0) {
      interviewCandidates.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">No candidates selected for interview</div>';
    }
    if (holdCountVal === 0) {
      holdCandidates.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">No candidates on hold</div>';
    }
    if (rejectCountVal === 0) {
      rejectCandidates.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">No candidates rejected</div>';
    }
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('jobDescriptionModal');
    if (event.target == modal) {
      closeJobDescriptionModal();
    }
  }

  // Filter by Job Description
  function filterByJob(jobId) {
    const url = new URL(window.location.href);
    if (jobId) {
      url.searchParams.set('filter_job_id', jobId);
    } else {
      url.searchParams.delete('filter_job_id');
    }
    window.location.href = url.toString();
  }

  // Email Settings Functions
  function toggleEmailSettings() {
    const form = document.getElementById('emailSettingsForm');
    const btn = document.getElementById('toggleEmailSettingsBtn');
    if (form.style.display === 'none') {
      form.style.display = 'block';
      btn.textContent = 'Hide Settings';
      loadEmailSettings();
    } else {
      form.style.display = 'none';
      btn.textContent = 'Show Settings';
    }
  }

  async function loadEmailSettings() {
    try {
      const response = await fetch('{% url "recruiter_email_settings" %}', {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      if (!response.ok) {
        throw new Error('Failed to load settings');
      }
      
      const data = await response.json();
      if (data.success && data.settings) {
        const settings = data.settings;
        document.getElementById('followupDelayHours').value = settings.followup_delay_hours || 48;
        document.getElementById('minHoursBetweenFollowups').value = settings.min_hours_between_followups || 24;
        document.getElementById('maxFollowupEmails').value = settings.max_followup_emails || 3;
        document.getElementById('reminderHoursBefore').value = settings.reminder_hours_before || 24;
        document.getElementById('autoSendFollowups').checked = settings.auto_send_followups !== false;
        document.getElementById('autoSendReminders').checked = settings.auto_send_reminders !== false;
        
        // Load and display time slots from interview settings
        loadInterviewTimeSlotsForEmailSettings();
      }
    } catch (error) {
      console.error('Error loading email settings:', error);
    }
  }

  // Function to load interview time slots for email settings section
  async function loadInterviewTimeSlotsForEmailSettings() {
    try {
      const response = await fetch('{% url "recruiter_interview_settings" %}', {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      if (!response.ok) {
        throw new Error('Failed to load interview settings');
      }
      
      const data = await response.json();
      if (data.success && data.settings && data.settings.time_slots && data.settings.time_slots.length > 0) {
        const container = document.getElementById('emailTimeSlotsGrid');
        const gridContainer = document.getElementById('emailTimeSlotsGridContainer');
        
        if (container && gridContainer) {
          // Use the same display function but with different container IDs
          displayTimeSlotsFromDatabaseForEmail(
            data.settings.time_slots,
            data.settings.schedule_from_date,
            data.settings.schedule_to_date
          );
          gridContainer.style.display = 'block';
        }
      } else {
        const gridContainer = document.getElementById('emailTimeSlotsGridContainer');
        if (gridContainer) {
          gridContainer.style.display = 'none';
        }
      }
    } catch (error) {
      console.error('Error loading interview time slots for email settings:', error);
    }
  }

  // Function to display time slots in email settings section
  function displayTimeSlotsFromDatabaseForEmail(timeSlots, fromDate, toDate) {
    if (!timeSlots || timeSlots.length === 0 || !fromDate || !toDate) {
      const gridContainer = document.getElementById('emailTimeSlotsGridContainer');
      if (gridContainer) {
        gridContainer.style.display = 'none';
      }
      return;
    }

    const container = document.getElementById('emailTimeSlotsGrid');
    if (!container) return;

    // Use the same logic as displayTimeSlotsFromDatabase but with emailTimeSlotsGrid container
    displayTimeSlotsFromDatabase(timeSlots, fromDate, toDate);
    
    // Copy the generated HTML to email settings container
    const interviewContainer = document.getElementById('timeSlotsGrid');
    if (interviewContainer && interviewContainer.innerHTML) {
      container.innerHTML = interviewContainer.innerHTML;
    }
  }

  document.getElementById('emailSettingsFormElement').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('saveEmailSettingsBtn');
    const status = document.getElementById('emailSettingsStatus');
    
    btn.disabled = true;
    status.textContent = 'Saving...';
    status.style.color = 'var(--text-secondary)';
    
    const settings = {
      followup_delay_hours: parseFloat(document.getElementById('followupDelayHours').value),
      min_hours_between_followups: parseFloat(document.getElementById('minHoursBetweenFollowups').value),
      max_followup_emails: parseInt(document.getElementById('maxFollowupEmails').value),
      reminder_hours_before: parseFloat(document.getElementById('reminderHoursBefore').value),
      auto_send_followups: document.getElementById('autoSendFollowups').checked,
      auto_send_reminders: document.getElementById('autoSendReminders').checked
    };
    
    try {
      const response = await fetch('{% url "recruiter_email_settings" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settings)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to save settings');
      }
      
      const data = await response.json();
      if (data.success) {
        status.textContent = '‚úÖ Settings saved successfully!';
        status.style.color = 'var(--accent-success)';
        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      } else {
        throw new Error(data.error || 'Failed to save settings');
      }
    } catch (error) {
      status.textContent = '‚ùå Error: ' + error.message;
      status.style.color = 'var(--accent-danger)';
      alert('Error saving email settings: ' + error.message);
    } finally {
      btn.disabled = false;
    }
  });

  // Interview Settings Functions
  function toggleInterviewSettings() {
    const form = document.getElementById('interviewSettingsForm');
    const btn = document.getElementById('toggleInterviewSettingsBtn');
    if (form.style.display === 'none') {
      form.style.display = 'block';
      btn.textContent = 'Hide Settings';
      loadInterviewSettings();
    } else {
      form.style.display = 'none';
      btn.textContent = 'Show Settings';
    }
  }

  async function loadInterviewSettings() {
    try {
      const response = await fetch('{% url "recruiter_interview_settings" %}', {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      if (!response.ok) {
        throw new Error('Failed to load settings');
      }
      
      const data = await response.json();
      if (data.success && data.settings) {
        const settings = data.settings;
        document.getElementById('scheduleFromDate').value = settings.schedule_from_date || '';
        document.getElementById('scheduleToDate').value = settings.schedule_to_date || '';
        document.getElementById('startTime').value = settings.start_time || '09:00';
        document.getElementById('endTime').value = settings.end_time || '17:00';
        document.getElementById('interviewTimeGap').value = settings.interview_time_gap || 30;
        
        // Load and display time slots from database
        if (settings.time_slots && settings.time_slots.length > 0) {
          displayTimeSlotsFromDatabase(settings.time_slots, settings.schedule_from_date, settings.schedule_to_date);
        } else if (settings.schedule_from_date && settings.schedule_to_date) {
          // Generate grid if dates exist but no slots
          generateTimeSlotsGrid(settings.schedule_from_date, settings.schedule_to_date, settings.start_time, settings.end_time, settings.interview_time_gap);
        }
      }
    } catch (error) {
      console.error('Error loading interview settings:', error);
    }
  }

  document.getElementById('interviewSettingsFormElement').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('saveInterviewSettingsBtn');
    const status = document.getElementById('interviewSettingsStatus');
    
    btn.disabled = true;
    status.textContent = 'Saving...';
    status.style.color = 'var(--text-secondary)';
    
    const scheduleFromDate = document.getElementById('scheduleFromDate').value || null;
    const scheduleToDate = document.getElementById('scheduleToDate').value || null;
    const startTime = document.getElementById('startTime').value || '09:00';
    const endTime = document.getElementById('endTime').value || '17:00';
    const interviewTimeGap = parseInt(document.getElementById('interviewTimeGap').value) || 30;
    
    if (scheduleFromDate && scheduleToDate) {
      if (new Date(scheduleFromDate) > new Date(scheduleToDate)) {
        status.textContent = '‚ùå Error: Start date cannot be after end date';
        status.style.color = 'var(--accent-danger)';
        btn.disabled = false;
        return;
      }
    }
    
    if (startTime >= endTime) {
      status.textContent = '‚ùå Error: Start time must be before end time';
      status.style.color = 'var(--accent-danger)';
      btn.disabled = false;
      return;
    }
    
    const settings = {
      schedule_from_date: scheduleFromDate,
      schedule_to_date: scheduleToDate,
      start_time: startTime,
      end_time: endTime,
      interview_time_gap: interviewTimeGap
    };
    
    try {
      const response = await fetch('{% url "recruiter_interview_settings" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settings)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to save settings');
      }
      
      const data = await response.json();
      if (data.success) {
        status.textContent = '‚úÖ Settings saved successfully!';
        status.style.color = 'var(--accent-success)';
        
        // Display time slots from database response
        if (data.settings && data.settings.time_slots && data.settings.time_slots.length > 0) {
          displayTimeSlotsFromDatabase(data.settings.time_slots, scheduleFromDate, scheduleToDate);
        } else if (scheduleFromDate && scheduleToDate) {
          // Fallback: generate grid if no slots in response
          generateTimeSlotsGrid(scheduleFromDate, scheduleToDate, startTime, endTime, interviewTimeGap);
        }
        
        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      } else {
        throw new Error(data.error || 'Failed to save settings');
      }
    } catch (error) {
      status.textContent = '‚ùå Error: ' + error.message;
      status.style.color = 'var(--accent-danger)';
      alert('Error saving interview settings: ' + error.message);
    } finally {
      btn.disabled = false;
    }
  });

  // Function to generate time slots grid
  function generateTimeSlotsGrid(fromDate, toDate, startTime, endTime, gapMinutes) {
    if (!fromDate || !toDate) {
      document.getElementById('timeSlotsGridContainer').style.display = 'none';
      return;
    }

    const container = document.getElementById('timeSlotsGrid');
    const gridContainer = document.getElementById('timeSlotsGridContainer');
    container.innerHTML = '';

    // Parse dates - ensure proper date handling
    const startDate = new Date(fromDate + 'T00:00:00');
    const endDate = new Date(toDate + 'T00:00:00');
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(0, 0, 0, 0);
    
    // Parse times
    const [startHour, startMin] = startTime.split(':').map(Number);
    const [endHour, endMin] = endTime.split(':').map(Number);
    const startMinutes = startHour * 60 + startMin;
    const endMinutes = endHour * 60 + endMin;

    // Generate dates array - include all dates from start to end (inclusive)
    const dates = [];
    const currentDate = new Date(startDate);
    currentDate.setHours(0, 0, 0, 0);
    while (currentDate <= endDate) {
      dates.push(new Date(currentDate));
      currentDate.setDate(currentDate.getDate() + 1);
    }

    // Set CSS variable for number of dates
    document.documentElement.style.setProperty('--num-dates', dates.length);

    // Generate time slots
    const timeSlots = [];
    for (let minutes = startMinutes; minutes < endMinutes; minutes += gapMinutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      const timeStr = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
      const displayTime = formatTime(hours, mins);
      timeSlots.push({ time: timeStr, display: displayTime });
    }

    // Create grid HTML
    let gridHTML = '<div class="time-slots-grid-wrapper">';
    gridHTML += '<div class="time-slots-calendar">';
    gridHTML += '<div class="calendar-header">';
    gridHTML += '<button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">‚Äπ</button>';
    gridHTML += `<div class="calendar-month-year">${formatMonthYear(startDate)}</div>`;
    gridHTML += '<button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">‚Ä∫</button>';
    gridHTML += '</div>';
    gridHTML += '<div class="calendar-days-header">S M T W T F S</div>';
    gridHTML += '<div class="calendar-dates" id="calendarDates"></div>';
    gridHTML += '</div>';

    gridHTML += '<div class="time-slots-columns">';
    gridHTML += '<div class="time-slots-header-row">';
    gridHTML += '<div class="time-slot-row-header"></div>';
    dates.forEach(date => {
      const dayName = date.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
      const dayNum = date.getDate();
      const isSelected = date.toDateString() === startDate.toDateString();
      gridHTML += `<div class="time-slot-column-header ${isSelected ? 'selected' : ''}">${dayName} ${dayNum}</div>`;
    });
    gridHTML += '</div>';

    timeSlots.forEach(slot => {
      gridHTML += '<div class="time-slots-row">';
      gridHTML += `<div class="time-slot-row-label">${slot.display}</div>`;
      dates.forEach(date => {
        const dateStr = date.toISOString().split('T')[0];
        const datetimeStr = `${dateStr}T${slot.time}`;
        gridHTML += `<div class="time-slot-cell-wrapper">
          <div class="time-slot-cell">
            <input type="checkbox" class="time-slot-checkbox" data-datetime="${datetimeStr}" checked />
            <span class="time-slot-text">${slot.display}</span>
          </div>
        </div>`;
      });
      gridHTML += '</div>';
    });
    gridHTML += '</div>';
    gridHTML += '</div>';

    container.innerHTML = gridHTML;
    gridContainer.style.display = 'block';
    showUpdateButton();

    // Generate calendar dates
    generateCalendarDates(startDate, dates);
  }

  function formatTime(hours, mins) {
    const period = hours >= 12 ? 'pm' : 'am';
    const displayHour = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
    return `${displayHour}:${mins.toString().padStart(2, '0')}${period}`;
  }

  function formatMonthYear(date) {
    return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  }

  function generateCalendarDates(selectedDate, availableDates) {
    const container = document.getElementById('calendarDates');
    if (!container) return;

    const year = selectedDate.getFullYear();
    const month = selectedDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    let html = '';
    
    // Empty cells for days before month starts
    for (let i = 0; i < startDay; i++) {
      html += '<div class="calendar-date empty"></div>';
    }

    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dateStr = date.toISOString().split('T')[0];
      const isAvailable = availableDates.some(d => d.toISOString().split('T')[0] === dateStr);
      const isSelected = date.toDateString() === selectedDate.toDateString();
      
      html += `<div class="calendar-date ${isAvailable ? 'available' : ''} ${isSelected ? 'selected' : ''}" data-date="${dateStr}">${day}</div>`;
    }

    container.innerHTML = html;
  }

  // Function to display time slots from database
  function displayTimeSlotsFromDatabase(timeSlots, fromDate, toDate) {
    if (!timeSlots || timeSlots.length === 0 || !fromDate || !toDate) {
      document.getElementById('timeSlotsGridContainer').style.display = 'none';
      return;
    }

    const container = document.getElementById('timeSlotsGrid');
    const gridContainer = document.getElementById('timeSlotsGridContainer');
    container.innerHTML = '';

    // Parse dates
    const startDate = new Date(fromDate + 'T00:00:00');
    const endDate = new Date(toDate + 'T00:00:00');

    // Group time slots by date - normalize date strings
    const slotsByDate = {};
    timeSlots.forEach(slot => {
      // Normalize date string (remove time if present, ensure YYYY-MM-DD format)
      const normalizedDate = slot.date.split('T')[0];
      if (!slotsByDate[normalizedDate]) {
        slotsByDate[normalizedDate] = [];
      }
      slotsByDate[normalizedDate].push(slot);
    });

    // Generate dates array - ensure all dates from start to end are included
    const dates = [];
    const currentDate = new Date(startDate);
    // Set time to midnight to avoid timezone issues
    currentDate.setHours(0, 0, 0, 0);
    const endDateNormalized = new Date(endDate);
    endDateNormalized.setHours(0, 0, 0, 0);
    
    while (currentDate <= endDateNormalized) {
      dates.push(new Date(currentDate));
      currentDate.setDate(currentDate.getDate() + 1);
    }

    // Get all unique times
    const allTimes = new Set();
    timeSlots.forEach(slot => {
      allTimes.add(slot.time);
    });
    const sortedTimes = Array.from(allTimes).sort();

    // Set CSS variable for number of dates
    document.documentElement.style.setProperty('--num-dates', dates.length);

    // Create grid HTML
    let gridHTML = '<div class="time-slots-grid-wrapper">';
    gridHTML += '<div class="time-slots-calendar">';
    gridHTML += '<div class="calendar-header">';
    gridHTML += '<button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)">‚Äπ</button>';
    gridHTML += `<div class="calendar-month-year">${formatMonthYear(startDate)}</div>`;
    gridHTML += '<button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">‚Ä∫</button>';
    gridHTML += '</div>';
    gridHTML += '<div class="calendar-days-header">S M T W T F S</div>';
    gridHTML += '<div class="calendar-dates" id="calendarDates"></div>';
    gridHTML += '</div>';

    gridHTML += '<div class="time-slots-columns">';
    gridHTML += '<div class="time-slots-header-row">';
    gridHTML += '<div class="time-slot-row-header"></div>';
    dates.forEach(date => {
      const dayName = date.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
      const dayNum = date.getDate();
      const isSelected = date.toDateString() === startDate.toDateString();
      gridHTML += `<div class="time-slot-column-header ${isSelected ? 'selected' : ''}">${dayName} ${dayNum}</div>`;
    });
    gridHTML += '</div>';

    sortedTimes.forEach(timeStr => {
      const [hours, mins] = timeStr.split(':').map(Number);
      const displayTime = formatTime(hours, mins);
      gridHTML += '<div class="time-slots-row">';
      gridHTML += `<div class="time-slot-row-label">${displayTime}</div>`;
      dates.forEach(date => {
        // Normalize date string to YYYY-MM-DD format
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        const slot = slotsByDate[dateStr]?.find(s => s.time === timeStr);
        if (slot) {
          // Check if slot is available (default: true, unless stored as unavailable)
          const isAvailable = slot.available !== false;
          gridHTML += `<div class="time-slot-cell-wrapper">
            <div class="time-slot-cell ${isAvailable ? '' : 'unavailable'}">
              <input type="checkbox" class="time-slot-checkbox" data-datetime="${slot.datetime}" ${isAvailable ? 'checked' : ''} />
              <span class="time-slot-text">${displayTime}</span>
            </div>
          </div>`;
        } else {
          gridHTML += '<div class="time-slot-cell-wrapper"><div class="time-slot-cell empty-slot"></div></div>';
        }
      });
      gridHTML += '</div>';
    });
    gridHTML += '</div>';
    gridHTML += '</div>';

    container.innerHTML = gridHTML;
    gridContainer.style.display = 'block';
    showUpdateButton();

    // Generate calendar dates
    generateCalendarDates(startDate, dates);
  }
</script>

<style>
  .time-slots-grid-wrapper {
    display: flex;
    gap: 24px;
    background: var(--bg-panel);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid var(--border-color);
  }

  .time-slots-calendar {
    min-width: 280px;
    background: var(--bg-card);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid var(--border-color);
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .calendar-month-year {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .calendar-nav-btn {
    background: var(--bg-panel);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .calendar-nav-btn:hover {
    background: var(--purple-primary);
    border-color: var(--purple-primary);
    color: white;
  }

  .calendar-days-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-align: center;
  }

  .calendar-dates {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  .calendar-date {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 14px;
    color: var(--text-muted);
    cursor: default;
  }

  .calendar-date.available {
    color: var(--text-primary);
    background: var(--bg-panel);
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 700;
    font-size: 15px;
  }

  .calendar-date.available:hover {
    background: var(--purple-primary);
    color: white;
  }

  .calendar-date.selected {
    background: var(--purple-primary);
    color: white;
    font-weight: 700;
    font-size: 15px;
  }

  .calendar-date.empty {
    visibility: hidden;
  }

  .time-slots-columns {
    flex: 1;
    overflow-x: auto;
  }

  .time-slots-header-row {
    display: grid;
    grid-template-columns: 100px repeat(var(--num-dates, 5), minmax(120px, 1fr));
    gap: 8px;
    margin-bottom: 8px;
    align-items: stretch;
  }

  .time-slot-column-header {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 13px;
    min-width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
  }

  .time-slot-column-header.selected {
    background: var(--purple-primary);
    color: white;
    border-color: var(--purple-primary);
  }

  .time-slot-row-header {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 12px;
  }

  .time-slots-row {
    display: grid;
    grid-template-columns: 100px repeat(var(--num-dates, 5), minmax(120px, 1fr));
    gap: 8px;
    margin-bottom: 4px;
    align-items: stretch;
  }

  .time-slot-row-label {
    font-size: 13px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 12px;
    font-weight: 500;
  }

  .time-slot-cell {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 8px 6px;
    text-align: center;
    font-size: 13px;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s;
    min-width: 120px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    white-space: nowrap;
    box-sizing: border-box;
    position: relative;
  }

  .time-slot-cell:hover {
    background: var(--purple-light);
    border-color: var(--purple-primary);
    color: white;
  }

  .time-slot-text {
    flex: 1;
    text-align: center;
  }

  .time-slot-cell.booked {
    background: var(--bg-panel);
    color: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.5;
  }

  .time-slot-cell.empty-slot {
    background: var(--bg-panel);
    border: 1px solid var(--border-color);
    opacity: 0.4;
    cursor: not-allowed;
    min-width: 120px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .time-slot-cell.empty-slot::after {
    content: '-';
    color: var(--text-muted);
    font-size: 16px;
  }

  .time-slot-cell-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .time-slot-checkbox {
    width: 8px;
    height: 8px;
    cursor: pointer;
    accent-color: var(--purple-primary);
    flex-shrink: 0;
    margin: 0;
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-50%);
  }

  .time-slot-cell.unavailable {
    background: var(--bg-panel);
    color: var(--text-muted);
    opacity: 0.5;
    text-decoration: line-through;
  }

  .time-slot-cell:has(.time-slot-checkbox:checked) {
    background: var(--bg-card);
    color: var(--text-primary);
    opacity: 1;
  }

  .time-slot-cell:has(.time-slot-checkbox:not(:checked)) {
    background: var(--bg-panel);
    color: var(--text-muted);
    opacity: 0.5;
  }
</style>

<script>
  // Function to update time slot availability
  async function updateTimeSlotAvailability() {
    const btn = document.getElementById('updateTimeSlotsBtn');
    if (!btn) return;

    btn.disabled = true;
    btn.textContent = 'Updating...';

    // Collect all checkboxes and their states
    const checkboxes = document.querySelectorAll('.time-slot-checkbox');
    const availability = [];

    checkboxes.forEach(checkbox => {
      const datetime = checkbox.getAttribute('data-datetime');
      if (datetime) {
        availability.push({
          datetime: datetime,
          available: checkbox.checked
        });
      }
    });

    try {
      const response = await fetch('{% url "recruiter_interview_settings" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          update_availability: true,
          availability: availability
        })
      });

      if (!response.ok) {
        throw new Error('Failed to update availability');
      }

      const data = await response.json();
      if (data.success) {
        btn.textContent = '‚úÖ Updated';
        setTimeout(() => {
          btn.textContent = 'üíæ Update Availability';
          btn.disabled = false;
        }, 2000);
        
        // Reload the grid to reflect changes
        loadInterviewSettings();
      } else {
        throw new Error(data.error || 'Failed to update availability');
      }
    } catch (error) {
      alert('Error updating availability: ' + error.message);
      btn.textContent = 'üíæ Update Availability';
      btn.disabled = false;
    }
  }

  // Show update button when grid is displayed
  function showUpdateButton() {
    const btn = document.getElementById('updateTimeSlotsBtn');
    if (btn) {
      btn.style.display = 'block';
    }
  }
</script>
{% endblock %}
