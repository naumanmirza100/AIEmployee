{% extends 'base.html' %}
{% load static %}

{% block title %}Recruiter Dashboard - AI Recruitment{% endblock %}

{% block content %}
<style>
  :root {
    --bg: #0f172a;
    --panel: #0b1021;
    --card: #ffffff;
    --text: #0f172a;
    --muted: #6b7280;
    --accent: #2563eb;
    --accent-2: #10b981;
    --border: #e5e7eb;
    --shadow: 0 10px 35px rgba(15, 23, 42, 0.12);
    --danger: #ef4444;
    --warning: #f59e0b;
  }

  .dashboard-container {
    max-width: 1400px;
    margin: 32px auto;
    padding: 0 16px;
  }

  .dashboard-header {
    margin-bottom: 32px;
  }

  .dashboard-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    color: var(--text);
  }

  .dashboard-header p {
    color: var(--muted);
    margin: 0;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  .dashboard-section {
    background: var(--card);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
  }

  .section-header h2 {
    margin: 0;
    font-size: 24px;
    color: var(--text);
  }

  .full-width-section {
    grid-column: 1 / -1;
  }

  /* Form Styles */
  label {
    display: block;
    margin: 12px 0 6px;
    font-weight: 600;
    color: var(--text);
  }

  input[type="text"],
  input[type="file"],
  textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    background: #f8fafc;
    font-family: inherit;
    box-sizing: border-box;
  }

  textarea {
    min-height: 120px;
    resize: vertical;
  }

  input[type="file"] {
    cursor: pointer;
  }

  .btn {
    background: linear-gradient(135deg, var(--accent), #1d4ed8);
    color: #fff;
    border: none;
    padding: 12px 18px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
    transition: transform 0.05s ease, box-shadow 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }

  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 24px rgba(37, 99, 235, 0.28);
  }

  .btn-secondary {
    background: linear-gradient(135deg, var(--muted), #4b5563);
    box-shadow: 0 8px 20px rgba(107, 114, 128, 0.25);
  }

  .btn-danger {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.25);
  }

  .btn-small {
    padding: 6px 12px;
    font-size: 12px;
  }

  .btn:disabled {
    background: #9eb5ef;
    cursor: not-allowed;
    box-shadow: none;
  }

  /* Job Description List */
  .job-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 600px;
    overflow-y: auto;
  }

  .job-item {
    background: #f8fafc;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    transition: all 0.2s ease;
  }

  .job-item:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
  }

  .job-item-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 8px;
  }

  .job-item-title {
    font-weight: 600;
    font-size: 16px;
    color: var(--text);
    margin: 0 0 4px 0;
  }

  .job-item-description {
    color: var(--muted);
    font-size: 14px;
    margin: 8px 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .job-item-meta {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 12px;
    font-size: 12px;
    color: var(--muted);
  }

  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
  }

  .badge-active {
    background: #d1fae5;
    color: #065f46;
  }

  .badge-inactive {
    background: #fee2e2;
    color: #991b1b;
  }

  .job-item-actions {
    display: flex;
    gap: 8px;
  }

  /* Candidate Status Sections */
  .candidate-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
  }

  .status-section {
    background: #f8fafc;
    border-radius: 12px;
    padding: 16px;
    border: 1px solid var(--border);
  }

  .status-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .status-section-title {
    font-weight: 600;
    font-size: 16px;
    margin: 0;
  }

  .status-count {
    background: var(--accent);
    color: white;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
  }

  .candidate-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 400px;
    overflow-y: auto;
  }

  .candidate-item {
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    transition: all 0.2s ease;
  }

  .candidate-item:hover {
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
  }

  .candidate-name {
    font-weight: 600;
    font-size: 14px;
    margin: 0 0 4px 0;
    color: var(--text);
  }

  .candidate-email {
    font-size: 12px;
    color: var(--muted);
    margin: 0 0 4px 0;
  }

  .candidate-meta {
    font-size: 11px;
    color: var(--muted);
    margin-top: 8px;
  }

  .interview-slot {
    background: #dbeafe;
    color: #1e40af;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    margin-top: 8px;
    display: inline-block;
  }

  /* Upload Section */
  .upload-section {
    background: #f8fafc;
    padding: 16px;
    border-radius: 10px;
    border: 2px dashed var(--border);
    margin-top: 8px;
  }

  .upload-section.has-file {
    border-color: var(--accent-2);
    background: #f0fdf4;
  }

  .file-info {
    margin-top: 8px;
    padding: 8px;
    background: white;
    border-radius: 8px;
    font-size: 12px;
    color: var(--muted);
  }

  .hint {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 32px;
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
  }

  .modal-header h3 {
    margin: 0;
    font-size: 24px;
  }

  .close {
    color: var(--muted);
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    line-height: 1;
  }

  .close:hover {
    color: var(--text);
  }

  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    justify-content: flex-end;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }
</style>

<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>üìã Recruiter Dashboard</h1>
    <p>Manage CVs, job descriptions, and track candidate status</p>
  </div>

  <!-- Two Column Layout: CV Upload and Job Descriptions -->
  <div class="dashboard-grid">
    <!-- CV Upload Section -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2>üì§ Upload CVs</h2>
      </div>
      <form id="cv-form">
        <label>Upload CV files (multiple allowed)</label>
        <div class="upload-section" id="cvUploadSection">
          <input id="cvFiles" type="file" name="files" multiple accept=".pdf,.docx,.txt" />
          <div class="file-info" id="cvFileInfo">No files selected</div>
        </div>

        <label>Select Job Description (Optional)</label>
        <select id="jobDescriptionSelect" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; background: #f8fafc;">
          <option value="">-- Select a job description --</option>
          {% for jd in job_descriptions %}
            <option value="{{ jd.id }}" data-keywords="{{ jd.keywords_json|default:''|escape }}">{{ jd.title }}</option>
          {% endfor %}
        </select>
        <div class="hint">Select an existing job description to use for candidate evaluation</div>
        <div id="jobKeywordsDisplay" style="margin-top: 12px; display: none;">
          <strong>Extracted Keywords:</strong>
          <div id="keywordsList" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;"></div>
        </div>

        <label>Job Description Text (Alternative)</label>
        <textarea id="jobDescriptionText" placeholder="Or paste job description text here..."></textarea>

        <label>Job Keywords (Optional)</label>
        <input id="jobKeywords" type="text" placeholder="e.g., react,node,api,aws" />

        <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center;">
          <button type="submit" id="submitBtn" class="btn">Process CVs</button>
          <span id="status" class="hint"></span>
        </div>
      </form>

      <!-- Processing Results Section -->
      <div id="processingResults" style="display: none; margin-top: 24px;">
        <div class="section-header" style="margin-bottom: 16px;">
          <h3 style="margin: 0; font-size: 20px;">üìä Processing Results</h3>
        </div>
        
        <!-- Results Summary -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
          <div style="background: #d1fae5; padding: 16px; border-radius: 10px; text-align: center;">
            <div style="font-size: 32px; font-weight: 700; color: #065f46;" id="interviewCount">0</div>
            <div style="color: #065f46; font-weight: 600;">‚úÖ Selected for Interview</div>
          </div>
          <div style="background: #fef3c7; padding: 16px; border-radius: 10px; text-align: center;">
            <div style="font-size: 32px; font-weight: 700; color: #92400e;" id="holdCount">0</div>
            <div style="color: #92400e; font-weight: 600;">‚è∏Ô∏è On Hold</div>
          </div>
          <div style="background: #fee2e2; padding: 16px; border-radius: 10px; text-align: center;">
            <div style="font-size: 32px; font-weight: 700; color: #991b1b;" id="rejectCount">0</div>
            <div style="color: #991b1b; font-weight: 600;">‚ùå Rejected</div>
          </div>
        </div>

        <!-- Results by Category -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
          <!-- Interview Candidates -->
          <div>
            <h4 style="margin: 0 0 12px 0; color: #065f46;">‚úÖ Interview</h4>
            <div id="interviewCandidates" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
          </div>
          
          <!-- Hold Candidates -->
          <div>
            <h4 style="margin: 0 0 12px 0; color: #92400e;">‚è∏Ô∏è Hold</h4>
            <div id="holdCandidates" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
          </div>
          
          <!-- Rejected Candidates -->
          <div>
            <h4 style="margin: 0 0 12px 0; color: #991b1b;">‚ùå Rejected</h4>
            <div id="rejectCandidates" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Job Description Section -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2>üìù Job Descriptions</h2>
        <button class="btn btn-small" onclick="openJobDescriptionModal()">+ Add New</button>
      </div>
      <div class="job-list" id="jobDescriptionList">
        {% for jd in job_descriptions %}
        <div class="job-item" data-id="{{ jd.id }}" data-title="{{ jd.title|escape }}" data-description="{{ jd.description|escape }}" data-is-active="{{ jd.is_active|lower }}">
          <div class="job-item-header">
            <div style="flex: 1;">
              <h4 class="job-item-title">{{ jd.title }}</h4>
              <div class="job-item-description">{{ jd.description|truncatewords:30 }}</div>
            </div>
            <div class="job-item-actions">
              <button class="btn btn-small btn-secondary" onclick="editJobDescriptionFromElement(this.closest('.job-item'))">Edit</button>
              <button class="btn btn-small btn-danger" onclick="deleteJobDescription('{{ jd.id }}')">Delete</button>
            </div>
          </div>
          <div class="job-item-meta">
            <span class="badge {% if jd.is_active %}badge-active{% else %}badge-inactive{% endif %}">
              {% if jd.is_active %}Active{% else %}Inactive{% endif %}
            </span>
            <span>Created: {{ jd.created_at|date:"M d, Y" }}</span>
            {% if jd.created_by %}
            <span>By: {{ jd.created_by.username }}</span>
            {% endif %}
          </div>
        </div>
        {% empty %}
        <div class="empty-state">
          <div class="empty-state-icon">üìÑ</div>
          <p>No job descriptions yet. Click "Add New" to create one.</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Email Settings Section -->
  <div class="dashboard-section full-width-section" id="emailSettingsSection">
    <div class="section-header">
      <h2>‚öôÔ∏è Email Settings</h2>
      <button class="btn btn-small" onclick="toggleEmailSettings()" id="toggleEmailSettingsBtn">Show Settings</button>
    </div>
    <div id="emailSettingsForm" style="display: none;">
      <div style="background: #f8fafc; padding: 16px; border-radius: 10px; margin-bottom: 20px;">
        <p style="margin: 0; color: var(--muted); font-size: 14px;">
          Configure your email timing preferences. These settings will be applied to all new interviews you create.
        </p>
      </div>
      
      <form id="emailSettingsFormElement">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Follow-up Settings -->
          <div>
            <h3 style="margin: 0 0 16px 0; font-size: 18px; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 8px;">
              üìß Follow-up Email Settings (PENDING Interviews)
            </h3>
            
            <label for="followupDelayHours">
              Follow-up Delay (Hours)
              <span style="color: var(--muted); font-weight: normal; font-size: 12px;"> - Kitne hours baad pehli follow-up email bhejni hai</span>
            </label>
            <input type="number" id="followupDelayHours" name="followup_delay_hours" min="1" max="168" value="48" required />
            <div class="hint">Default: 48 hours (2 days)</div>
            
            <label for="minHoursBetweenFollowups" style="margin-top: 16px;">
              Minimum Hours Between Follow-ups
              <span style="color: var(--muted); font-weight: normal; font-size: 12px;"> - Do follow-up emails ke beech minimum gap</span>
            </label>
            <input type="number" id="minHoursBetweenFollowups" name="min_hours_between_followups" min="1" max="72" value="24" required />
            <div class="hint">Default: 24 hours</div>
            
            <label for="maxFollowupEmails" style="margin-top: 16px;">
              Maximum Follow-up Emails
              <span style="color: var(--muted); font-weight: normal; font-size: 12px;"> - Maximum kitne follow-up emails bhejne hain</span>
            </label>
            <input type="number" id="maxFollowupEmails" name="max_followup_emails" min="1" max="10" value="3" required />
            <div class="hint">Default: 3 emails</div>
          </div>
          
          <!-- Reminder Settings -->
          <div>
            <h3 style="margin: 0 0 16px 0; font-size: 18px; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 8px;">
              üîî Reminder Email Settings (SCHEDULED Interviews)
            </h3>
            
            <label for="reminderHoursBefore">
              Reminder Hours Before Interview
              <span style="color: var(--muted); font-weight: normal; font-size: 12px;"> - Interview se kitne hours pehle reminder bhejni hai</span>
            </label>
            <input type="number" id="reminderHoursBefore" name="reminder_hours_before" min="1" max="168" value="24" required />
            <div class="hint">Default: 24 hours (1 day before)</div>
            
            <div style="margin-top: 24px; padding: 16px; background: white; border-radius: 8px; border: 1px solid var(--border);">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="autoSendFollowups" name="auto_send_followups" checked style="width: auto; cursor: pointer;" />
                <span>Automatically send follow-up emails</span>
              </label>
              <div class="hint" style="margin-top: 4px; margin-left: 24px;">If unchecked, you'll need to send follow-ups manually</div>
            </div>
            
            <div style="margin-top: 16px; padding: 16px; background: white; border-radius: 8px; border: 1px solid var(--border);">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="autoSendReminders" name="auto_send_reminders" checked style="width: auto; cursor: pointer;" />
                <span>Automatically send reminder emails</span>
              </label>
              <div class="hint" style="margin-top: 4px; margin-left: 24px;">If unchecked, you'll need to send reminders manually</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 24px; display: flex; gap: 12px; align-items: center;">
          <button type="submit" class="btn" id="saveEmailSettingsBtn">üíæ Save Email Settings</button>
          <button type="button" class="btn btn-secondary" onclick="loadEmailSettings()">üîÑ Reset to Current</button>
          <span id="emailSettingsStatus" class="hint"></span>
        </div>
      </form>
    </div>
  </div>

  <!-- Candidate Status Section (Full Width) -->
  <div class="dashboard-section full-width-section">
    <div class="section-header">
      <h2>üë• Candidate Status</h2>
      <div style="display: flex; gap: 12px; align-items: center;">
        <label for="statusJobFilter" style="margin: 0; font-weight: 500; font-size: 14px;">Filter by Job:</label>
        <select id="statusJobFilter" onchange="filterByJob(this.value)" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
          <option value="">-- All Jobs --</option>
          {% for jd in job_descriptions %}
            <option value="{{ jd.id }}" {% if filter_job and filter_job.id == jd.id %}selected{% endif %}>{{ jd.title }}</option>
          {% endfor %}
        </select>
        {% if filter_job %}
        <button class="btn btn-small btn-secondary" onclick="filterByJob('')" style="padding: 8px 12px; font-size: 12px;">Clear Filter</button>
        {% endif %}
      </div>
    </div>
    {% if filter_job %}
    <div style="background: #eef2ff; border-left: 4px solid var(--accent); padding: 12px; margin-bottom: 20px; border-radius: 8px;">
      <strong>üìå Filtered by:</strong> {{ filter_job.title }}
    </div>
    {% endif %}
    <div class="candidate-status-grid">
      <!-- Selected for Interview -->
      <div class="status-section">
        <div class="status-section-header">
          <h3 class="status-section-title">‚úÖ Selected for Interview</h3>
          <span class="status-count">{{ selected_for_interview|length }}</span>
        </div>
        <div class="candidate-list">
          {% for candidate_info in selected_for_interview %}
          <div class="candidate-item">
            <div class="candidate-name">{{ candidate_info.name }}</div>
            {% if candidate_info.email %}
            <div class="candidate-email">{{ candidate_info.email }}</div>
            {% endif %}
            <div class="candidate-meta">
              Score: {{ candidate_info.cv_record.role_fit_score|default:"N/A" }} | 
              Decision: <strong>{{ candidate_info.cv_record.qualification_decision|default:"N/A" }}</strong>
            </div>
          </div>
          {% empty %}
          <div class="empty-state">
            <p>No candidates selected for interview yet</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Interview Email Sent -->
      <div class="status-section">
        <div class="status-section-header">
          <h3 class="status-section-title">üìß Interview Email Sent</h3>
          <span class="status-count">{{ interview_email_sent|length }}</span>
        </div>
        <div class="candidate-list">
          {% for interview in interview_email_sent %}
          <div class="candidate-item">
            <div class="candidate-name">{{ interview.candidate_name }}</div>
            <div class="candidate-email">{{ interview.candidate_email }}</div>
            <div class="candidate-meta">
              Role: {{ interview.job_role }}<br>
              Status: <strong>{{ interview.get_status_display }}</strong><br>
              Sent: {{ interview.invitation_sent_at|date:"M d, Y H:i" }}
            </div>
            {% if interview.selected_slot %}
            <div class="interview-slot">Slot: {{ interview.selected_slot }}</div>
            {% endif %}
          </div>
          {% empty %}
          <div class="empty-state">
            <p>No interview emails sent yet</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Scheduled Interviews -->
      <div class="status-section">
        <div class="status-section-header">
          <h3 class="status-section-title">üìÖ Scheduled Interviews</h3>
          <span class="status-count">{{ interviews_by_status.SCHEDULED|length }}</span>
        </div>
        <div class="candidate-list">
          {% for interview in interviews_by_status.SCHEDULED %}
          <div class="candidate-item">
            <div class="candidate-name">{{ interview.candidate_name }}</div>
            <div class="candidate-email">{{ interview.candidate_email }}</div>
            <div class="candidate-meta">
              Role: {{ interview.job_role }}<br>
              {% if interview.scheduled_datetime %}
              Scheduled: <strong>{{ interview.scheduled_datetime|date:"M d, Y H:i" }}</strong>
              {% endif %}
            </div>
          </div>
          {% empty %}
          <div class="empty-state">
            <p>No scheduled interviews</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Pending Interviews -->
      <div class="status-section">
        <div class="status-section-header">
          <h3 class="status-section-title">‚è≥ Pending Confirmation</h3>
          <span class="status-count">{{ interviews_by_status.PENDING|length }}</span>
        </div>
        <div class="candidate-list">
          {% for interview in interviews_by_status.PENDING %}
          <div class="candidate-item">
            <div class="candidate-name">{{ interview.candidate_name }}</div>
            <div class="candidate-email">{{ interview.candidate_email }}</div>
            <div class="candidate-meta">
              Role: {{ interview.job_role }}<br>
              Awaiting candidate slot selection
            </div>
          </div>
          {% empty %}
          <div class="empty-state">
            <p>No pending interviews</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Job Description Modal -->
<div id="jobDescriptionModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Add Job Description</h3>
      <button class="close" onclick="closeJobDescriptionModal()">&times;</button>
    </div>
    <form id="jobDescriptionForm">
      <input type="hidden" id="jobDescriptionId" value="">
      <label>Job Title *</label>
      <input type="text" id="jobTitle" required />

      <label>Job Description *</label>
      <textarea id="jobDescriptionTextModal" required></textarea>
      <div class="hint">The full job description text. Keywords will be automatically extracted.</div>

      <label style="display: flex; align-items: center; gap: 8px; margin-top: 16px;">
        <input type="checkbox" id="jobIsActive" checked />
        <span>Active (currently being used)</span>
      </label>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeJobDescriptionModal()">Cancel</button>
        <button type="submit" class="btn">Save Job Description</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  // Job Description Modal
  function openJobDescriptionModal() {
    document.getElementById('jobDescriptionModal').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Add Job Description';
    document.getElementById('jobDescriptionForm').reset();
    document.getElementById('jobDescriptionId').value = '';
  }

  function closeJobDescriptionModal() {
    document.getElementById('jobDescriptionModal').style.display = 'none';
  }

  function editJobDescription(id, title, description, isActive) {
    document.getElementById('jobDescriptionModal').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Edit Job Description';
    document.getElementById('jobDescriptionId').value = id;
    document.getElementById('jobTitle').value = title;
    document.getElementById('jobDescriptionTextModal').value = description;
    document.getElementById('jobIsActive').checked = isActive === true || isActive === 'true';
  }

  function editJobDescriptionFromElement(element) {
    const id = element.getAttribute('data-id');
    const title = element.getAttribute('data-title');
    const description = element.getAttribute('data-description');
    const isActive = element.getAttribute('data-is-active') === 'true';
    editJobDescription(id, title, description, isActive);
  }

  // Job Description Form Submit
  document.getElementById('jobDescriptionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('jobDescriptionId').value;
    const title = document.getElementById('jobTitle').value;
    const description = document.getElementById('jobDescriptionTextModal').value;
    const isActive = document.getElementById('jobIsActive').checked;

    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('is_active', isActive);
    formData.append('parse_keywords', 'true');

    try {
      let response;
      if (id) {
        // Update
        response = await fetch(`{% url 'update_job_description' 0 %}`.replace('0', id), {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': csrftoken
          }
        });
      } else {
        // Create
        response = await fetch('{% url "create_job_description" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': csrftoken
          }
        });
      }

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to save job description');
      }

      // Reload page to show updated list
      window.location.reload();
    } catch (error) {
      alert('Error: ' + error.message);
    }
  });

  // Delete Job Description
  async function deleteJobDescription(id) {
    if (!confirm('Are you sure you want to delete this job description?')) {
      return;
    }

    try {
      const response = await fetch(`{% url 'delete_job_description' 0 %}`.replace('0', id), {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken
        }
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to delete job description');
      }

      // Reload page to show updated list
      window.location.reload();
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  // Job Description Selection - Show Keywords
  const jobDescriptionSelect = document.getElementById('jobDescriptionSelect');
  const jobKeywordsDisplay = document.getElementById('jobKeywordsDisplay');
  const keywordsList = document.getElementById('keywordsList');

  jobDescriptionSelect.addEventListener('change', (e) => {
    const selectedOption = e.target.options[e.target.selectedIndex];
    const keywordsJson = selectedOption.getAttribute('data-keywords');
    
    if (keywordsJson && keywordsJson.trim()) {
      try {
        const keywordsData = JSON.parse(keywordsJson);
        const keywords = keywordsData.keywords || [];
        
        if (keywords.length > 0) {
          keywordsList.innerHTML = keywords.map(kw => 
            `<span class="chip matched" style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 999px; font-size: 12px;">${kw}</span>`
          ).join('');
          jobKeywordsDisplay.style.display = 'block';
        } else {
          jobKeywordsDisplay.style.display = 'none';
        }
      } catch (err) {
        console.error('Error parsing keywords:', err);
        jobKeywordsDisplay.style.display = 'none';
      }
    } else {
      jobKeywordsDisplay.style.display = 'none';
    }
  });

  // CV File Upload Handling
  const cvFileInput = document.getElementById('cvFiles');
  const cvFileInfo = document.getElementById('cvFileInfo');
  const cvUploadSection = document.getElementById('cvUploadSection');

  cvFileInput.addEventListener('change', (e) => {
    const files = e.target.files;
    if (files.length > 0) {
      const fileNames = Array.from(files).map(f => f.name).join(', ');
      cvFileInfo.textContent = `${files.length} file(s) selected: ${fileNames}`;
      cvUploadSection.classList.add('has-file');
    } else {
      cvFileInfo.textContent = 'No files selected';
      cvUploadSection.classList.remove('has-file');
    }
  });

  // CV Form Submit (reuse existing process_cvs functionality)
  document.getElementById('cv-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const files = cvFileInput.files;
    if (!files.length) {
      alert('Please select at least one CV file.');
      return;
    }

    const jobDescriptionId = document.getElementById('jobDescriptionSelect').value;
    const jobDescriptionText = document.getElementById('jobDescriptionText').value.trim();
    const jobKeywords = document.getElementById('jobKeywords').value;

    const fd = new FormData();
    Array.from(files).forEach((f) => fd.append('files', f));
    
    if (jobDescriptionId) {
      // Fetch job description text from selected option
      const selectedOption = jobDescriptionSelect.options[jobDescriptionSelect.selectedIndex];
      // Get job description details via API or use stored data
      // For now, we'll fetch the full job description via an API call if needed
      // But first, try to get it from the job descriptions data
      // Note: We'll append job_description_id for linking purposes
      fd.append('job_description_id', jobDescriptionId);
    }
    if (jobDescriptionText) {
      fd.append('job_description_text', jobDescriptionText);
    }
    if (jobKeywords) {
      fd.append('job_keywords', jobKeywords);
    }

    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const processingResults = document.getElementById('processingResults');
    
    submitBtn.disabled = true;
    statusEl.textContent = 'Processing...';
    processingResults.style.display = 'none';

    try {
      const res = await fetch('{% url "recruitment_process_cvs" %}', {
        method: 'POST',
        body: fd,
        headers: {
          'X-CSRFToken': csrftoken
        }
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || 'Request failed');
      }

      const data = await res.json();
      statusEl.textContent = `Processed ${data.length} CV(s) successfully!`;
      
      // Display results
      displayProcessingResults(data);
      processingResults.style.display = 'block';
      
      // Scroll to results
      processingResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
    } catch (err) {
      statusEl.textContent = 'Error: ' + err.message;
      alert('Error processing CVs: ' + err.message);
    } finally {
      submitBtn.disabled = false;
    }
  });

  // Function to display processing results
  function displayProcessingResults(data) {
    const interviewCandidates = document.getElementById('interviewCandidates');
    const holdCandidates = document.getElementById('holdCandidates');
    const rejectCandidates = document.getElementById('rejectCandidates');
    const interviewCount = document.getElementById('interviewCount');
    const holdCount = document.getElementById('holdCount');
    const rejectCount = document.getElementById('rejectCount');
    
    // Clear previous results
    interviewCandidates.innerHTML = '';
    holdCandidates.innerHTML = '';
    rejectCandidates.innerHTML = '';
    
    let interviewCountVal = 0;
    let holdCountVal = 0;
    let rejectCountVal = 0;
    
    data.forEach((item, index) => {
      const parsed = item.parsed || item.data || {};
      const qualification = item.qualification || {};
      const insights = item.insights || {};
      
      const candidateName = parsed.name || parsed.email || item.file || `Candidate ${index + 1}`;
      const candidateEmail = parsed.email || 'No email';
      const decision = qualification.decision || 'PENDING';
      const score = insights.role_fit_score ?? 'N/A';
      const confidence = qualification.confidence_score ?? 'N/A';
      const matchedSkills = qualification.matched_skills || [];
      const missingSkills = qualification.missing_skills || [];
      
      const candidateCard = `
        <div class="candidate-item" style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
          <div class="candidate-name">${candidateName}</div>
          <div class="candidate-email">${candidateEmail}</div>
          <div class="candidate-meta" style="margin-top: 8px; font-size: 11px; color: var(--muted);">
            Score: ${score} | Confidence: ${confidence}%<br>
            Matched: ${matchedSkills.length} skills
            ${item.rank ? `| Rank: #${item.rank}` : ''}
          </div>
        </div>
      `;
      
      if (decision === 'INTERVIEW') {
        interviewCandidates.innerHTML += candidateCard;
        interviewCountVal++;
      } else if (decision === 'HOLD') {
        holdCandidates.innerHTML += candidateCard;
        holdCountVal++;
      } else if (decision === 'REJECT') {
        rejectCandidates.innerHTML += candidateCard;
        rejectCountVal++;
      }
    });
    
    // Update counts
    interviewCount.textContent = interviewCountVal;
    holdCount.textContent = holdCountVal;
    rejectCount.textContent = rejectCountVal;
    
    // Show empty state if no candidates in a category
    if (interviewCountVal === 0) {
      interviewCandidates.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--muted); font-size: 12px;">No candidates selected for interview</div>';
    }
    if (holdCountVal === 0) {
      holdCandidates.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--muted); font-size: 12px;">No candidates on hold</div>';
    }
    if (rejectCountVal === 0) {
      rejectCandidates.innerHTML = '<div class="empty-state" style="padding: 20px; text-align: center; color: var(--muted); font-size: 12px;">No candidates rejected</div>';
    }
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('jobDescriptionModal');
    if (event.target == modal) {
      closeJobDescriptionModal();
    }
  }

  // Filter by Job Description
  function filterByJob(jobId) {
    const url = new URL(window.location.href);
    if (jobId) {
      url.searchParams.set('filter_job_id', jobId);
    } else {
      url.searchParams.delete('filter_job_id');
    }
    window.location.href = url.toString();
  }

  // Email Settings Functions
  function toggleEmailSettings() {
    const form = document.getElementById('emailSettingsForm');
    const btn = document.getElementById('toggleEmailSettingsBtn');
    if (form.style.display === 'none') {
      form.style.display = 'block';
      btn.textContent = 'Hide Settings';
      loadEmailSettings(); // Load current settings when showing
    } else {
      form.style.display = 'none';
      btn.textContent = 'Show Settings';
    }
  }

  // Load current email settings
  async function loadEmailSettings() {
    try {
      const response = await fetch('{% url "recruiter_email_settings" %}', {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      });
      
      if (!response.ok) {
        throw new Error('Failed to load settings');
      }
      
      const data = await response.json();
      if (data.success && data.settings) {
        const settings = data.settings;
        document.getElementById('followupDelayHours').value = settings.followup_delay_hours || 48;
        document.getElementById('minHoursBetweenFollowups').value = settings.min_hours_between_followups || 24;
        document.getElementById('maxFollowupEmails').value = settings.max_followup_emails || 3;
        document.getElementById('reminderHoursBefore').value = settings.reminder_hours_before || 24;
        document.getElementById('autoSendFollowups').checked = settings.auto_send_followups !== false;
        document.getElementById('autoSendReminders').checked = settings.auto_send_reminders !== false;
      }
    } catch (error) {
      console.error('Error loading email settings:', error);
    }
  }

  // Save email settings
  document.getElementById('emailSettingsFormElement').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('saveEmailSettingsBtn');
    const status = document.getElementById('emailSettingsStatus');
    
    btn.disabled = true;
    status.textContent = 'Saving...';
    status.style.color = 'var(--muted)';
    
    const settings = {
      followup_delay_hours: parseInt(document.getElementById('followupDelayHours').value),
      min_hours_between_followups: parseInt(document.getElementById('minHoursBetweenFollowups').value),
      max_followup_emails: parseInt(document.getElementById('maxFollowupEmails').value),
      reminder_hours_before: parseInt(document.getElementById('reminderHoursBefore').value),
      auto_send_followups: document.getElementById('autoSendFollowups').checked,
      auto_send_reminders: document.getElementById('autoSendReminders').checked
    };
    
    try {
      const response = await fetch('{% url "recruiter_email_settings" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settings)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to save settings');
      }
      
      const data = await response.json();
      if (data.success) {
        status.textContent = '‚úÖ Settings saved successfully!';
        status.style.color = '#10b981';
        
        // Show success message for 3 seconds
        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      } else {
        throw new Error(data.error || 'Failed to save settings');
      }
    } catch (error) {
      status.textContent = '‚ùå Error: ' + error.message;
      status.style.color = 'var(--danger)';
      alert('Error saving email settings: ' + error.message);
    } finally {
      btn.disabled = false;
    }
  });

</script>
{% endblock %}
