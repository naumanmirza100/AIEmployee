{% extends 'base.html' %}
{% load static %}

{% block title %}AI Agents Test - Project Manager AI{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px; margin: 2rem auto; padding: 2rem;">
    <div class="dashboard-header">
        <h2>AI Agents Testing Center</h2>
        <p>Test and interact with AI agents for project management</p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
        <!-- Task Prioritization Agent -->
        <div class="dashboard-card">
            <h3>Task & Prioritization Agent</h3>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                Prioritize tasks, suggest order, estimate effort, and identify bottlenecks
            </p>
            
            <div class="form-group">
                <label>Select Project (optional)</label>
                <select id="project-select" class="form-group input" style="width: 100%; padding: 0.75rem;">
                    <option value="">All Projects</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                <button onclick="testPrioritize()" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                    Prioritize Tasks
                </button>
                <button onclick="testOrder()" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                    Suggest Order
                </button>
                <button onclick="testBottlenecks()" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                    Find Bottlenecks
                </button>
                <button onclick="testDelegation()" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                    Suggest Delegation
                </button>
                <button onclick="generateSubtasks()" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem; background: var(--success-color);">
                    Generate Subtasks
                </button>
            </div>

            <div id="task-result" style="margin-top: 1.5rem; display: none;">
                <div id="task-result-content"></div>
            </div>
        </div>

        <!-- Knowledge Q&A Agent & Project Pilot -->
        <div class="dashboard-card">
            <h3>Knowledge Q&A & Project Pilot</h3>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color);">
                <button id="qa-tab" class="tab-button active" onclick="switchTab('qa')" style="flex: 1; padding: 0.75rem; border: none; background: transparent; cursor: pointer; border-bottom: 3px solid var(--primary-color); color: var(--primary-color); font-weight: 600;">
                    Knowledge Q&A
                </button>
                <button id="pilot-tab" class="tab-button" onclick="switchTab('pilot')" style="flex: 1; padding: 0.75rem; border: none; background: transparent; cursor: pointer; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 600;">
                    Project Pilot
                </button>
            </div>
            
            <!-- QA Agent Section -->
            <div id="qa-section" class="tab-content">
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                    Ask questions about your projects, tasks, and get AI-powered answers
                </p>
                
                <div class="form-group">
                    <label>Select Project (optional)</label>
                    <select id="qa-project-select" class="form-group input" style="width: 100%; padding: 0.75rem;">
                        <option value="">General Questions</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Ask a Question</label>
                    <textarea id="question-input" rows="3" placeholder="e.g., What tasks are overdue? What's the status of my project?" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-family: inherit;"></textarea>
                </div>

                <button onclick="testQA()" class="btn btn-primary" style="width: 100%;">
                    Ask AI
                </button>

                <div id="qa-result" style="margin-top: 1.5rem; display: none;">
                    <div id="qa-result-content"></div>
                </div>
            </div>
            
            <!-- Project Pilot Section -->
            <div id="pilot-section" class="tab-content" style="display: none;">
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                    Create projects and tasks using natural language commands
                </p>
                
                <div class="form-group">
                    <label>Select Project (optional)</label>
                    <select id="pilot-project-select" class="form-group input" style="width: 100%; padding: 0.75rem;">
                        <option value="">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Enter Your Request</label>
                    <textarea id="pilot-input" rows="3" placeholder="e.g., Create a new project called 'Website Redesign' with tasks for design, development, and testing" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); font-family: inherit;"></textarea>
                </div>

                <button onclick="testPilot()" class="btn btn-primary" style="width: 100%;">
                    Execute Request
                </button>

                <div id="pilot-result" style="margin-top: 1.5rem; display: none;">
                    <div id="pilot-result-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline/Gantt Agent -->
    <div class="dashboard-card" style="margin-top: 2rem;">
        <h3>Project Timeline / Gantt Agent</h3>
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
            Plan effectively: Map out tasks and milestones in chronological order. Track progress and adjust timelines as needed.<br>
            Identify dependencies: Highlight task relationships to avoid bottlenecks. Enhance collaboration: Provide a shared view of the project for all stakeholders.
        </p>
        
        <div class="form-group">
            <label>Select Project <span style="color: var(--error-color);">*</span></label>
            <select id="timeline-project-select" class="form-group input" style="width: 100%; padding: 0.75rem;" required>
                <option value="">-- Select a Project --</option>
                {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
            <button onclick="testTimeline('create_timeline')" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                Create Timeline
            </button>
            <button onclick="testTimeline('generate_gantt')" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                Generate Gantt Chart
            </button>
            <button onclick="testTimeline('track_milestones')" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                Track Milestones
            </button>
            <button onclick="testTimeline('check_deadlines')" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                Check Deadlines
            </button>
            <button onclick="testTimeline('suggest_adjustments')" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                Suggest Adjustments
            </button>
            <button onclick="testTimeline('identify_conflicts')" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                Identify Conflicts
            </button>
            <button onclick="testTimeline('identify_dependencies')" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                Identify Dependencies
            </button>
            <button onclick="testTimeline('get_shared_view')" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                Shared View
            </button>
            <button onclick="testTimeline('calculate_duration')" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                Calculate Duration
            </button>
        </div>

        <div id="timeline-result" style="margin-top: 1.5rem; display: none;">
            <div id="timeline-result-content"></div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="dashboard-card" style="margin-top: 2rem;">
        <h3>Quick Actions</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary" style="text-align: center; text-decoration: none;">
                ‚Üê Back to Dashboard
            </a>
            <a href="/admin/" class="btn btn-secondary" style="text-align: center; text-decoration: none;">
                Manage Projects & Tasks
            </a>
        </div>
    </div>
</div>

<script>
// Helper function to format date
function formatDate(dateString) {
    if (!dateString) return 'No due date';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    } catch {
        return dateString;
    }
}

// Helper function to get priority color
function getPriorityColor(priority) {
    const colors = {
        'high': '#ef4444',
        'medium': '#f59e0b',
        'low': '#10b981'
    };
    return colors[priority] || '#64748b';
}

// Render prioritized tasks
function renderPrioritizedTasks(data) {
    if (!data.success || !data.tasks || data.tasks.length === 0) {
        return '<div class="dashboard-card"><p>No tasks found. Create some tasks first!</p></div>';
    }
    
    let html = '<div class="dashboard-card"><h4 style="margin-bottom: 1rem;">Prioritized Tasks</h4>';
    html += `<p style="color: var(--text-secondary); margin-bottom: 1.5rem;">AI has analyzed and prioritized ${data.tasks.length} task(s)</p>`;
    
    data.tasks.forEach((task, index) => {
        const aiPriority = task.ai_priority || task.priority;
        const reasoning = task.ai_reasoning || 'No reasoning provided';
        const order = task.suggested_order || index + 1;
        
        html += `
        <div style="border: 2px solid var(--border-color); border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1rem; 
            border-left: 4px solid ${getPriorityColor(aiPriority)};">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                        <span style="background: ${getPriorityColor(aiPriority)}; color: white; padding: 0.25rem 0.75rem; 
                            border-radius: var(--radius-sm); font-size: 0.85rem; font-weight: 600;">
                            ${aiPriority.toUpperCase()}
                        </span>
                        <span style="background: var(--primary-color); color: white; padding: 0.25rem 0.75rem; 
                            border-radius: var(--radius-sm); font-size: 0.85rem;">
                            Order: #${order}
                        </span>
                    </div>
                    <h5 style="margin: 0.5rem 0; font-size: 1.1rem;">${task.title || 'Untitled Task'}</h5>
                </div>
            </div>
            ${task.description ? `<p style="color: var(--text-secondary); margin: 0.5rem 0; font-size: 0.9rem;">${task.description}</p>` : ''}
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-top: 1rem;">
                <strong style="font-size: 0.9rem;">AI Reasoning:</strong>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">${reasoning}</p>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);">
                <span>Status: <strong>${task.status || 'N/A'}</strong></span>
                ${task.due_date ? `<span>Due: <strong>${formatDate(task.due_date)}</strong></span>` : ''}
            </div>
        </div>`;
    });
    
    html += '</div>';
    return html;
}

// Render task order
function renderTaskOrder(data) {
    if (!data.success || !data.tasks || data.tasks.length === 0) {
        return '<div class="dashboard-card"><p>No tasks found. Create some tasks first!</p></div>';
    }
    
    let html = '<div class="dashboard-card"><h4 style="margin-bottom: 1rem;">Suggested Task Execution Order</h4>';
    html += `<p style="color: var(--text-secondary); margin-bottom: 1.5rem;">AI suggests executing ${data.tasks.length} task(s) in this order</p>`;
    
    data.tasks.forEach((task, index) => {
        html += `
        <div style="border: 2px solid var(--border-color); border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1rem;
            display: flex; align-items: start; gap: 1rem;">
            <div style="background: var(--primary-color); color: white; width: 40px; height: 40px; 
                border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                font-weight: 700; flex-shrink: 0;">
                ${index + 1}
            </div>
            <div style="flex: 1;">
                <h5 style="margin: 0 0 0.5rem 0; font-size: 1.1rem;">${task.title || 'Untitled Task'}</h5>
                ${task.description ? `<p style="color: var(--text-secondary); margin: 0.5rem 0; font-size: 0.9rem;">${task.description}</p>` : ''}
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                    <span>Priority: <strong style="color: ${getPriorityColor(task.priority)};">${task.priority || 'N/A'}</strong></span>
                    ${task.due_date ? `<span>Due: <strong>${formatDate(task.due_date)}</strong></span>` : ''}
                </div>
            </div>
        </div>`;
    });
    
    html += '</div>';
    return html;
}

// Render bottlenecks
function renderBottlenecks(data) {
    if (!data.success || !data.analysis) {
        return '<div class="dashboard-card"><p style="color: var(--error-color);">Error analyzing bottlenecks</p></div>';
    }
    
    const analysis = data.analysis;
    let html = '<div class="dashboard-card"><h4 style="margin-bottom: 1rem;">Bottleneck Analysis</h4>';
    
    if (analysis.summary) {
        html += `<p style="color: var(--text-secondary); margin-bottom: 1.5rem;">${analysis.summary}</p>`;
    }
    
    if (analysis.bottlenecks && analysis.bottlenecks.length > 0) {
        analysis.bottlenecks.forEach((bottleneck, index) => {
            const severityColor = {
                'high': '#ef4444',
                'medium': '#f59e0b',
                'low': '#10b981'
            }[bottleneck.severity] || '#64748b';
            
            html += `
            <div style="border: 2px solid ${severityColor}; border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1rem;
                border-left: 4px solid ${severityColor};">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="background: ${severityColor}; color: white; padding: 0.25rem 0.75rem; 
                        border-radius: var(--radius-sm); font-size: 0.85rem; font-weight: 600;">
                        ${bottleneck.severity.toUpperCase()}
                    </span>
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">${bottleneck.type.replace(/_/g, ' ').toUpperCase()}</span>
                </div>
                <p style="margin: 0.5rem 0; font-weight: 500;">${bottleneck.description}</p>
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-top: 1rem;">
                    <strong style="font-size: 0.9rem;">Recommendation:</strong>
                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">${bottleneck.recommendation}</p>
                </div>
            </div>`;
        });
    }
    
    if (analysis.overloaded_members && analysis.overloaded_members.length > 0) {
        html += '<div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--border-color);">';
        html += '<h5 style="margin-bottom: 1rem;">Overloaded Team Members</h5>';
        analysis.overloaded_members.forEach(member => {
            html += `
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 0.5rem;">
                <strong>${member.member}</strong> - ${member.task_count} tasks assigned
                <span style="color: var(--error-color); margin-left: 0.5rem;">(${member.status})</span>
            </div>`;
        });
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

// Render delegation suggestions
function renderDelegation(data) {
    if (!data.success || !data.suggestions) {
        return '<div class="dashboard-card"><p style="color: var(--error-color);">Error generating delegation suggestions</p></div>';
    }
    
    const suggestions = data.suggestions.suggestions || data.suggestions || [];
    
    if (suggestions.length === 0) {
        return '<div class="dashboard-card"><p>No delegation suggestions available. All tasks are assigned or no unassigned tasks found.</p></div>';
    }
    
    let html = '<div class="dashboard-card"><h4 style="margin-bottom: 1rem;">Task Delegation Suggestions</h4>';
    html += `<p style="color: var(--text-secondary); margin-bottom: 1.5rem;">AI suggests delegating ${suggestions.length} task(s)</p>`;
    
    suggestions.forEach((suggestion, index) => {
        html += `
        <div style="border: 2px solid var(--border-color); border-radius: var(--radius-md); padding: 1.5rem; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                <h5 style="margin: 0; font-size: 1.1rem;">${suggestion.task_title || 'Untitled Task'}</h5>
                <span style="background: ${getPriorityColor(suggestion.priority)}; color: white; padding: 0.25rem 0.75rem; 
                    border-radius: var(--radius-sm); font-size: 0.85rem;">
                    ${suggestion.priority.toUpperCase()}
                </span>
            </div>
            <div style="background: var(--primary-color); color: white; padding: 0.75rem; border-radius: var(--radius-sm); 
                margin: 1rem 0; display: inline-block;">
                üë§ Assign to: <strong>${suggestion.suggested_assignee || 'Unassigned'}</strong>
            </div>
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-top: 1rem;">
                <strong style="font-size: 0.9rem;">Reasoning:</strong>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">${suggestion.reasoning || 'No reasoning provided'}</p>
            </div>
        </div>`;
    });
    
    html += '</div>';
    return html;
}

async function testPrioritize() {
    const projectId = document.getElementById('project-select').value;
    const resultDiv = document.getElementById('task-result');
    const resultContent = document.getElementById('task-result-content');
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<div class="dashboard-card"><p>‚è≥ Analyzing tasks with AI...</p></div>';
    
    try {
        const response = await fetch('/api/ai/task-prioritization/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'prioritize',
                project_id: projectId || null
            })
        });
        
        const data = await response.json();
        resultContent.innerHTML = renderPrioritizedTasks(data);
    } catch (error) {
        resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${error.message}</p></div>`;
    }
}

async function testOrder() {
    const projectId = document.getElementById('project-select').value;
    const resultDiv = document.getElementById('task-result');
    const resultContent = document.getElementById('task-result-content');
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<div class="dashboard-card"><p>‚è≥ Analyzing task order with AI...</p></div>';
    
    try {
        const response = await fetch('/api/ai/task-prioritization/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'order',
                project_id: projectId || null
            })
        });
        
        const data = await response.json();
        resultContent.innerHTML = renderTaskOrder(data);
    } catch (error) {
        resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${error.message}</p></div>`;
    }
}

async function testBottlenecks() {
    const projectId = document.getElementById('project-select').value;
    const resultDiv = document.getElementById('task-result');
    const resultContent = document.getElementById('task-result-content');
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<div class="dashboard-card"><p>‚è≥ Identifying bottlenecks with AI...</p></div>';
    
    try {
        const response = await fetch('/api/ai/task-prioritization/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'bottlenecks',
                project_id: projectId || null
            })
        });
        
        const data = await response.json();
        resultContent.innerHTML = renderBottlenecks(data);
    } catch (error) {
        resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${error.message}</p></div>`;
    }
}

async function testDelegation() {
    const projectId = document.getElementById('project-select').value;
    const resultDiv = document.getElementById('task-result');
    const resultContent = document.getElementById('task-result-content');
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<div class="dashboard-card"><p>‚è≥ Generating delegation suggestions with AI...</p></div>';
    
    try {
        const response = await fetch('/api/ai/task-prioritization/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'delegation',
                project_id: projectId || null
            })
        });
        
        const data = await response.json();
        resultContent.innerHTML = renderDelegation(data);
    } catch (error) {
        resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${error.message}</p></div>`;
    }
}

async function generateSubtasks() {
    const projectId = document.getElementById('project-select').value;
    const resultDiv = document.getElementById('task-result');
    const resultContent = document.getElementById('task-result-content');
    
    if (!projectId) {
        alert('Please select a project first');
        return;
    }
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<div class="dashboard-card"><p>‚è≥ Generating subtasks for all tasks in the project with AI...</p></div>';
    
    try {
        const response = await fetch('/api/ai/generate-subtasks/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                project_id: projectId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultContent.innerHTML = `
                <div class="dashboard-card">
                    <h4 style="margin-bottom: 1rem; color: var(--success-color);">‚úÖ Subtasks Generated Successfully!</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">${data.message || 'Subtasks have been generated and saved to the database.'}</p>
                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-top: 1rem;">
                        <strong>Summary:</strong>
                        <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                            <li>Tasks processed: ${Object.keys(data.subtasks_by_task || {}).length}</li>
                            <li>Total subtasks created: ${data.saved_count || 0}</li>
                        </ul>
                    </div>
                    <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                        You can now view subtasks for each task by going to the project detail page and clicking "View Subtasks" on any task card.
                    </p>
                </div>
            `;
        } else {
            resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${data.error || 'Failed to generate subtasks'}</p></div>`;
        }
    } catch (error) {
        resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${error.message}</p></div>`;
    }
}

// Render Q&A response with action results
function renderQAResponse(data) {
    let html = '<div class="dashboard-card">';
    html += '<h4 style="margin-bottom: 1rem;">AI Response</h4>';
    
    // Show answer
    if (data.answer) {
        // Convert markdown-style formatting to HTML
        let answer = data.answer;
        answer = answer.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        answer = answer.replace(/\n/g, '<br>');
        
        html += `<div style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; margin-bottom: 1rem;">${answer}</div>`;
    }
    
    // Show all action results (projects and tasks)
    if (data.action_results && data.action_results.length > 0) {
        data.action_results.forEach(actionResult => {
            if (actionResult.success) {
                if (actionResult.action === 'create_project') {
                    html += `
                    <div style="background: var(--primary-color); color: white; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                        <strong>Project Created: ${actionResult.project_name}</strong>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                            Project ID: ${actionResult.project_id}
                        </div>
                    </div>`;
                } else if (actionResult.action === 'create_task') {
                    html += `
                    <div style="background: var(--success-color); color: white; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                        <strong>Task Created: ${actionResult.task_title}</strong>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                            Task ID: ${actionResult.task_id} | Project: ${actionResult.project_name}
                        </div>
                    </div>`;
                } else if (actionResult.action === 'delete_project') {
                    html += `
                    <div style="background: #ef4444; color: white; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                        <strong>Project Deleted: ${actionResult.project_name}</strong>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                            Project ID: ${actionResult.project_id} (and all its tasks)
                        </div>
                    </div>`;
                } else if (actionResult.action === 'delete_task') {
                    html += `
                    <div style="background: #ef4444; color: white; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                        <strong>Task Deleted: ${actionResult.task_title}</strong>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                            Task ID: ${actionResult.task_id} | Was in project: ${actionResult.project_name}
                        </div>
                    </div>`;
                }
            } else {
                html += `
                <div style="background: var(--error-color); color: white; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                    <strong>Error in ${actionResult.action}:</strong> ${actionResult.error || 'Unknown error'}
                </div>`;
            }
        });
    }
    
    // Backward compatibility: single action result
    if (data.action_result && data.action_result.success && !data.action_results) {
        html += `
        <div style="background: var(--success-color); color: white; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
            <strong>${data.action_result.message}</strong>
            <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                Task ID: ${data.action_result.task_id} | Title: ${data.action_result.task_title}
            </div>
        </div>`;
    }
    
    // Show action error if any
    if (data.action_error) {
        html += `
        <div style="background: var(--error-color); color: white; padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
            <strong>Error:</strong> ${data.action_error}
        </div>`;
    }
    
    // Show action details (for debugging)
    if (data.action && !data.action_result) {
        html += `
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem; font-size: 0.9rem;">
            <strong>üîç Detected Action:</strong> ${data.action.action || 'Unknown'}
            ${data.action.reasoning ? `<br><em>Reasoning: ${data.action.reasoning}</em>` : ''}
        </div>`;
    }
    
    html += '</div>';
    return html;
}

// Tab switching function
function switchTab(tabName) {
    const qaTab = document.getElementById('qa-tab');
    const pilotTab = document.getElementById('pilot-tab');
    const qaSection = document.getElementById('qa-section');
    const pilotSection = document.getElementById('pilot-section');
    
    if (tabName === 'qa') {
        qaTab.classList.add('active');
        pilotTab.classList.remove('active');
        qaSection.style.display = 'block';
        pilotSection.style.display = 'none';
        
        // Update tab styles
        qaTab.style.borderBottom = '3px solid var(--primary-color)';
        qaTab.style.color = 'var(--primary-color)';
        pilotTab.style.borderBottom = '3px solid transparent';
        pilotTab.style.color = 'var(--text-secondary)';
    } else {
        pilotTab.classList.add('active');
        qaTab.classList.remove('active');
        qaSection.style.display = 'none';
        pilotSection.style.display = 'block';
        
        // Update tab styles
        pilotTab.style.borderBottom = '3px solid var(--primary-color)';
        pilotTab.style.color = 'var(--primary-color)';
        qaTab.style.borderBottom = '3px solid transparent';
        qaTab.style.color = 'var(--text-secondary)';
    }
}

async function testQA() {
    const question = document.getElementById('question-input').value;
    const projectId = document.getElementById('qa-project-select').value;
    const resultDiv = document.getElementById('qa-result');
    const resultContent = document.getElementById('qa-result-content');
    
    if (!question.trim()) {
        alert('Please enter a question');
        return;
    }
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<div class="dashboard-card"><p>‚è≥ Processing your request with AI...</p></div>';
    
    try {
        const response = await fetch('/api/ai/knowledge-qa/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                question: question,
                project_id: projectId || null
            })
        });
        
        const data = await response.json();
        if (data.success) {
            resultContent.innerHTML = renderQAResponse(data);
        } else {
            resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${data.error || 'Unknown error'}</p></div>`;
        }
    } catch (error) {
        resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${error.message}</p></div>`;
    }
}

async function testPilot() {
    const question = document.getElementById('pilot-input').value;
    const projectId = document.getElementById('pilot-project-select').value;
    const resultDiv = document.getElementById('pilot-result');
    const resultContent = document.getElementById('pilot-result-content');
    
    if (!question.trim()) {
        alert('Please enter a request');
        return;
    }
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<div class="dashboard-card"><p>‚è≥ Processing your request with AI...</p></div>';
    
    try {
        const response = await fetch('/api/ai/project-pilot/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                question: question,
                project_id: projectId || null
            })
        });
        
        const data = await response.json();
        if (data.success) {
            resultContent.innerHTML = renderQAResponse(data);
            
            // Clear the input if actions were successful
            if (data.action_results && data.action_results.some(r => r.success)) {
                document.getElementById('pilot-input').value = '';
            } else if (data.action_result && data.action_result.success) {
                document.getElementById('pilot-input').value = '';
            }
        } else {
            resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${data.error || 'Unknown error'}</p></div>`;
        }
    } catch (error) {
        resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${error.message}</p></div>`;
    }
}

async function testTimeline(action) {
    const projectId = document.getElementById('timeline-project-select').value;
    const resultDiv = document.getElementById('timeline-result');
    const resultContent = document.getElementById('timeline-result-content');
    
    if (!projectId) {
        alert('Please select a project');
        return;
    }
    
    resultDiv.style.display = 'block';
    resultContent.innerHTML = '<div class="dashboard-card"><p>‚è≥ Processing timeline request...</p></div>';
    
    try {
        const response = await fetch('/api/ai/timeline-gantt/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: action,
                project_id: parseInt(projectId)
            })
        });
        
        const data = await response.json();
        if (data.success) {
            resultContent.innerHTML = renderTimelineResponse(data, action);
        } else {
            resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${data.error || 'Unknown error'}</p></div>`;
        }
    } catch (error) {
        resultContent.innerHTML = `<div class="dashboard-card"><p style="color: var(--error-color);">Error: ${error.message}</p></div>`;
    }
}

function renderTimelineResponse(data, action) {
    let html = '<div class="dashboard-card">';
    
    if (action === 'create_timeline' && data.timeline) {
        const timeline = data.timeline;
        html += `<h4 style="margin-bottom: 1rem;">Project Timeline: ${timeline.project_name}</h4>`;
        
        if (timeline.summary) {
            html += `<div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div><strong>Total Tasks:</strong> ${timeline.summary.total_tasks}</div>
                    <div><strong>Completed:</strong> ${timeline.summary.completed_tasks}</div>
                    <div><strong>In Progress:</strong> ${timeline.summary.in_progress_tasks}</div>
                    <div><strong>To Do:</strong> ${timeline.summary.todo_tasks}</div>
                    <div><strong>Progress:</strong> ${timeline.summary.completion_percentage}%</div>
                </div>
            </div>`;
        }
        
        if (timeline.milestones && timeline.milestones.length > 0) {
            html += `<h5 style="margin: 1.5rem 0 1rem 0;">Milestones</h5>`;
            timeline.milestones.forEach(milestone => {
                html += `<div style="border-left: 4px solid var(--primary-color); padding-left: 1rem; margin-bottom: 1rem;">
                    <strong>${milestone.title}</strong>
                    ${milestone.due_date ? `<br><small>Due: ${formatDate(milestone.due_date)}</small>` : ''}
                </div>`;
            });
        }
        
        if (timeline.tasks && timeline.tasks.length > 0) {
            html += `<h5 style="margin: 1.5rem 0 1rem 0;">Tasks (Chronological Order)</h5>`;
            timeline.tasks.forEach((task, index) => {
                html += `<div style="border: 2px solid var(--border-color); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid ${getPriorityColor(task.priority)};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${index + 1}. ${task.title}</strong>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                Status: ${task.status} | Priority: ${task.priority}
                                ${task.due_date ? ` | Due: ${formatDate(task.due_date)}` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
        }
    } else if (action === 'generate_gantt' && data.gantt_chart) {
        const gantt = data.gantt_chart;
        html += `<h4 style="margin-bottom: 1rem;">Gantt Chart: ${gantt.project_name}</h4>`;
        
        if (gantt.timeline) {
            html += `<p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Timeline: ${formatDate(gantt.timeline.start)} to ${formatDate(gantt.timeline.end)}
            </p>`;
        }
        
        if (gantt.tasks && gantt.tasks.length > 0) {
            gantt.tasks.forEach(task => {
                const progress = task.progress || 0;
                html += `<div style="border: 2px solid var(--border-color); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <strong>${task.title}</strong>
                        <span style="background: ${getPriorityColor(task.priority)}; color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">
                            ${task.priority.toUpperCase()}
                        </span>
                    </div>
                    <div style="margin: 0.5rem 0; font-size: 0.9rem; color: var(--text-secondary);">
                        ${formatDate(task.start_date)} ‚Üí ${formatDate(task.end_date)}
                        ${task.assignee ? ` | Assigned to: ${task.assignee}` : ''}
                    </div>
                    <div style="background: var(--bg-secondary); height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                        <div style="background: var(--primary-color); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 0.25rem; font-size: 0.85rem; color: var(--text-secondary);">Progress: ${progress}%</div>
                </div>`;
            });
        }
    } else if (action === 'track_milestones' && data.milestones) {
        html += `<h4 style="margin-bottom: 1rem;">Milestone Tracking</h4>`;
        
        if (data.summary) {
            html += `<div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div><strong>Total:</strong> ${data.summary.total_milestones}</div>
                    <div><strong>Completed:</strong> ${data.summary.completed_milestones}</div>
                    <div><strong>In Progress:</strong> ${data.summary.in_progress_milestones}</div>
                    <div><strong>Upcoming:</strong> ${data.summary.upcoming_milestones}</div>
                    <div><strong>Overdue:</strong> ${data.summary.overdue_milestones}</div>
                    <div><strong>Completion:</strong> ${data.summary.completion_rate}%</div>
                </div>
            </div>`;
        }
        
        if (data.milestones.length > 0) {
            data.milestones.forEach(milestone => {
                const statusColor = milestone.status === 'completed' ? '#10b981' : 
                                   milestone.status === 'in_progress' ? '#f59e0b' : '#64748b';
                html += `<div style="border-left: 4px solid ${statusColor}; padding-left: 1rem; margin-bottom: 1rem;">
                    <strong>${milestone.title}</strong>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        Status: <span style="color: ${statusColor}; font-weight: 600;">${milestone.status}</span>
                        ${milestone.due_date ? ` | Due: ${formatDate(milestone.due_date)}` : ''}
                        ${milestone.days_until_due !== null ? ` | Days until due: ${milestone.days_until_due}` : ''}
                        ${milestone.is_overdue ? ' <span style="color: var(--error-color); font-weight: 600;">OVERDUE</span>' : ''}
                    </div>
                </div>`;
            });
        }
    } else if (action === 'check_deadlines' && data.alerts) {
        html += `<h4 style="margin-bottom: 1rem;">Upcoming Deadlines & Alerts</h4>`;
        
        if (data.summary) {
            html += `<div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div><strong>Total Alerts:</strong> ${data.summary.total_alerts}</div>
                    <div><strong>Overdue:</strong> ${data.summary.overdue_count}</div>
                    <div><strong>Upcoming:</strong> ${data.summary.upcoming_count}</div>
                    <div><strong>Critical:</strong> ${data.summary.critical_count}</div>
                </div>
            </div>`;
        }
        
        if (data.alerts.length > 0) {
            data.alerts.forEach(alert => {
                const urgencyColor = alert.urgency === 'critical' ? '#ef4444' : 
                                    alert.urgency === 'high' ? '#f59e0b' : 
                                    alert.urgency === 'medium' ? '#3b82f6' : '#64748b';
                html += `<div style="border-left: 4px solid ${urgencyColor}; padding-left: 1rem; margin-bottom: 1rem; background: ${alert.type === 'overdue' ? 'rgba(239, 68, 68, 0.1)' : 'transparent'}; padding: 1rem; border-radius: var(--radius-sm);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${alert.title || alert.project_name || 'Alert'}</strong>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                Type: ${alert.type.replace('_', ' ')} | Urgency: <span style="color: ${urgencyColor}; font-weight: 600;">${alert.urgency}</span>
                                ${alert.days_until !== undefined ? ` | Days until: ${alert.days_until}` : ''}
                                ${alert.days_overdue !== undefined ? ` | Days overdue: ${alert.days_overdue}` : ''}
                                ${alert.assignee ? ` | Assigned to: ${alert.assignee}` : ''}
                            </div>
                        </div>
                        <span style="background: ${urgencyColor}; color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">
                            ${alert.urgency.toUpperCase()}
                        </span>
                    </div>
                </div>`;
            });
        } else {
            html += `<p style="color: var(--text-secondary);">No upcoming deadlines or alerts.</p>`;
        }
    } else if (action === 'suggest_adjustments' && data.suggestions) {
        html += `<h4 style="margin-bottom: 1rem;">Timeline Adjustment Suggestions</h4>`;
        
        if (data.summary) {
            html += `<div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div><strong>Total Suggestions:</strong> ${data.summary.total_suggestions}</div>
                    <div><strong>Deadline Extensions:</strong> ${data.summary.deadline_extensions}</div>
                    <div><strong>Estimate Revisions:</strong> ${data.summary.estimate_revisions}</div>
                    <div><strong>Workload Redistributions:</strong> ${data.summary.workload_redistributions}</div>
                </div>
            </div>`;
        }
        
        if (data.suggestions.length > 0) {
            data.suggestions.forEach(suggestion => {
                html += `<div style="border: 2px solid var(--border-color); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1rem;">
                    <strong>${suggestion.task_title || suggestion.project_name || 'Suggestion'}</strong>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        Type: ${suggestion.type.replace('_', ' ')}<br>
                        ${suggestion.reason || ''}
                        ${suggestion.suggested_extension_days ? `<br>Suggested extension: ${suggestion.suggested_extension_days} days` : ''}
                    </div>
                </div>`;
            });
        } else {
            html += `<p style="color: var(--text-secondary);">No adjustments needed. Timeline looks good.</p>`;
        }
    } else if (action === 'identify_conflicts' && data.conflicts) {
        html += `<h4 style="margin-bottom: 1rem;">Timeline Conflicts & Issues</h4>`;
        
        if (data.summary) {
            html += `<div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div><strong>Total Issues:</strong> ${data.summary.total_conflicts}</div>
                    <div><strong>High Severity:</strong> ${data.summary.high_severity}</div>
                    <div><strong>Timing Conflicts:</strong> ${data.summary.timing_conflicts}</div>
                    <div><strong>Resource Overloads:</strong> ${data.summary.resource_overloads}</div>
                </div>
            </div>`;
        }
        
        if (data.conflicts.length > 0 || data.dependency_issues.length > 0) {
            [...data.conflicts, ...data.dependency_issues].forEach(issue => {
                const severityColor = issue.severity === 'high' ? '#ef4444' : '#f59e0b';
                html += `<div style="border-left: 4px solid ${severityColor}; padding-left: 1rem; margin-bottom: 1rem;">
                    <strong>${issue.task_title || 'Issue'}</strong>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        ${issue.description || issue.reason || ''}
                    </div>
                </div>`;
            });
        } else {
            html += `<p style="color: var(--text-secondary);">No conflicts detected. Timeline is clean.</p>`;
        }
    } else if (action === 'identify_dependencies' && data.dependency_map) {
        html += `<h4 style="margin-bottom: 1rem;">Task Dependencies & Bottleneck Analysis</h4>`;
        
        if (data.summary) {
            html += `<div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div><strong>Tasks with Dependencies:</strong> ${data.summary.total_tasks_with_dependencies}</div>
                    <div><strong>Total Dependencies:</strong> ${data.summary.total_dependencies}</div>
                    <div><strong>Critical Path Tasks:</strong> ${data.summary.critical_path_tasks}</div>
                    <div><strong>Bottleneck Tasks:</strong> ${data.summary.bottleneck_tasks}</div>
                    <div><strong>High Risk:</strong> ${data.summary.high_risk_bottlenecks}</div>
                    <div><strong>Max Depth:</strong> ${data.summary.max_dependency_depth}</div>
                </div>
            </div>`;
        }
        
        // Show critical path
        if (data.critical_path && data.critical_path.length > 0) {
            html += `<h5 style="margin: 1.5rem 0 1rem 0;">Critical Path Tasks</h5>`;
            data.critical_path.forEach(cp => {
                html += `<div style="border-left: 4px solid var(--primary-color); padding-left: 1rem; margin-bottom: 1rem; background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: var(--radius-sm);">
                    <strong>${cp.task_title}</strong>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        ${cp.reason}
                    </div>
                </div>`;
            });
        }
        
        // Show bottlenecks
        if (data.bottlenecks && data.bottlenecks.length > 0) {
            html += `<h5 style="margin: 1.5rem 0 1rem 0;">Bottleneck Tasks</h5>`;
            data.bottlenecks.forEach(bottleneck => {
                const riskColor = bottleneck.risk_level === 'high' ? '#ef4444' : '#f59e0b';
                html += `<div style="border-left: 4px solid ${riskColor}; padding-left: 1rem; margin-bottom: 1rem; background: ${bottleneck.risk_level === 'high' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; padding: 1rem; border-radius: var(--radius-sm);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${bottleneck.task_title}</strong>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                Status: ${bottleneck.status} | Priority: ${bottleneck.priority}<br>
                                ${bottleneck.reason}
                            </div>
                        </div>
                        <span style="background: ${riskColor}; color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">
                            ${bottleneck.risk_level.toUpperCase()}
                        </span>
                    </div>
                </div>`;
            });
        }
        
        // Show bottleneck risks
        if (data.bottleneck_risks && data.bottleneck_risks.length > 0) {
            html += `<h5 style="margin: 1.5rem 0 1rem 0;">üö® Potential Bottleneck Risks</h5>`;
            data.bottleneck_risks.forEach(risk => {
                const riskColor = risk.risk_level === 'high' ? '#ef4444' : '#f59e0b';
                html += `<div style="border-left: 4px solid ${riskColor}; padding-left: 1rem; margin-bottom: 1rem;">
                    <strong>${risk.task_title}</strong>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        Status: ${risk.status} | Blocking ${risk.blocking_count} tasks<br>
                        <strong>${risk.recommendation}</strong>
                    </div>
                </div>`;
            });
        }
        
        // Show dependency relationships
        if (data.dependency_map && data.dependency_map.length > 0) {
            html += `<h5 style="margin: 1.5rem 0 1rem 0;">Dependency Relationships</h5>`;
            data.dependency_map.slice(0, 10).forEach(dep => {  // Limit to 10 for display
                html += `<div style="border: 2px solid var(--border-color); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1rem; ${dep.is_critical ? 'border-left: 4px solid var(--primary-color);' : ''} ${dep.is_bottleneck ? 'background: rgba(245, 158, 11, 0.05);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <strong>${dep.task_title}</strong>
                        <div style="display: flex; gap: 0.5rem;">
                            ${dep.is_critical ? '<span style="background: var(--primary-color); color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">CRITICAL</span>' : ''}
                            ${dep.is_bottleneck ? '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">BOTTLENECK</span>' : ''}
                        </div>
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        ${dep.depends_on.length > 0 ? `<div style="margin-top: 0.5rem;"><strong>Depends on:</strong> ${dep.depends_on.map(d => d.title).join(', ')}</div>` : ''}
                        ${dep.dependent_tasks.length > 0 ? `<div style="margin-top: 0.5rem;"><strong>Blocks:</strong> ${dep.dependent_tasks.map(d => d.title).join(', ')}</div>` : ''}
                    </div>
                </div>`;
            });
            if (data.dependency_map.length > 10) {
                html += `<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">... and ${data.dependency_map.length - 10} more tasks with dependencies</p>`;
            }
        }
    } else if (action === 'get_shared_view' && data.shared_view) {
        const view = data.shared_view;
        html += `<h4 style="margin-bottom: 1rem;">Shared Project View: ${view.project.name}</h4>`;
        
        // Project overview
        html += `<div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
            <h5 style="margin-bottom: 1rem;">Project Overview</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div><strong>Status:</strong> ${view.project.status}</div>
                <div><strong>Priority:</strong> ${view.project.priority}</div>
                <div><strong>Owner:</strong> ${view.project.owner}</div>
                ${view.project.start_date ? `<div><strong>Start:</strong> ${formatDate(view.project.start_date)}</div>` : ''}
                ${view.project.end_date ? `<div><strong>End:</strong> ${formatDate(view.project.end_date)}</div>` : ''}
            </div>
            ${view.project.description ? `<p style="margin-top: 1rem; color: var(--text-secondary);">${view.project.description}</p>` : ''}
        </div>`;
        
        // Progress metrics
        html += `<div style="background: linear-gradient(135deg, var(--primary-color), #3b82f6); color: white; padding: 1.5rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
            <h5 style="margin-bottom: 1rem; color: white;">Progress Metrics</h5>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div><strong>Total Tasks:</strong> ${view.tasks.total}</div>
                <div><strong>Completed:</strong> ${view.tasks.completed}</div>
                <div><strong>In Progress:</strong> ${view.tasks.in_progress}</div>
                <div><strong>To Do:</strong> ${view.tasks.todo}</div>
                <div><strong>Blocked:</strong> ${view.tasks.blocked}</div>
                <div><strong>Completion:</strong> ${view.tasks.completion_percentage}%</div>
            </div>
            <div style="background: rgba(255, 255, 255, 0.2); height: 12px; border-radius: 6px; margin-top: 1rem; overflow: hidden;">
                <div style="background: white; height: 100%; width: ${view.tasks.completion_percentage}%; transition: width 0.3s;"></div>
            </div>
        </div>`;
        
        // Team workload
        if (view.team.members && view.team.members.length > 0) {
            html += `<h5 style="margin: 1.5rem 0 1rem 0;">Team Workload</h5>`;
            view.team.members.forEach(member => {
                html += `<div style="border: 2px solid var(--border-color); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div>
                            <strong>${member.username}</strong> <span style="color: var(--text-secondary); font-size: 0.9rem;">(${member.role})</span>
                        </div>
                        <div style="text-align: right; font-size: 0.9rem;">
                            <div>Total: ${member.total_tasks}</div>
                            <div>Active: ${member.active_tasks}</div>
                            <div>Completed: ${member.completed_tasks}</div>
                        </div>
                    </div>
                    ${member.tasks && member.tasks.length > 0 ? `
                        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                            <strong style="font-size: 0.9rem;">Active Tasks:</strong>
                            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${member.tasks.map(t => `<span style="background: var(--bg-secondary); padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); font-size: 0.85rem;">${t.title} (${t.status})</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>`;
            });
        }
        
        // Tasks by status
        html += `<h5 style="margin: 1.5rem 0 1rem 0;">Tasks by Status</h5>`;
        const statusLabels = {'todo': 'To Do', 'in_progress': 'In Progress', 'review': 'Review', 'done': 'Done', 'blocked': 'Blocked'};
        for (const [status, label] of Object.entries(statusLabels)) {
            const tasks = view.tasks.by_status[status];
            if (tasks && tasks.length > 0) {
                html += `<div style="margin-bottom: 1.5rem;">
                    <h6 style="margin-bottom: 0.75rem; color: var(--text-secondary);">${label} (${tasks.length})</h6>`;
                tasks.slice(0, 5).forEach(task => {
                    html += `<div style="border-left: 4px solid ${getPriorityColor(task.priority)}; padding-left: 1rem; margin-bottom: 0.75rem;">
                        <strong>${task.title}</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Priority: ${task.priority} | ${task.assignee ? `Assigned to: ${task.assignee}` : 'Unassigned'}
                            ${task.due_date ? ` | Due: ${formatDate(task.due_date)}` : ''}
                        </div>
                    </div>`;
                });
                if (tasks.length > 5) {
                    html += `<p style="color: var(--text-secondary); font-size: 0.9rem;">... and ${tasks.length - 5} more ${label.toLowerCase()} tasks</p>`;
                }
                html += `</div>`;
            }
        }
        
        // Upcoming deadlines
        if (view.metrics.upcoming_deadlines && view.metrics.upcoming_deadlines.length > 0) {
            html += `<h5 style="margin: 1.5rem 0 1rem 0;">Upcoming Deadlines (Next 7 Days)</h5>`;
            view.metrics.upcoming_deadlines.forEach(deadline => {
                html += `<div style="border-left: 4px solid #f59e0b; padding-left: 1rem; margin-bottom: 0.75rem;">
                    <strong>${deadline.title}</strong>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        Due: ${formatDate(deadline.due_date)} | Priority: ${deadline.priority} | ${deadline.assignee ? `Assigned to: ${deadline.assignee}` : 'Unassigned'}
                    </div>
                </div>`;
            });
        }
        
        // Priority distribution
        if (view.metrics.priority_distribution) {
            html += `<div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); margin-top: 1.5rem;">
                <h6 style="margin-bottom: 0.75rem;">Priority Distribution</h6>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div><strong>High:</strong> ${view.metrics.priority_distribution.high}</div>
                    <div><strong>Medium:</strong> ${view.metrics.priority_distribution.medium}</div>
                    <div><strong>Low:</strong> ${view.metrics.priority_distribution.low}</div>
                </div>
            </div>`;
        }
        
        if (view.metrics.overdue_tasks > 0) {
            html += `<div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: var(--radius-sm); padding: 1rem; margin-top: 1.5rem;">
                <strong style="color: #ef4444;">${view.metrics.overdue_tasks} Overdue Task(s)</strong>
            </div>`;
        }
    } else if (action === 'calculate_duration' && data.estimates) {
        const est = data.estimates;
        html += `<h4 style="margin-bottom: 1rem;">Project Duration Estimates</h4>`;
        
        html += `<div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-sm); margin-bottom: 1.5rem;">
            <div style="margin-bottom: 1rem;">
                <strong>Total Tasks:</strong> ${est.total_tasks}<br>
                <strong>Total Estimated Hours:</strong> ${est.total_estimated_hours} hours
            </div>
            <div style="margin-top: 1rem;">
                <h5 style="margin-bottom: 0.5rem;">Working Days:</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
                    <div>Optimistic: <strong>${est.working_days.optimistic}</strong> days</div>
                    <div>Realistic: <strong>${est.working_days.realistic}</strong> days</div>
                    <div>Pessimistic: <strong>${est.working_days.pessimistic}</strong> days</div>
                    <div>Expected: <strong>${est.working_days.expected}</strong> days</div>
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <strong>Expected Calendar Duration:</strong> ${est.calendar_days.expected} days (${est.calendar_days.weeks} weeks)
            </div>
        </div>`;
        
        if (data.recommendations) {
            html += `<div style="border: 2px solid var(--primary-color); border-radius: var(--radius-sm); padding: 1rem; background: rgba(59, 130, 246, 0.1);">
                <strong>Recommendation:</strong><br>
                Suggested deadline: ${data.recommendations.suggested_deadline_days} working days (${data.recommendations.suggested_deadline_weeks} weeks)<br>
                <small style="color: var(--text-secondary);">${data.recommendations.note}</small>
            </div>`;
        }
    } else {
        html += `<p>Response received. Check console for details.</p>`;
        html += `<pre style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-sm); overflow-x: auto; font-size: 0.85rem;">${JSON.stringify(data, null, 2)}</pre>`;
    }
    
    html += '</div>';
    return html;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

